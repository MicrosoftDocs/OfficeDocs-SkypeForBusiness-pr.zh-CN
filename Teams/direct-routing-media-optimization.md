---
title: 直接路由本地媒体优化
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: 用于直接路由的本地媒体优化
appliesto:
- Microsoft Teams
ms.openlocfilehash: 060b6f0fdf92969894cad98178073a4288eb2325
ms.sourcegitcommit: 25e70de7c943e22fe6ac6e8d6b4353ca68f81f83
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/06/2020
ms.locfileid: "43157958"
---
# <a name="local-media-optimization-for-direct-routing"></a>用于直接路由的本地媒体优化

公共交换式电话网络（PSTN）语音被视为具有对语音质量的高期望值的业务关键型应用程序。 直接路由允许你控制媒体流量流，以适应全球各地的各种企业的多种网络拓扑和本地电话设置。 

直接路由的本地媒体优化允许你通过以下方式管理语音质量：

-   控制团队客户端和客户会话边界控制器（SBCs）之间媒体通信流的方式。
-   在企业网络子网的边界内保持媒体的本地。
-   允许团队客户端和 SBCs 之间的媒体流，即使 SBCs 位于具有专用 Ip 的企业防火墙之后，也不会直接显示到 Microsoft。

本地媒体优化支持两种方案：

- 通过将集中的 SBC 连接到主会话启动协议（SIP）主干来集中所有本地中继，并将电话服务提供给公司的所有本地分支机构。

-   构建虚拟网络拓扑（SBCs），其中，本地分支机构中的 SBCs 连接到与 Microsoft Phone 系统通过其外部 IP 地址可见并进行通信的集中式代理 SBC。 在虚拟网络拓扑中，下游 SBCs 通过内部 Ip 进行通信，并且不能直接显示在手机系统中。

本文介绍功能功能以及客户方案和解决方案。 有关配置的详细信息，请参阅[配置本地媒体优化](direct-routing-media-optimization-configure.md)。 

  > [!NOTE]
  > 如果想要在 intranet 边界内保留媒体本地，建议使用本地媒体优化。 如果你已有媒体旁路，并且仅使用 SBCs 的公共 IP 地址，则不需要移动到本地媒体优化。 您可以继续使用 "媒体绕过"。 有关详细信息，请参阅[规划媒体绕过](direct-routing-plan-media-bypass.md)。


## <a name="supported-customer-scenarios"></a>支持的客户方案

对于本次讨论，假设 Contoso 在全球范围内运行多个企业，如下所示。 （请注意，欧洲和 APAC 区域仅用作示例。 公司可能有多个具有类似要求的不同区域。）
 
- **在欧洲**，Contoso 拥有大约30个国家/地区的办事处。 每个 office 都有其自己的专用分支交换（PBX）。 

  Contoso 已提供一个选项，可用于将中继集中在一个位置--对于所有30个欧洲办事处，都是阿姆斯特丹。 Contoso 在阿姆斯特丹中部署了 SBC，提供了足够的带宽以通过中央位置运行呼叫，将中心 SIP 主干连接到集中的位置，并开始从阿姆斯特丹开始为所有欧洲地区提供服务。 

- **在 APAC 地区**，Contoso 在不同的国家/地区有多个办事处。 

  在许多国家，公司在本地分支机构中仍然有时间分段多路复用（TDM）中继。 TDM 中继的集中化不是 APAC 地区的一个选项，因此无法切换到 SIP。 50假设在 APAC 地区有数百个具有数百个网关（SBCs）的 Contoso 分支机构。 在这种情况下，不能将所有网关与直接路由接口配对，因为缺少公共 IP 地址和/或本地 internet breakouts。 此外，某些国家/地区强加了无法在没有本地 PSTN 网络连接的情况下满足的法规要求。

根据业务需求，Contoso 实施了两个解决方案，其中包含用于直接路由的本地媒体优化：

- **在欧洲**，所有中继都是集中式的，并且在中心 SBC 和用户之间基于用户位置进行媒体流。 

  - 如果用户连接到企业网络的本地子网（即，用户是内部的用户），则媒体在中央 SBC 和用户的团队客户端的内部 IP 之间流动。 
  
  - 如果用户在企业网络边界之外（例如，如果用户使用公共无线互联网连接），则认为该用户是外部用户。 在这种情况下，媒体将在中央 SBC 和团队客户端的外部 IP 之间流动。

- **在 APAC 区域中**，集中的代理 SBC 与 Microsoft Direct 路由进行了配对，后者定向直接路由接口和本地分支机构中的下游 SBCs 之间的媒体。 

  本地分支办公室中的下游 SBCs 在 APAC 中不直接以直接路由的方式显示，但它们通过使用 CSOnlinePSTNGateway cmdlet 在 Microsoft Phone 系统中创建虚拟网络拓扑进行配对。 如果可能，媒体始终保持本地。 外部用户在团队客户端与代理 SBC 的公共 IP 之间有媒体流动。


## <a name="central-sbc-with-centralized-trunks"></a>具有集中中继的中心 SBC

若要构建一个解决方案，其中 PSTN 服务通过单个中心 SBC 和连接的集中 SIP 主干提供给所有本地分支机构，Contoso 租户管理员对服务有一个 SBC （centralsbc.contoso.com）;SBC 有一个与之连接的集中 SIP 中继。 

- 当用户在公司内部网络中时，SBC 为媒体提供 SBC 的内部 IP。

- 当用户在公司网络外部时，SBC 提供 SBC 的外部（公共） IP。

注意：仅显示示例、表或图表中的所有值以供演示之用。

表 1. SBCs 的网络参数示例 

| 位置 | SBC FQDN | 内部子网 | 外部 NAT （受信任的 IP） | SBC 外部 IP 地址 | SBC 内部 IP 地址 |
|:------------|:-------|:-------|:-------|:-------|:-------|
| 阿姆斯特丹 | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| 德国 | 未部署 | 192.168.6.0/24 | 172.16.76.74 | 未部署 |  未部署 |
| 法国 | 未部署 | 192.168.7.0/24 | 172.16.76.75 | 未部署 |  未部署 ||||


### <a name="internal-user"></a>内部用户

下图显示了当用户连接到用户的家庭分支机构或网站中的企业网络时的通信流。 

在本地时，用户分配给德国的本地分支机构。 用户通过团队进行直接路由通话。

- 用户的团队客户端通过 REST API 直接与电话系统通信，但在呼叫过程中生成的媒体将流入中央 SBC 的内部 IP 地址。 

- SBC 将流量重定向到电话系统和连接的 PSTN 网络。 

- 中心 SBC 仅通过外部 IP 地址向电话系统显示。 

图1。 当用户使用集中的 SBC 和连接的集中式 SIP 主干时，在 "家庭" 网站中的通信流

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-1.png "当用户在 "home" 站点中时，如果使用集中的 SBC 和连接的集中 SIP 主干，则通信流")


### <a name="external-user"></a>外部用户

下图显示了用户不在本地且未连接到企业网络（即用户的设备通过移动设备或公共 Wi-fi 连接到 Internet）时的通信流。 用户通过团队进行直接路由通话：

- 用户的团队客户端通过 REST API 直接与电话系统通信，但在这种情况下，在呼叫过程中生成的媒体将流入中央 SBC 的外部 IP 地址。 

- SBC 将流量重定向到电话系统和连接的 PSTN 网络。 

- 中心 SBC 仅通过外部 IP 地址向电话系统显示。 

在这种情况下，该行为类似于用户是否属于德国的分支机构或任何其他分支机构。 用户被视为外部用户，因为用户在企业网络的边界之外。

图2。 当用户使用集中的 SBC 和连接的集中式 SIP 主干时的通信流

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-2.png "当用户在使用连接的集中式 SIP 中继的集中 SBC 情况下使用外部用户时的通信流")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>具有连接的下游 SBCs 的代理 SBC

若要构建一个解决方案，其中 PSTN 服务在 APAC 区域中的所有本地分支机构中均提供，其中，TDM 中继的集中不是一个选项，Contoso 管理员对直接路由服务有一个 SBC （proxysbc.contoso.com），也称为代理 SBC。 

之后，Contoso 管理员添加了一些下游的 SBCs，指示可以通过代理 SBC proxysbc.contoso.com 访问它们。 下游 SBCs 不具有公共 Ip，但可以将它们分配给语音路由。 下表显示了示例网络参数和配置。

当用户位于下游 SBC 所在的本地分支机构中时，媒体流量将直接在用户和本地下游 SBC 之间流动。 如果用户在 office 外部（在公共 internet 上），媒体将从用户流向代理 SBC 的公共 IP，并将其代理到相关的下游 SBC。

表 2. SBC 网络信息示例

| 位置 | SBC FQDN | 内部子网 | 外部 NAT （受信任的 IP） | SBC 外部 IP 地址  | SBC 内部 IP 地址 |
|:------------|:-------|:-------|:-------|:-------|:-------|
| 越南 | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | 无 |  192.168.1.5 |
| 印度尼西亚  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | 无 |  192.168.2.5 |
| 新加坡 | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>内部用户 

下图显示了当用户位于 APAC 区域中的 office 内部时，该方案的高级流量流。 分配给越南的本地分支机构且在本地的用户通过团队直接路由电话呼叫。 

- 用户的团队客户端通过 REST API 直接与电话系统通信，但在呼叫过程中生成的媒体将流入本地 SBC 的内部 IP 地址。

- 本地 SBC 将流重定向到新加坡中的代理 SBC 和连接的本地 PSTN 网络。

-  代理 SBC 仅通过外部 IP 地址对电话系统可见，并将下游 SBC （本例中为越南的本地 SBC）的流路由到电话系统。 

- 本地分支机构中的下游 SBC 不会直接显示在手机系统中，而是在由 Contoso 管理员在设置本地媒体优化时定义的虚拟网络拓扑中进行映射。

注意：根据配置的本地媒体优化模式，对本地用户和非本地用户的行为可能有所不同。 

有关可能的模式和相关行为的详细信息，请参阅配置本地媒体优化。

图3。 当用户使用代理 SBC 和连接的下游 SBCs 的 "家庭" 网络时的通信流 

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-3.png "当用户在 "家庭" 网络中时，代理 SBC 使用连接的下游 SBCs 的流量流")

### <a name="external-user"></a>外部用户

下图显示了当用户超出公司网络边界时的通信流。 用户不在本地（不在企业网络的边界内）。 用户通过团队将直接路由电话拨入到越南的电话号码。 

- 用户的团队客户端通过 REST API 直接与电话系统通信，但在呼叫过程中生成的媒体首先排在新加坡的代理 SBC 的外部 IP 地址。 

- 根据配置和语音策略（有关详细信息，请参阅[配置本地媒体优化](direct-routing-media-optimization-configure.md)），代理 SBC 将流重定向到越南的下游 SBC。 

- 越南中的下游 SBC 将流重定向到连接的本地 PSTN 网络。 

- 代理 SBC 仅通过外部 IP 地址对电话系统可见。

-  本地分支机构中的下游 SBC 不会直接显示在手机系统中，而是在由 Contoso 管理员在设置本地媒体优化时定义的虚拟网络拓扑中进行映射。 在此示例中，用户被视为外部用户，因为用户在企业网络的边界之外。 

图4。 当用户使用代理 SBC 和连接的下游 SBCs 时的通信流

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-4.png "当用户是外部用户时，代理 SBC 使用连接的下游 SBCs 的流量流")

## <a name="local-media-optimization-modes"></a>本地媒体优化模式

本地媒体优化支持两种模式：

- **模式1：始终绕过**。 在这种情况下，如果用户是内部用户，则媒体将流经本地下游 SBC 的内部 IP 地址，无论内部用户的实际位置如何;例如，在与下游 SBC 位于同一个分支机构的同一分支机构内或在其他分支机构中。

- **Mode 2：仅适用于本地用户**。 在此模式下，仅当内部用户与下游 SBC 位于同一分支机构中时，媒体才会直接流向本地下游 SBC 内部 IP 地址。 

为了区分本地媒体优化模式，租户管理员需要使用 CSonlinePSTNGateway cmdlet 将-BypassMode 参数设置为每个 SBC 的 "Always" 或 "OnlyForLocalUsers"。 有关详细信息，请参阅[配置本地媒体优化](direct-routing-media-optimization-configure.md)。  

### <a name="mode-1-always-bypass"></a>模式1：始终绕过

如果你在分支机构之间有良好的连接，则建议的模式始终为绕过。

例如，假设公司在阿姆斯特丹中有一个集中 SIP 主干，其中包含30个国家/地区，并且所有30个站点和本地用户之间有良好的连接。 在德国还有一个分支，本地 SBC 已部署。

德国的 SBC 可以在 "始终绕过" 模式下进行配置。 无论用户的位置如何，用户都将直接通过 SBC 的内部 IP 地址（例如从华北到德国）连接到 SBC; 请参阅下图中的参考。

下面介绍两种方案：

- 方案1。 用户与联机语音路由策略中定义的 SBC 位于同一位置。

- 方案2。 用户和网关位于不同的站点。

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>方案1。 用户与联机语音路由策略中定义的 SBC 位于同一位置

将阿姆斯特丹中的 SBC 配置为德国本地下游 SBC 的代理 SBC。 用户与本地 SBC 的企业网络在同一子网中的德国位于德国。 SBCs （代理和下游）都配置为始终绕过模式。 联机语音路由策略指定，在德国通话（带有区号 + 49）的情况下，应将它们路由到德国的本地 SBC。 所有其他通话--在德国的 SBC 出现故障时，应以阿姆斯特丹的形式将其路由到代理 SBC。 下表总结了示例配置。 

表3。 方案1的示例配置

| 用户物理位置 | 用户拨打号码 | 联机语音路由策略 | 针对 SBC 配置的模式 | 媒体流 | 
|:------------|:-------|:-------|:-------|:-------|
| 德国 | + 49 1 437 2800 | 优先级1： ^\+49 （\d{8}） $-DEsbc.contoso.com<br>优先级2：. *-proxysbc.contoso.com| DEsbc.contoso.com-始终绕过 <br>proxysbc.contoso.com-始终绕过 | 团队用户 <-> DEsbc.contoso.com |

下图显示了德国内部用户的高级通信流，使您可以通过团队将电话呼叫直接路由到德国的号码。 

- 用户的团队客户端通过 REST API 直接与电话系统通信。 

- 在呼叫过程中生成的媒体将流入本地 SBC 的内部 IP 地址。 

- 本地 SBC 将该流重定向到阿姆斯特丹中的代理 SBC 和连接的本地 PSTN 网络。 

- 代理 SBC 仅通过外部 IP 地址对电话系统可见，并将下游 SBC （在本例中为德国的本地 SBC）的流路由到电话系统。 

- 本地分支机构中的下游 SBC 不会直接显示在手机系统中，而是在由 Contoso 管理员在设置本地媒体优化时定义的虚拟网络拓扑中进行映射。


图5。  具有 "始终绕过" 模式且用户位于 "主页" 网站中的流量流

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-5.png "具有 "始终绕过" 模式且用户位于 "开始" 网站中的流量流")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>方案2：用户和网关位于不同的站点

将阿姆斯特丹中的 SBC 配置为德国本地下游 SBC 的代理 SBC。 SBCs （代理和下游）都配置为始终绕过模式。 法国的内部用户（位于本地分支机构）正在与德国进行直接路由呼叫。 联机语音路由策略指定对德国的通话（带有区号 + 49）应路由到德国的本地 SBC。 所有其他通话--在德国的 SBC 出现故障的情况下，所有通话都应以阿姆斯特丹的形式路由到代理 SBC。 下表总结了示例配置。 

表4。 方案2的示例配置

| 用户物理位置 | 用户拨打号码 | 联机语音路由策略 | 针对 SBC 配置的模式 | 媒体流 | 
|:------------|:-------|:-------|:-------|:-------|
| 法国 | + 49 1 437 2800 | 优先级1： ^\+49 （\d{8}） $-DEsbc.contoso.com <br>优先级2：. *-proxysbc.contoso.com |  DEsbc.contoso.com-始终绕过 proxysbc.contoso.com-始终绕过 | 团队用户 <-> DEsbc.contoso.com  |

下图显示了当位于法国的内部德语用户通过团队向德国的电话号码进行直接路由呼叫时的高级别流量流。 

- 用户的团队客户端通过 REST API 直接与电话系统通信。

- 在呼叫过程中生成的媒体将直接流过德国内部 IP 地址中的 SBC。 

- 德国的 SBC 将该流重定向到阿姆斯特丹和连接的本地 PSTN 网络的代理 SBC。 

图6。  具有 "始终绕过" 模式且用户不在 "家庭" 网站中，但在内部网络中的流量流

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-6.png "具有 "始终绕过" 模式的流量流，并且用户不在 "主页" 网站中，而是在内部网络中")

### <a name="mode-2-only-for-local-users"></a>Mode 2：仅适用于本地用户

如果本地分支机构之间存在不正确的连接，但每个本地分支机构和区域 office 之间连接良好，则推荐模式为 "仅适用于本地用户"。

例如，在 APAC 区域中，假设 Contoso 拥有不同国家/地区的多个办事处。 对于许多国家/地区，由于公司在许多本地分支机构中仍然有 TDM 中继，因此无法切换到 SIP。 TDM 中继的集中化不是 APAC 地区的一个选项。 此外，有数百个网关（SBCs）的 APAC 区域内有超过50个 Contoso 分支机构。 

若要构建一个解决方案，其中 PSTN 服务在 APAC 区域中的所有本地分支机构中均提供，而你的 TDM 中继的集中不是一个选项，则 Contoso 管理员将一个新加坡的区域 SBC 作为代理 SBC 提供给直接路由服务。 本地分支办公室之间的直接连接不好，但每个本地分支机构和新加坡的区域 SBC 之间存在良好的连接。 对于地区性 SBC，管理员选择 "始终绕过" 模式，对于本地下游 SBCs，管理员选择 "仅用于本地用户" 模式。

下面介绍两种方案：

- 方案1。 用户与联机语音路由策略中定义的 SBC 位于同一位置

- 方案2。 用户和网关位于不同的站点

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>方案1。 用户与联机语音路由策略中定义的 SBC 位于同一位置

假定已将新加坡中的 SBC 配置为适用于越南和印度尼西亚本地下游 SBCs 的代理 SBC。 用户在与本地 SBC 位于同一位置的越南中。 联机语音路由策略指定越南（带区号 + 84）的呼叫应路由到越南的本地 SBC。 所有其他呼叫-如果越南中的 SBC 失败，则在越南的调用中应路由到新加坡的代理 SBC。 下表总结了示例配置。 

表5。 "仅适用于本地用户" 模式方案1的示例配置

| 用户物理位置 | 用户拨打号码 | 联机语音路由策略 | 针对 SBC 配置的模式 | 媒体流 | 
|:------------|:-------|:-------|:-------|:-------|
| 越南 | + 84 4 3926 3000 | 优先级1： ^\+84 （\d{9}） $-VNsbc.contoso.com <br>优先级2：. *-proxysbc.contoso.com | VNsbc.contoso.com-仅适用于本地用户 <br> proxysbc.contoso.com-始终绕过 | 团队用户 <-> VNsbc.contoso.com |

在下图中，分配给越南中的本地分支机构的用户，而在本地，则通过团队直接路由电话呼叫。 

- 用户的团队客户端通过 REST API 直接与电话系统通信。 

- 在呼叫过程中生成的媒体将流入本地 SBC 的内部 IP 地址。 

- 本地 SBC 将流重定向到新加坡中的代理 SBC 和连接的本地 PSTN 网络。 

- 代理 SBC 仅通过外部 IP 地址对电话系统可见，并将下游 SBC （在本例中为越南中的本地 SBC）的流路由到手机系统。 

- 本地分支机构中的下游 SBC 直接不会直接向电话系统显示，但会在虚拟网络拓扑中进行映射。

图表7。 带有 "仅适用于本地用户" 模式的流量和用户位于 "家庭" 网站中的流量

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-7.png "带有 "仅适用于本地用户" 模式的流量和用户处于 "家庭" 网站中的流量")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>方案2。 用户和网关位于不同的站点

假定已将新加坡中的 SBC 配置为适用于越南和印度尼西亚本地下游 SBCs 的代理 SBC。 在印度尼西亚的内部用户（位于本地分支机构中）是向越南进行直接路由呼叫。 联机语音路由策略指定对越南（带区号 + 84）的呼叫应路由到越南的本地 SBC。 所有其他呼叫（如果越南中的 SBC 失败），应将对越南的调用路由到新加坡的代理 SBC。 新加坡中的代理 SBC 设置为 "Always Byass" 模式，并且越南中的本地 SBC 为 "仅适用于本地用户" 模式。 下表总结了示例配置。 

表6。 用户配置

| 用户物理位置 | 用户拨打号码 | 联机语音路由策略 | 针对 SBC 配置的模式 | 媒体流 | 
|:------------|:-------|:-------|:-------|:-------|
| 印度尼西亚 | + 84 4 3926 3000 | 优先级1： ^\+84 （\d{9}） $-VNsbc.contoso.com <br> 优先级2：. *-proxysbc.contoso.com |VNsbc.contoso.com-仅适用于本地用户 <br> proxysbc.contoso.com-始终绕过 | 团队用户 < – > proxysbc.contoso.com < – > VNsbc.contoso.com |


在下图中，内部用户在印度尼西亚语分支机构内部部署中，通过团队将电话直接路由到越南号码。 

- 用户的团队客户端通过 REST API 直接与电话系统通信。

- 在呼叫过程中生成的媒体首先流向代理 SBC 的内部 IP 地址。 

- 在新加坡中，代理 SBC 将流重定向到越南和手机系统的下游 SBC 的内部 IP 地址。 

- 越南中的下游 SBC 将流路由到连接的本地 PSTN 网络。 

- 代理 SBC 仅通过外部 IP 地址对电话系统可见。

- 本地分支办公室中的下游 SBCs 直接不会直接向电话系统显示，但会在虚拟网络拓扑中进行映射。

图8。  带有 "仅用于本地用户" 模式的流量流，并且用户不在 "家庭" 网站中，而在内部网络中

![显示通信流本地媒体优化的图表](media/direct-routing-media-op-8.png "带有 "仅针对本地用户" 模式的流量流，用户不在 "主页" 网站中，而是在内部网络中")


