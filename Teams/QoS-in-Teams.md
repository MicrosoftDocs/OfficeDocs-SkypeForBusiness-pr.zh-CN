---
title: 在 Microsoft 团队中实现服务的质量
author: rmw2890
ms.author: MyAdvisor
manager: Serdars
ms.date: 12/17/2018
ms.topic: article
ms.service: msteams
ms.reviewer: rowille
description: 针对 Microsoft Teams 的服务质量 (QoS) 准备贵组织的网络。
localization_priority: Normal
search.appverid: MET150
MS.collection: Teams_ITAdmin_PracticalGuidance
appliesto:
- Microsoft Teams
ms.openlocfilehash: b519327b37c61a126c5101080f0c1eee9f8582f5
ms.sourcegitcommit: 788e3526ff973454f3904c33d867691a2fae814f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/16/2019
ms.locfileid: "28326729"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>在 Microsoft 团队中实现服务质量 (QoS)

本文将帮助您的服务质量 (QoS) 中的 Microsoft 团队准备贵组织的网络。

您可以使用 QoS 设置优先级通过不太敏感的流量对网络延迟敏感的网络流量。 简单葡萄形状是 QoS 创建虚拟数据中的"乘泳道"从不网络因此某些类型的数据或很少遇到延迟。
设置优先级的实时通信，如呼叫或团队可以共享的会议流量时详细可靠地提供业务级的用户体验。 如果没有 QoS 某种形式，您可能会看到以下语音和视频质量问题：

- 抖动 – 到达不同的比率的媒体数据包。
- 数据包丢失 – 数据包而丢弃，这可能会导致缺少单词或音节。
- 延迟的往返时间 (RTT) – 需要很长的时间到达其目标媒体数据包。

对于要真正有效的 QoS，一致 QoS 设置需要应用端到端中您的组织 （用户 Pc、 网络交换机和路由器到云），因为无法支持 QoS 优先级路径的任何部分会降低呼叫质量视频和屏幕共享。

QoS 是可用来确定优先级某些类型的网络流量通过不太敏感其他流量对网络延迟敏感的机制。 简单葡萄形状是 QoS 创建虚拟网络，因此某些类型的数据从不数据中的"乘泳道"，或很少遇到延迟。

设置优先级的实时通信，如呼叫或团队可以共享的会议流量时详细可靠地提供业务级的用户体验。 当不实现 QoS 时，在会议中的共享的屏幕可以冻结、 视频可以 pixellate 和颜色 shift 和语音呼叫会变得断断续续和难或无法了解。 对于要真正有效的 QoS，一致 QoS 设置需要应用端到端中您的组织 （用户 Pc、 网络交换机和路由器到云），因为无法支持 QoS 优先级路径的任何部分会降低呼叫质量视频和屏幕共享。

![组织的网络和 Office 365 服务之间的关系： 本地网络和设备将与反过来连接和 Office 365 云语音和音频会议服务互连网络连接。](media/Qos-in-Teams-Image1.png) 

一个选项可用于解决端到端 QoS 是[Azure ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/)。 我们仍建议您实现您的本地网络上的 QoS。 这将提高整个部署的实时通信工作负载的质量，并解决阻塞点。 

在大多数情况下，该网络连接到云企业将非托管的网络 internet 连接，您将无法可靠地设置 QoS。 一个选项可允许真正的端到端 QoS 是[Azure ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/)。 我们仍建议您实现 QoS 上的端到端网络的部分中，您可以控制，即您的本地网络。 这将提高整个部署的实时通信工作负载的质量，并解决阻塞现有部署中的点。

## <a name="prioritize-teams-network-traffic-for-qos"></a>设置团队网络流量优先级的 QoS 

本文重点介绍如何设置优先级团队实时通信流量 — 即，语音和视频。 您还可以设置优先级其他类型的通信，根据您的需求。

有几种方法来确定优先级流量，但最常见使用区分的服务代码点 (DSCP) 标记。 它们可以应用 （"已标记"） 基于端口范围或通过组策略对象。 我们将介绍均位于这篇文章。 我们建议您使用标记基于端口范围，因为它适用于所有设备，而不仅仅是加入到域。

控制通过组策略对象 DSCP 标记确保加入域的计算机接收设置正确，并且只有管理员可以管理其。

务必了解 QoS 在连接到另一个呼叫者的所有链接上实现时才有效。 如果您使用内部网络上的 QoS，一个用户登录从远程位置，您可以仅设置优先级内部、 托管网络中。 尽管远程位置可以通过实现虚拟专用网络 (VPN) 接收托管的连接，我们建议您避免运行实时通信流量通过 VPN。

> [!NOTE]
> 我们建议您实现拆分隧道 VPN 连接远程用户最大化的用户体验质量。 将文档[部署指南 VPN 拆分隧道](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 )从 MyAdvisor 下载的详细信息。

在全局组织中使用托管跨洲的链接，强烈建议 QoS 因为这些链接的带宽有限 LAN 进行对比。

## <a name="qos-queues"></a>QoS 队列

若要提供 QoS，网络设备必须具有分类通信的方式，并且必须能够与其他网络流量区分语音或视频。 

区分的服务 (DiffServ) 使用服务 （直观操作方法） 的 IPv4/IPv6 数据包标头中的字段的类型设置网络设备的优先级。 DiffServ 字段的六个最重要位是区分的服务代码点或 DSCP。 使用这种情况，流量可以是归类为特定类型 （例如，语音），然后将标记 （101110 或 46 的语音流量的十进制），以便相应地时网络设备处理这些标记，可以确定优先级流量 （中快速转发，此示例中）。

当网络流量进入路由器时，流量放入队列。 如果没有任何 QoS 就地，没有为只有一个队列，并且数据处理为第一项，先出。这意味着语音通信 （这是非常对延迟敏感） 可能停滞后面流量从联机流服务。 实现 QoS 时，您可以使用不同的拥塞管理功能 （如 Cisco 的优先级队列和基于类的加权公平队列 [CBWFQ]） 和拥塞避免功能 （如加权随机早期检测 [定义多个队列WRED])。

![全部可用带宽分为多个队列 — 音频、 视频和其他通信 — 的已分配不同的优先级。](media/Qos-in-Teams-Image2.png "全部可用带宽分为多个队列 — 音频、 视频和其他通信 — 的已分配不同的优先级。")

_图 2。QoS 队列的示例_

这些条目准备就绪后，就可以传递可预测的 QoS，因为网络现在了解如何进行分类，将标记，并设置其优先级流量。 从工作组角度来看，最重要的配置步骤的分类和标记的数据包，但在进行端到端 QoS 成功您还需要仔细对齐的基础的网络配置的应用程序的配置。

## <a name="teams-qos-scenarios"></a>团队 QoS 方案

有关 QoS 团队的实施的指南基于四种方案：

*  **方案 1:** 您已部署或要部署团队并计划实现 QoS 通过基于端口的标记。 基于端口的标记处于最可靠的方法，因为它适用于所有平台上的全局和是最容易实现。  

*  **方案 2:** 您已部署或要部署团队并计划通过组策略对象标记实现 QoS。 此方案有时会与方案 1 结合使用。 尽管这种情况下完全无效，但它仅适用于加入域的 Windows 客户端。 未加入域的 Windows 客户端的任何设备不启用 DSCP 标记。

*  **方案 3:** 您已部署 Skype 业务 Online，包括 QoS 标记，并立即部署团队。 如果是你，Teams 将遵循现有配置，并且将使用与 Skype for Business 客户端相同的端口范围和标记。 在大多数情况下，将不需要任何其他配置。 

    > [!NOTE]
    > 如果您使用的应用程序名称 QoS 标记通过组策略，您必须添加 Teams.exe 作为应用程序的名称。

*  **方案 4:** 已部署或要部署团队，希望通过基于端口的标记使用的自定义端口范围中实现 QoS。

## <a name="implement-qos"></a>实施 QoS

在非常高级别，实现 QoS 需要以下步骤：

1. 确定您路由和带宽的要求。

2. 使用 DSCP 标记和端口范围分类流量。

3. 配置组策略对象中的基于策略的 QoS 设置。

4. 验证在组策略对象的端口范围。

5. 验证通过分析团队流量网络上的 QoS。

准备实现 QoS 时，请记住以下准则：

- Office 365 的最短路径是最佳。

- 关闭端口仅将导致质量下降。

- 任何障碍中间，如代理，不建议使用。

- 限制跃距数：

    - 客户端到网络边缘 – 3 到 5 跃点数。
    - Microsoft 网络边缘 – 3 个跳跃 ISP
    - Microsoft 网络边缘到最终目的地 – 无关 

有关配置防火墙端口的信息，请转到[Office 365 Url 和 IP 范围](office-365-urls-ip-address-ranges.md)。

## <a name="determine-bandwidth-requirements"></a>确定带宽要求

配置 Microsoft 团队的 QoS 之前，请务必为 Microsoft 团队准备您的网络并确定您的带宽要求。 QoS 提供网络中的实时通信要求保留每个链接上定义带宽量。 （如果在任何时候，该带宽不是必需的实时通信，它可用于其他通信。）

通过网络流量拥塞将会显著影响媒体质量。 缺乏带宽导致性能下降和很差的用户体验，因此请考虑带宽规划团队部署的起始点。 随着团队应用和使用情况，则可以使用报告功能，来进行必要的调整。 

确定带宽要求时，可以帮助网络规划人员 FastTrack 上可用。

### <a name="requirements-for-a-connection-from-your-network-to-microsoft-network-edge"></a>用于从您的网络连接到 Microsoft 网络边缘的要求

作为最佳媒体质量，表 1 中显示的阈值的网络性能目标所需从组织的网络连接到 Microsoft 网络边缘。

> [!IMPORTANT]
> 连接到 Office 365 服务公司网络上的团队客户端之间必须满足以下网络性能要求。

_表 1。网络性能指标-到 Office 365 服务的客户端_

| 指标 | 目标 |
|--------|--------|
| 延迟（单向） | < 50 毫秒 |
| 延迟 （来回行程时间 (RTT) | < 100 毫秒 |
| 突发数据包丢失 | 任何 200 毫秒的时间间隔期间 < 10% |
| 数据包丢失 | 任何 15 的第二个间隔期间 < 1% |
| 数据包间到达抖动 | 任何 15 的第二个间隔期间 < 30 毫秒 |
| 数据包重新排序 | < 0.05%共顺序数据包 |

延迟指标目标假定您的公司网站和 Microsoft 边缘位于同一洲。

Microsoft 网络边缘连接到您公司网站中包含第一个跃点网络访问，可以是 WiFi 或其他无线技术。

网络性能目标假定适当的带宽和/或 QoS 规划。 换句话说的要求适用于团队实时的媒体流量直接峰值负载下的网络连接时。

### <a name="requirements-for-a-connection-from-your-network-edge-to-microsoft-network-edge"></a>用于从您网络边缘连接到 Microsoft 要求网络边缘

表 2 显示网络性能目标或所需的网络边缘和 Microsoft 网络边缘之间的连接的阈值。 这排除贵组织的内部网络或 WAN，并测试网络流量通过 internet 或通过 ExpressRoute 合作伙伴网络发送时用作指南。

> [!IMPORTANT]
> 您的公司网络边缘到 Microsoft 网络边缘之间的连接必须满足以下网络性能要求。

_表 2。网络性能指标-边缘到边缘_

| 指标 | 目标 |
|--------|--------|
| 延迟（单向） | < 30 毫秒 |
| 延迟 （来回行程时间 (RTT) | < 60 毫秒 |
| 突发数据包丢失 | 任何 200 毫秒的时间间隔期间 < 1% |
| 数据包丢失 | 任何 15 的第二个间隔期间 < 0.1% |
| 数据包间到达抖动 | 任何 15 的第二个间隔期间 < 15 毫秒 |
| 数据包重新排序 | 利用顺序数据包 < 0.01% |


## <a name="recommended-dscp-markings"></a>建议的 DSCP 标记

您已准备好配置 QoS，您第一步是进行分类 （如音频和视频） 通信流通过将 DSCP 值分配给的唯一的非重叠端口范围。 此处分配的 DSCP 值将决定需要通过网络，根据网络配置的流量的优先级。 每个工作负荷获取其自己的 DSCP 值，但不一定的唯一值 — 可能想要设置相同的语音和视频的工作负荷，值为他们提供网络中的相同的优先级。  

要使用的 DSCP 值取决于您希望如何设置优先级工作负荷。 例如，业务要求可能要求您提供应用程序共享按视频的优先级 （并因此使用视频相同的 DSCP 值标记它）。 其他环境可能具有现有的 QoS 策略就地，这将帮助您确定网络工作负荷的优先级。 

表 3 显示与 ExpressRoute 团队所需的 DSCP 标记。 这些标记可能用作不能确定要在其自己的环境中使用的客户的良好的起始点。 要了解详细信息，请阅读 [ExpressRoute QoS 要求](https://docs.microsoft.com/azure/expressroute/expressroute-qos)。

_表 3。DSCP 标记_

| 客户端源端口范围 |协议|媒体类别|DSCP 值|DSCP 类|
|---------|---------|---------|---------|---------|
| 50000 – 50,019|TCP/UDP|音频|46|加速转发 (EF)|
| 50,020 – 50,039|TCP/UDP|视频|34|保证转发 (AF41)|
| 50,040 – 50,059|TCP/UDP|应用程序/桌面共享|18|保证转发 (AF21)|

表 3 中使用的信息时要注意以下事项：

-  如果您计划将来实现 ExpressRoute 并没有尚未实施 QoS，我们建议您遵循表 3 中的指南，以便是来自到接收方的发件人相同的 DSCP 值。 

-  所有客户端，其中包括移动客户端和团队设备，将使用这些端口范围，并将受您实现任何 DSCP 策略使用这些源端口范围。 将继续使用动态端口的唯一客户端是基于浏览器的客户端 （即，这些客户端，允许使用其浏览器加入会议的参与者）。

-  尽管 Mac 客户端使用相同的端口范围，但它还使用硬编码为值 （ef） 级别音频和视频 (AF41)。 这些值是不可配置。


## <a name="source-ports-used-by-teams"></a>Teams 使用的源端口

在 Teams 中，应根据不同工作负荷使用的源端口配置 QoS。 目前，可以配置的任何服务器端和客户端端口范围。 

表 3 中列出的客户端源端口范围还适用于团队，并使用其关联的 QoS DSCP 标记。

实现这些 QoS 策略的推荐的方法是使用客户端源端口源和目标 IP 地址为"任何。" 这将在内部网络中捕获这两个传入和传出的媒体流量。 

> [!NOTE]
> 如果您已经配置 QoS 基于源的端口范围的 Skype 业务联机，相同的配置将应用于工作组和需要进一步的更改。 如果您已为 Business Server 本地部署 Skype，您需要重新检查 QoS 策略，并根据需要调整这些。

## <a name="set-dscp-markings"></a>设置 DSCP 标记

有多个方法设置通信量分类适当的 DSCP 标记：

-  **端点处的 DSCP 标记：** 这通常是首选的选项，因为本身的终结点提供适当的标记。 当前这可以通过使用组策略对象，但它仅可加入域的 Windows 客户端上。 移动客户端不提供通过使用 DSCP 值标记流量的机制。 尽管您无法配置非&ndash;标记流量，客户端 Mac OS 如加入域的 Windows 客户端具有硬编码标记，并将始终标记流量，如上文所述。

-  **基于端口的 DSCP 标记使用路由器上的访问控制列表 (Acl):** 这是在异类 Windows 和 Mac 环境中遇到非常常见选项。 在此方案中，网络团队标记基于定义每种形式的源端口范围的入站/出站路由器 （通常位于 WAN） 通信。 虽然这可以工作跨平台，仅标记在 WAN 边缘流量 — 不一直到客户端计算机 — 和因此产生管理开销。

-  **组合的终结点和基于端口的路由器上的 Acl 的 DSCP 标记：** 我们建议此组合方案，如有可能在您的环境中。 使用组策略对象捕获大多数客户端，并且使用基于端口的 DSCP 标记，以确保该 mobile、 Mac 和其他客户端将仍获取 QoS 诊 （至少部分）。

您可以使用基于策略的 QoS 组策略中设置团队客户端中的预定义的源端口范围的 DSCP 值。 使用表 3 中指定的端口范围创建的每个工作负荷策略。

您已确定的端口范围后下, 一步是配置组策略对象中的基于策略的 QoS 设置。 [配置端口范围和客户端 Skype 业务服务器上的服务质量策略](https://docs.microsoft.com/SkypeForBusiness/manage/network-management/qos/configuring-port-ranges-for-your-skype-clients#configure-quality-of-service-policies-for-clients-running-on-windows-10)中，可以找到有关这些步骤的详细信息。

若要创建 Windows 10 计算机音频 QoS 策略，首次登录到计算机上安装的组策略管理。 打开组策略管理 （单击开始、 管理工具，，然后单击组策略管理），然后完成以下步骤：

1. 在组策略管理中，找到应在其中创建新策略的容器。 例如，如果您的所有客户端计算机位于名为**客户端**OU，应客户端 OU 中创建新策略。

2. 右键单击相应的容器，然后单击**创建在这个域 GPO 并在此处链接**。

3. **新建 GPO**对话框中，在**名称**框中，键入新的组策略对象的名称，然后单击**确定**。

4. 右键单击新建的策略，，然后单击**编辑**。

5. 在组策略管理编辑器中，展开**计算机配置**，展开**Windows 设置**、**基于策略的 QoS**，右键单击，然后单击**新建策略**。

6. 在**基于策略的 QoS**对话框中，在打开页上，键入**名称**框中的新策略的名称。 选择**指定 DSCP 值**并将值设置为**46**。 保留未选择，**指定出站调节率**，然后单击**下一步**。

7. 在下一页上，确保选中**所有应用程序**，，然后单击**下一步**。 此设置指示网络以查找所有包的特定应用程序创建的 46，而不仅仅是数据包的 DSCP 标记。

8. 在第三页上，确保同时**任何源 IP 地址**和**任何目标 IP 地址**选中，则，然后单击**下一步**。 这两个设置确保将管理数据包而不考虑哪台计算机 （IP 地址） 发送数据包和哪台计算机 （IP 地址） 将接收数据包。

9. 在四页中，从**选择此 QoS 策略应用于的协议**下拉列表中选择**TCP 和 UDP** 。 TCP （传输控制协议） 和 UDP （用户数据报协议） 是最常使用的两个网络协议。

10. 在标题下**指定源端口号**，**从此源端口或范围**中进行选择。 在相应的文本框中，键入供音频传输的端口范围。 例如，如果预留端口 50000 到音频流量的端口 50019，输入使用以下格式的端口范围： **50000:50019**。 单击“**完成**”。

已在客户端计算机上刷新组策略之前，您已创建的新策略不会生效。 尽管自己定期刷新组策略，您可以强制立即刷新。

### <a name="force-group-policy-refresh"></a>强制组策略刷新

1. 在您要刷新组策略的每台计算机上打开命令控制台。 确保命令控制台设置以管理员身份运行。

2. 在命令提示符处，输入
   ```
    gpupdate.exe /force
   ```

## <a name="verify-dscp-markings-in-the-group-policy-object"></a>验证 DSCP 标记中的组策略对象

若要验证已设置的组策略对象的值，请执行以下步骤。

1. 打开一个命令控制台。 确保命令控制台设置以管理员身份运行。

2. 在命令提示符处，输入 
   ```
   gpresult /R > gp.txt
   ```

   这将生成一个报告，并将其发送到一个名为 gp.txt 文本文件。 或者，您可以输入以下命令以生成更容易阅读 HTML 报表名为 gp.html 中相同的数据：
   ```
   gpresult /H >gp.html
   ```
 ![运行 gpresult 命令控制台窗口的屏幕截图。](media/Qos-in-Teams-Image3.png "运行 gpresult 命令控制台窗口的屏幕截图。")

3. 在生成的文件中，查找的标题**应用组策略对象**和验证前面创建的组策略对象的名称位于应用策略的列表。 

4. 打开注册表编辑器中，并转到：

   HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\

   验证表 4 中列出的注册表项的值。

   _表 4。QoS 程序的 Windows 注册表项的值_


   |          名称          |  类型  |    数据     |
   |------------------------|--------|-------------|
   |    应用程序名称    | REG_SZ |  Teams.exe  |
   |       DSCP 值       | REG_SZ |     46      |
   |        本地 IP        | REG_SZ |     \*      |
   | 本地 IP 前缀长度 | REG_SZ |     \*      |
   |       本地端口       | REG_SZ | 50000-50019 |
   |        协议        | REG_SZ |     \*      |
   |       远程 IP        | REG_SZ |     \*      |
   |    远程 IP 前缀    | REG_SZ |     \*      |
   |      远程端口       | REG_SZ |     \*      |
   |     限制率      | REG_SZ |     -1      |


5. 验证应用程序名称条目的值正确客户端使用，并确认的 DSCP 值和本地端口条目反映中的组策略对象的设置。

## <a name="validate-qos-by-analyzing-teams-traffic-on-the-network"></a>验证通过分析团队流量网络上的 QoS

有关 QoS 可以取得高效率、 DSCP 值设置组策略对象都需要呼叫两端都存在。 通过查看生成的团队客户端的通信，您可以验证的 DSCP 值不更改或去除团队工作负荷通信量遍历移动通过网络。

最好，您可以捕获网络出口点处的流量。 您可以使用端口镜像开关或路由器上与此帮助。

### <a name="use-network-monitor-to-verify-dscp-values"></a>使用网络监视器验证 DSCP 值

网络监视器是您可以[从 Microsoft 下载](https://www.microsoft.com/download/4865)分析网络流量的工具。

1. 在 PC 上运行网络监视器，连接到端口镜像和开始捕获数据包已配置的端口。 

2. 使用团队客户端发起呼叫。 请确保媒体建立挂断呼叫之前。 

3. 停止捕获。

4. 在**显示筛选器**字段中，使用源 IP 地址的 pc 的发出呼叫，并通过定义作为搜索条件的 DSCP 值 46 (hex 0xb8) 优化筛选器，如下面的示例中所示：

    Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8 

    ![网络监视器，显示应用的筛选器中的显示筛选器对话框的屏幕快照。](media/Qos-in-Teams-Image4.png "网络监视器，显示应用的筛选器中的显示筛选器对话框的屏幕快照。")

5. 选择**应用**以激活筛选器。

6. 在**帧摘要**窗口中，选择第一个 UDP 数据包。

7. 在**帧详细信息**窗口中，展开 IPv4 列表项，并注意末尾的行的开头**DSCP**值。 

    ![网络监视器，突出显示 DSCP 设置中的帧详细信息对话框的屏幕快照。](media/Qos-in-Teams-Image5.png "网络监视器，突出显示 DSCP 设置中的帧详细信息对话框的屏幕快照。")

在此示例中的 DSCP 值设置为 46。 这是正确的因为使用的源端口是 50019，表示这是语音工作负荷。 

为 GPO 标记的每个工作负荷重复执行验证。 

## <a name="more-information"></a>更多信息

[为 Microsoft Teams 准备贵组织的网络](prepare-network.md)

[ExpressRout QoS 要求](https://docs.microsoft.com/azure/expressroute/expressroute-qos)