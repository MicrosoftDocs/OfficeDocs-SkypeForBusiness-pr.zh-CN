---
title: 在 Microsoft 小组-Microsoft 小组的 QoS
author: rmw2890
ms.author: MyAdvisor
manager: Serdars
ms.date: 04/23/2018
ms.topic: article
ms.service: msteams
ms.reviewer: rowille
description: 针对 Microsoft Teams 的服务质量 (QoS) 准备贵组织的网络。
MS.collection: Strat_MT_TeamsAdmin
appliesto:
- Microsoft Teams
ms.openlocfilehash: 884055dce490b9db8fd31f6e52042a4315633e00
ms.sourcegitcommit: f942232d43fc4ad56b34dd400fdb4bca39013f5f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/26/2018
---
# <a name="quality-of-service-qos-in-microsoft-teams"></a>Microsoft Teams 中的服务质量 (QoS)

这篇文章将帮助您准备您组织的网络的服务质量 (QoS) 在 Microsoft 小组。
QoS 是一种机制，用于确定某些类型的网络通信流的优先级。 确定优先级的实时通信服务，如团队的通信很重要提供企业级的用户体验。 若要真正有效的 QoS，您必须配置从结束到结束 （PC、 网络交换机和路由器到云） 支持 QoS 的连接由于未能支持 QoS 的路径的任何部分可以降低整个呼叫质量。

![公司的网络和 Office 365 提供服务之间的关系： 内部网络和设备连接连接与 Office 365 云语音和音频会议服务的互连网络。](media/Qos-in-Teams-Image1.png "公司的网络和 Office 365 提供服务之间的关系： 内部网络和设备连接连接与 Office 365 云语音和音频会议服务的互连网络。")

_图 1。公司的网络和 Office 365 提供服务之间的关系_
 

在大多数情况下，将非托管的网络互联网连接互联网络。 一个选项可用来满足端到端 QoS 是[Azure ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/)。 我们仍然建议您实现 QoS 可以控制，即您的内部网络上的网络部分。 这将提高整个部署的实时通信负载的质量，缓解现有部署中的阻塞点。 


## <a name="prioritize-teams-network-traffic-for-qos"></a>QoS 为排定小组网络通信 

本文重点介绍如何确定团队实时通信流的优先级 — — 即，语音和视频。 此外可以设置其他类型的通信，根据您的需要的优先级。

有多种方式对流量进行优先排序，最常用的是使用区分服务代码点 (DSCP) 标记。 它们可以应用 （"标记"） 基于端口范围以及通过组策略对象。 我们将介绍在这篇文章。 我们建议您使用标记基于端口范围，因为它适用于所有的设备，而不仅仅是那些加入到域中。

控制通过组策略对象的 DSCP 标记可确保加入域的计算机收到正确的设置，只有管理员可以管理它们。
 
请务必理解 QoS 实现连接调用方对被调用方的所有链接上时才有效。 如果用户从远程位置登录到内部网络上使用 QoS，可以只优先考虑内部、 托管网络中。 尽管远程位置可以通过实现虚拟专用网络 (VPN) 接收托管的连接，我们建议您避免通过 VPN 运行实时通信流。

> [!NOTE]
> 我们建议您实现拆分隧道的 VPN 连接远程用户能够获得最高质量的用户体验。 将文档[部署指南 VPN 拆分隧道](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 )从 MyAdvisor 下载的详细信息。

在全球组织中具有跨洲的管理链接，因为这些链接带宽受到限制局域网进行对比强烈建议 QoS。

## <a name="qos-queues"></a>QoS 队列

若要在网络上提供的保证应用程序的服务级别，基础网络设备必须划分不同类型流量的一种方法。 如果您的组织想要比其他通信提供语音通信优先级，路由器 （例如） 必须能够区分语音和普通 web 浏览的通讯量。 

区分的服务 (DiffServ) 提供了一个框架，在其中通信由不同的优先级基于 IPv4/IPv6 数据包标头中的服务 (ToS) 字段的类型的网络设备。 六个最高有效位的 DiffServ 字段是区分的服务代码点或 DSCP。 使用此框架，流量可以归类为特定类型的通信 （例如，声音），然后标记 （101110 或进行语音通信的十进制数的 46），以便在网络设备处理这些标记，流量可以相应地优先 （加速转发，在本例中）。

当网络流量进入路由器时，通信量将被放入队列 — — 如果有没有 QoS 到位、 实质上是没有一个队列中，并且数据处理为先入先出。这意味着，（这是对延迟非常敏感） 的语音通信可能停滞背后流量从联机流式服务。 在 QoS 的实施，您可以通过使用不同的拥塞管理功能 （例如 Cisco 的优先级队列和基于类的加权公平队列 [CBWFQ]） 和拥塞避免功能 （如加权随机早期检测 [定义多个队列WRED])。

![全部可用带宽划分多个队列 — — 音频、 视频和其他通信 — — 已指派不同的优先级别。](media/Qos-in-Teams-Image2.png "全部可用带宽划分多个队列 — — 音频、 视频和其他通信 — — 已指派不同的优先级别。")

_图 2。可视化的 QoS 队列_

这些条目准备就绪后，就可能因为基础托管的网络现在能够理解如何分类、 标记和设置优先级的通信提供可预知的 QoS。 从团队的角度来看，最重要的一个配置步骤是分类和标记的数据包，但对于端到端 QoS 若要取得成功还需要仔细调整的基础网络配置的应用程序的配置。

## <a name="teams-qos-scenarios"></a>团队的 QoS 方案

为团队的 QoS 的实施指南基于四种情况：

*  **方案 1:** 已经部署或正在部署团队并对基于端口的标记通过 QoS 的实施计划。 基于端口的标记是最可靠的方法，因为它在所有的平台会发挥普遍作用，并且是最容易实现。  

*  **方案 2:** 已经部署或正在部署团队并计划实施 QoS 通过组策略对象添加标签。 此方案有时会与方案 1 结合使用。 虽然这种情况下是完全有效的就一定要了解它仅适用于加入域的 Windows 客户端。 未加入域的 Windows 客户端的任何设备将不会启用的 DSCP 标记。

*  **方案 3:** 已经部署了 Skype 的业务联机，包括 QoS 标记，并立即部署团队。 如果是你，Teams 将遵循现有配置，并且将使用与 Skype for Business 客户端相同的端口范围和标记。 在大多数情况下，将所不需任何额外的配置。 
 
    > [!NOTE]
    > 如果您使用的应用程序名称 QoS 标记通过组策略，您必须添加 Teams.exe 作为应用程序的名称。

*  **方案 4:** 已经部署或正在部署团队并想要通过使用自定义端口范围基于端口的标记实现 QoS。

## <a name="recommended-dscp-markings"></a>建议使用的 DSCP 标记

第一步是通过将 DSCP 值分配给的唯一的、 非重叠的端口范围进行分类 （例如音频和视频） 的通信量。 此处指定的 DSCP 值将确定需要通过网络，根据网络配置的通信量的优先级。 每个工作负载获取自己的 DSCP 值，但不一定是一个唯一值，有些客户可能会设置相同的值对于语音和视频的工作负荷，在网络中为他们提供相同的优先级。  

要使用 DSCP 值取决于所需优先工作负荷。 例如，业务需求可能要求您为应用程序提供共享视频相同的优先级 （和因此标记它与视频的 DSCP 值相同）。 其他环境可能有一个现有的 QoS 策略将帮助您确定网络工作负载优先级的位置中。 

表 1 显示了在团队中使用 ExpressRoute 时所需的 DSCP 标记。 这些标记可以作为不确定怎么用他们自己的环境的客户很好的起点。 要了解详细信息，请阅读 [ExpressRoute QoS 要求](https://docs.microsoft.com/azure/expressroute/expressroute-qos)。


_表 1。DSCP 标记_
    
| 客户端的源端口范围 |协议|媒体类别|DSCP 值|DSCP 类|
|---------|---------|---------|---------|---------|
| 50000-50,019|TCP/UDP|音频|46|加速转发 (EF)|
| 50,020-50,039|TCP/UDP|视频|34|保证转发 (AF41)|
| 50,040-50,059|TCP/UDP|应用程序/桌面共享|18|保证转发 (AF21)|

下面是使用表 1 中的信息时的一些注意事项：
    
-  如果您打算在今后实施 ExpressRoute 并没有尚未实现 QoS，我们建议您按照表 1 中的指导，以便 DSCP 值都相同，则从发送方到接收方。 

-  所有客户端，包括移动客户端和团队设备将使用这些端口范围，将受到任何使用这些源端口范围的 DSCP 策略实现。 将继续使用动态端口的唯一客户端是基于浏览器的客户端 （让参与者加入会议通过其浏览器的客户）。

-  虽然 Mac 客户端使用相同的端口范围，Mac 客户端音频 (EF) 和视频 (AF41) 也使用硬编码的值。 这些值是不可配置的。
 
    
## <a name="source-ports-used-by-teams"></a>Teams 使用的源端口

在 Teams 中，应根据不同工作负荷使用的源端口配置 QoS。 当前配置的任何服务器端和客户端的端口范围。 

请注意客户端源端口范围在表 2 中列出并使用其相关的 QoS DSCP 标记。

_表 2。客户端的源端口范围_

| 客户端的源端口范围 |协议|媒体类别|DSCP 值|DSCP 类|
|---------|---------|---------|---------|---------|
| 50000-50,019|TCP/UDP|音频|46|加速转发 (EF)|
| 50,020-50,039|TCP/UDP|视频|34|保证转发 (AF41)|
| 50,040-50,059|TCP/UDP|应用程序/桌面共享|18|保证转发 (AF21)|

实施这些 QoS 策略的推荐的方法是使用客户端的源端口源和目标 IP 地址为"任意"。 这将内部网络上捕获这两种介质传入和传出通信。 

> [!NOTE]
> 如果您已配置 QoS 根据源端口范围对 Skype 的在线业务，相同的配置将应用到团队，则需要任何进一步的更改。 如果您已经部署了 Skype 对于业务服务器部署，您将需要重新设计您的 QoS 策略。

## <a name="setting-dscp-markings"></a>设置 DSCP 标记

有多种方法设置通信量分类正确的 DSCP 标记：

-  **在端点的 DSCP 标记：**这通常是首选的选项，因为自身的终结点提供适当的标记。 目前这可以通过使用组策略对象中，但它只能使用加入域的 Windows 客户端上。 移动客户端没有提供一种机制来使用 DSCP 值标记的通讯。 虽然您不能配置非&ndash;于标记的通讯，如 Mac OS 客户端加入域的 Windows 客户端具有硬编码的标记，并将始终标记通信，如上面所述。

-  **基于端口的 DSCP 标记在路由器上使用访问控制列表 (Acl):** 这是在 Windows 和 Mac 的异构环境中遇到的常见选项。 在这种情况下，网络团队标记基于为每个模式定义的源端口范围 （通常位于 WAN） 入口/出口路由器上的通信。 跨平台工作，虽然它仅标记边沿 WAN 流量 — — 不一直向客户机 — — 和因此产生的管理开销。
    
-  **的终结点和路由器上的端口基于 Acl 的 DSCP 标记组合：**我们建议这种组合，如有可能在您的环境中。 使用组策略对象来捕捉大多数客户端，并且使用基于端口的 DSCP 标记以确保该移动、 Mac 和其他客户端仍可以得到 QoS 治疗 （至少部分）。
    
可以使用组策略中基于策略的 QoS 团队客户端中设置为预定义的源端口范围的 DSCP 值。 在表 3 中指定的端口范围用于创建每个工作负荷的策略。

_表 3。按通信量类型的端口范围_
| 客户端流量类型|端口范围起始值|端口范围结束值|DSCP 值|
|---------|---------|---------|--------|
| 音频|50000|50019|46|
| 视频|50020|50039|34|
| 应用程序共享|50040|50059|18|

> [!NOTE]
> 不能更改通过团队设置的端口范围。 请查看[本文支持](https://support.microsoft.com/kb/2409256)的最新信息。 

已确定端口范围后下, 一步是配置组策略对象内的基于策略的 QoS 设置。 [此 TechNet 文章](https://technet.microsoft.com/library/jj205371(v=ocs.15).aspx)中可以找到有关这些步骤的详细信息。 

已在客户端计算机上刷新组策略，您已经创建了新的策略才能生效。 虽然自己会定期刷新组策略，您可以强制立即刷新。

### <a name="force-group-policy-refresh"></a>强制组策略刷新

1. 在您要为其刷新组策略的每台计算机上打开一个命令控制台。 请确保命令控制台被设置为以管理员身份运行。

2. 在命令提示符下，输入
```
    gpudate.exe /force
```

## <a name="verify-dscp-markings-in-the-group-policy-object"></a>验证组策略对象中的 DSCP 标记

若要验证已设置的组策略对象中的值，请执行以下步骤。

1.  打开一个命令控制台。 请确保命令控制台被设置为以管理员身份运行。

2.  在命令提示符下，输入 
    ```
    gpresult /R >gp.txt
    ```

    这将生成一个报告，并将其发送到一个名为 gp.txt 的文本文件。 或者，您可以输入以下命令以生成中名为 gp.html 的更具可读性 HTML 报表相同的数据：
    ```
    gpresult /H >gp.html
    ```
 
   ![运行 gpresult 命令控制台窗口的屏幕抓图。](media/Qos-in-Teams-Image3.png "运行 gpresult 命令控制台窗口的屏幕抓图。")

3.  在生成文件中，查找标题**应用组策略对象**并验证以前创建的组策略对象的名称在已应用策略的列表。 

4.  打开注册表编辑器，然后转至：

    HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\

    验证在表 3 中列出的注册表项的值。

    _表 3。QoS 的 Windows 注册表项的值_
    
    | 名称 | 类型 | 数据|
    |---------|---------|---------
    | 应用程序名称|REG_SZ|Teams.exe|
    | DSCP 值|REG_SZ|46|
    | 本地 IP|REG_SZ|*|
    | 本地 IP 前缀长度|REG_SZ|*|
    | 本地端口|REG_SZ|50000-50019|
    | 协议|REG_SZ|*|
    | 远程 IP|REG_SZ|*|
    | 远程 IP 前缀|REG_SZ|*|
    | 远程端口|REG_SZ|*|
    | 限制率|REG_SZ|-1|
    
5.  验证应用程序的名称输入的值是正确的客户端使用，以及的 DSCP 值和本地端口条目反映中的组策略对象的设置。

## <a name="validate-qos-by-analyzing-teams-traffic-on-the-network"></a>通过分析团队在网络上的通信验证 QoS

所设置的组策略对象需要进行有效的 QoS 的顺序被调用方调用方有 DSCP 值。 通过查看由工作组客户端生成的通信量，您可以验证 DSCP 值不会更改或剥团队的工作负荷通信量在网络中传输。 

最好是，您可以捕获通信量在网络出口点。 可以使用交换机或路由器上的端口镜像来做到这一点。

### <a name="use-network-monitor-to-verify-dscp-values"></a>使用网络监视器来验证 DSCP 值

网络监视器是一种工具，您可以[从 Microsoft 下载](https://www.microsoft.com/download/4865)来分析网络通信。

1.  在 PC 上运行网络监视器，连接到已配置的端口镜像并开始捕获的数据包的端口。 

2.  通过 Skype 业务客户端进行调用。 请确保已在挂断电话之前建立媒体。 

3.  停止捕获。

4. 在**显示筛选器**字段中，使用的 pc 的执行调用的源 IP 地址，通过定义 DSCP 值 46 （十六进制 0xb8） 作为搜索条件，进一步调整筛选，如下面的示例所示：

    Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8 

    ![在网络监视器中，显示要应用筛选器显示筛选程序对话框的屏幕截图。](media/Qos-in-Teams-Image4.png "在网络监视器中，显示要应用筛选器显示筛选程序对话框的屏幕截图。")

5.  选择要激活筛选器的**应用**。

6.  在**框架摘要**窗口中，选择第一个 UDP 数据包。

7.  在**帧详细信息**窗口中，展开 IPv4 列表项，请注意末尾的**DSCP**开头的行的值。 

    ![在网络监视器中，突出显示 DSCP 设置帧详细信息对话框的屏幕截图。](media/Qos-in-Teams-Image5.png "在网络监视器中，突出显示 DSCP 设置帧详细信息对话框的屏幕截图。")

在此示例中的 DSCP 值设置为 46。 这是正确的因为所用的源端口 50019，表示这是一个声音的工作负荷。 

为 GPO 标记的每个工作负荷重复执行验证。 
