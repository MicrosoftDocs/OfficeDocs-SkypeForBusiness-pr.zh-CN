---
title: Lync Server 2013 中的持久聊天服务器的工作原理
TOCTitle: Lync Server 2013 中的持久聊天服务器的工作原理
ms:assetid: 3d04e9a1-3f0c-458e-bcbe-d27c8c464276
ms:mtpsurl: https://technet.microsoft.com/zh-cn/library/JJ683096(v=OCS.15)
ms:contentKeyID: 49888385
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Lync Server 2013 中的持久聊天服务器的工作原理

 

_**上一次修改主题：** 2012-11-21_

利用 Lync Server 2013持久聊天服务器，您可以参与基于主题的多方持续对话。持久聊天服务器可帮助您的组织达到以下目的：

  - 改善分散在不同地理位置的跨部门团队间的通信

  - 扩大信息的知晓和参与范围

  - 改善组织扩大后的通信

  - 减少信息过载

  - 提高信息感知能力

  - 扩大重要知识和信息的传播范围

您可以将持久聊天服务器作为可选角色与 Lync Server 2013 一起部署。持久聊天服务在专用池中运行，持久聊天服务器池依赖 Lync Server 池向其路由消息。客户端使用 eXtensible Chat Communication Over SIP (XCCOS)。Lync Server前端服务器被配置为将流量路由到持久聊天服务器池。

## 高级体系结构

下图提供了持久聊天服务器体系结构和服务的高级透视图。

**持久聊天服务器高级体系结构**

![持久聊天服务器体系结构。](images/JJ683096.5db6f36f-4461-4d87-ba77-463b7ffe609b(OCS.15).jpg "持久聊天服务器体系结构。")

**持久聊天服务器高级服务**

![持久聊天服务器组件。](images/JJ683096.b6d743aa-3a86-4081-aaef-4fe3257db4e7(OCS.15).jpg "持久聊天服务器组件。")

有两个服务在持久聊天服务器前端服务器上运行：

  - 持久聊天（通道）

  - 合规性

## 持久聊天（通道）服务

持久聊天（通道）服务是负责持久聊天服务器的核心服务。此服务提供了以下功能：

  - 接受传入消息

  - 注册并列出持久聊天聊天室内的联机参与者

  - 向其他通道订阅者重新传输消息

  - 实现通道管理、聊天室邀请、搜索和新内容通知的逻辑

持久聊天（通道）服务使用持久聊天存储来存储和访问聊天室内容和其他系统元数据（授权规则等）。此服务将上载到聊天室中的文件存储到持久聊天文件存储。

## 合规性服务

合规性服务是持久聊天服务器的可选组件，负责将聊天内容和事件存档到持久聊天合规性存储。如果您的组织有要求存档持久聊天活动的规定，则可以部署可选的持久聊天合规性服务。合规性服务安装在持久聊天池中的每台持久聊天服务器中。在配置时，持久聊天服务器合规性将记录用户活动，如加入和离开聊天室，发布和阅读消息。合规性服务会将需要存档的文件存储在持久聊天合规性文件存储中。

## 持久聊天 Web 服务

在 Lync Server前端服务器上，有两个服务运行，这依赖于 Internet Information Services (IIS)，并且这两个服务将作为 Web 组件实现：

  - **用于文件上载/下载的持久聊天 Web 服务** 负责在聊天室中发布和检索文件。

  - **用于聊天室管理的持久聊天 Web 服务** 负责为用户提供管理其聊天室和创建新聊天室的能力。

## 如何开始使用持久聊天服务器？

持久聊天服务器是 Lync Server 2013 体系结构内的可选服务器角色。如果安装了持久聊天服务器角色，管理员已通过策略启用的任何用户都能将持久聊天用于 Lync 2013 客户端。有关如何部署持久聊天服务器和通过策略支持用户利用功能的详细信息，请参阅[在 Lync Server 2013 中部署持久聊天服务器](lync-server-2013-deploying-persistent-chat-server.md)。

有关如何配置持久聊天服务器部署上的设置的详细信息，请参阅[在 Lync Server 2013 中部署持久聊天服务器](lync-server-2013-deploying-persistent-chat-server.md)和[管理 Lync Server 2013 持久聊天服务器](managing-lync-server-2013-persistent-chat-server.md)。

有关如何通过策略支持用户利用 Lync 2013 客户端中的持久聊天功能的详细信息，请参阅[在 Lync Server 2013 中部署持久聊天服务器](lync-server-2013-deploying-persistent-chat-server.md)和[管理 Lync Server 2013 持久聊天服务器](managing-lync-server-2013-persistent-chat-server.md)。

如果部署了持久聊天合规性，请参阅[管理 Lync Server 2013 持久聊天服务器](managing-lync-server-2013-persistent-chat-server.md)以了解如何为合规性配置设置的详细信息。

## 持久聊天呼叫流

Lync 使用 XCCOS 与持久聊天服务通信。以下顺序说明了登录过程以及典型的聊天室订阅和消息发布方案。

## 登录

以下顺序说明了登录过程。

1.  Lync 客户端首先发送 SIP SUBSCRIBE 以从服务器中检索带内设置文档。此文档指示对用户是启用还是禁用持久聊天以及持久聊天服务器池的 SIP URI 的列表。

2.  Lync 客户端向它在上一个步骤中获得的持久聊天服务器的 SIP URI 发送 SIP INVITE 消息。INVITE 序列后跟“200 - 确定”和“ACK”，Lync 客户端现在打开了与持久聊天服务器终结点的 SIP 会话。因此，客户端通过发送包含聊天消息或请求服务器执行操作的命令的 SIP INFO 消息与持久聊天服务器通信。所有这些消息都使用“200 - 确定”或“503 - 服务不可用”（即，在服务器负载过重的情况下）确认。如果客户端收到 503 响应，则会重试消息。（本示例不包括 503 响应。）如果服务器接受了消息或命令并发送了“200 - 确定”，则会以单独的 SIP INFO 消息的形式向客户端提供响应。此响应包括对发出的命令的引用。

3.  Lync 客户端发送包含 XCCOS **getserverinfo** 命令的 SIP INFO 消息。持久聊天服务器使用包含有关持久聊天服务配置的信息的新 SIP INFO 消息进行回复。

4.  Lync 客户端发送包含 XCCOS **getassociations** 命令的 SIP INFO 消息。持久聊天服务器使用包含用户作为成员的聊天室的列表的新 SIP INFO 消息进行回复。Lync 客户端重复该命令以检索用户作为管理员的聊天室的列表。

5.  Lync 客户端从“状态”文档获取已关注的聊天室的列表，其中的每一个已关注的聊天室都由一个“roomSetting”类别表示。所有已关注的聊天室都通过一个包含 XCCOS **bjoin** 命令（包含聊天室 URI 列表）的 SIP INFO 消息联接。由于已关注的聊天室的列表保存在服务器上，因此任何计算机上的任何客户端都具有相同的指定用户 URI 的已关注聊天室列表。Lync 客户端还将开放式聊天室（如果用户启用了此选项）的列表保存在本地计算机注册表中，并在登录时通过发送包含每个聊天室的 XCCOS **join** 命令的 SIP INFO 消息加入所有这些开放的聊天室。由于此列表保存在注册表中，因此它在在不同计算机上运行的两个 Lync 客户端上可能不同。

6.  对于每个加入的聊天室，Lync 客户端都会发送一个包含 XCCOS **bccontext** 命令的 SIP INFO 消息。持久聊天服务器使用包含聊天室内的最新聊天消息的新 SIP INFO 消息进行回复。

7.  Lync 客户端发送包含 XCCOS **getinv**（即 get invitation）命令的 SIP INFO 消息以请求客户端尚未发现的任何新聊天室邀请。在单独的 SIP INFO 消息中，持久聊天服务器将返回这些聊天室的列表。

## 订阅聊天室和发布消息

以下顺序说明了典型的聊天室订阅和消息发布方案。

1.  在 Lync 客户端中，User1 单击“加入聊天室”，单击“搜索”，然后输入一些搜索条件。客户端发送包含 XCCOS **chansrch**（聊天室搜索）命令的 SIP INFO 消息以及搜索条件。持久聊天服务器查询后端数据库并使用包含满足搜索条件的可用聊天室的列表的新 SIP INFO 消息中进行回复。

2.  User1 选择他/她要加入的聊天室，然后单击“关注此聊天室”。客户端向持久聊天服务器发送包含 XCCOS **join** 命令的 SIP INFO 消息和用户选择的聊天室的聊天室 ID。持久聊天服务器使用包含设置数据的 SIP INFO 消息进行回复。

3.  Lync 客户端向持久聊天服务器发送包含 XCCOS **bccontext**（聊天记录上下文）命令的 SIP INFO 消息。持久聊天服务器检索聊天记录，并通过一条 SIP INFO 消息将其返回到客户端。此时，用户进入聊天室并准备好参与。

4.  User1 输入新消息，然后单击“发送”。Lync 客户端通过 SIP INFO XCCOS **grpchat** 命令将该消息发布到聊天室。持久聊天服务器将此新消息的副本存储在持久聊天后端数据库中。

5.  持久聊天服务器将 SIP INFO XCCOS **grpchat** 消息的单个副本发送给 User2，该用户已进入聊天室。

## 持久聊天合规性呼叫流

持久聊天服务器使用消息队列（也称为 MSMQ）和其他合规性数据库 (mgccomp) 处理合规性数据。作为合规性事件处理方式的示例，以下事件顺序说明了如何处理消息发布事件。

1.  用户向聊天室发布消息。

2.  持久聊天服务器放置与专用“消息队列”队列中的事件有关的信息。

3.  持久聊天合规性服务器从队列中读取此事件，并将其放在 mgccomp 数据库中以进行处理。

4.  持久聊天合规性服务器定期处理数据库中的一组事件，并将其发送到持久聊天合规性适配器以供稍后处理。

5.  如果该适配器成功处理了数据，则持久聊天合规性服务器将从 mgccomp 数据库中删除这些事件。

