---
title: Skype for Business Online 中的 ExpressRoute 和 QoS
ms.author: tonysmit
author: tonysmit
manager: serdars
ms.reviewer: mpottier, dougand
ms.topic: article
ms.assetid: 20c654da-30ee-4e4f-a764-8b7d8844431d
ms.tgt.pltfrm: cloud
ms.service: skype-for-business-online
search.appverid: MET150
ms.collection: Adm_Skype4B_Online
audience: Admin
appliesto:
- Skype for Business
- Microsoft Teams
localization_priority: Normal
f1.keywords:
- NOCSH
ms.custom:
- Optimization
description: 'Learn about using Azure ExpressRoute to have a network with bandwidth requirements and Quality of Service capability for a business class user experience. '
ms.openlocfilehash: f638a154e379d065d355010160bf8dff0ecc1b78
ms.sourcegitcommit: 19f534bfafbc74dbc2d381672b0650a3733cb982
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/03/2020
ms.locfileid: "41693077"
---
# <a name="expressroute-and-qos-in-skype-for-business-online"></a>Skype for Business Online 中的 ExpressRoute 和 QoS

使用适用于 Office 365 和 Skype for Business Online 的 Azure ExpressRoute 通过专用网络连接连接到 Office 365。 适用于 Skype for Business 应用的专用连接将为你提供可靠且可预测的性能，并且在公用 Internet 上也可保持隐私。 现在，你可以购买更出色的 Office 365 和 Skype for Business Online 网络连接，该连接增加了可预测性、企业级可靠性并附带运行时间 SLA。
  
> [!NOTE]
> 可用带宽计算器的新版本： [Skype for business、带宽计算器](https://go.microsoft.com/fwlink/?LinkId=715766)。 但是，本文档中的说明使用 Lync 2010 和2013带宽计算器。 
  
## <a name="skype-for-business-online-and-expressroute"></a>Skype for Business Online 和 ExpressRoute

与 Microsoft 的 ExpressRoute 合作伙伴进行协作，你可以通过专用连接来连接云中的多种 Office 365 应用程序（包括 Skype for Business Online）。 但是，Skype for Business 的实时语音和视频通信功能需要专门配置为支持这些 Office 365 实时工作负载的网络服务。 这包括具有足够带宽承载所需的流量并且能够支持服务质量 (QoS) 来为用户提供企业级体验的网络。
  
此文档旨在帮助你、管理员和网络设计师了解支持实时通信所面临的特殊挑战、Microsoft 提供用于帮助你设计能够支持这些要求的网络的工具，并使用案例研究指导你完成设计过程。 
  
本文档的第一部分将引导你完成一个案例研究，帮助你进行网络设计，你可以使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkId=690282)估计大型、多网站 Skype for Business ExpressRoute 部署的网络要求。 本文档的第二部分介绍服务质量 (QoS) 的基本概念、有关支持 Skype for Business 实时通信的特定技术详细信息的深入剖析，以及需要的特定类型的网络服务。
  
下面的所有信息将为你提供 QoS 和 ExpressRoute 的技术详细信息和理解、你将面临的特殊挑战的理解，并介绍你在 Skype for Business 网络上成功部署 ExpressRoute 所需的工具和技术的实用知识。 
  
## <a name="getting-started"></a>入门

当你为 ExpressRoute for Skype for Business 做好准备时，最好查看不同的 ExpressRoute 连接模型以及合作伙伴和位置的各种选择，并了解在你的企业内如何购买和设置 ExpressRoute。 以下是一些帮助你入门的资源： 
  
- [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)
    
- [ExpressRoute 定价](https://go.microsoft.com/fwlink/?LinkId=690284)
    
- [ExpressRoute 文档](https://go.microsoft.com/fwlink/?LinkId=690285)
    
## <a name="part-1-case-study---expressroute-for-dewey-law-llc"></a>第 1 部分：案例研究 - 面向 Dewey Law, LLC. 的 ExpressRoute

本 Dewey Law, LLC. 案例研究 介绍如何设置网络、订购网络访问服务并确定支持 ExpressRoute for Skype for Business Online 的带宽要求。
  
 **背景** Dewy Law LLC. 是国内一家大型的律师事务所，有 790 位律师，共有 5,580 名员工分布在 78 个地点。 该公司总部位于纽约，在芝加哥、旧金山和达拉斯有三个区域办事处，在国内很多区域还有 24 个大型和 50 个小型分支机构。 该公司处理大型复杂诉讼，工作通常涉及两个或更多办事处。 采用此网络设计可承载办事处之间相当大的网络流量。
  
Dewy Law LLC. 是一家相对年轻的公司，律师和其他职员非常熟悉技术，并且在很大程度上依赖它来处理日常工作。 
  
 **按位置和职位列出用户分布情况**
  
||**总部（纽约）**|**区域 办事处 (3)**|**大型 分支机构 (24)**|**小型 分支机构 (50)**|
|:-----|:-----|:-----|:-----|:-----|
|高级管理人员  <br/> |名  <br/> |10  <br/> |1  <br/> |1  <br/> |
|合作伙伴  <br/> |150  <br/> |50  <br/> |10  <br/> |5  <br/> |
|律师  <br/> |300  <br/> |100  <br/> |名  <br/> |10  <br/> |
|律师助理  <br/> |400  <br/> |125  <br/> |大约  <br/> |岁  <br/> |
|行政主管  <br/> |100  <br/> |35  <br/> |6  <br/> |3  <br/> |
|IT 和总务  <br/> |100  <br/> |二十五  <br/> |3  <br/> |ppls-2  <br/> |
|每个站点总计  <br/> |1,070  <br/> |345  <br/> |70  <br/> |36  <br/> |
|每个站点类别总计  <br/> |1,070  <br/> |1,035  <br/> |1,680  <br/> |1,800  <br/> |
   
### <a name="setting-up-the-network"></a>设置网络

为了为 Dewey Law LLC. 提供一致、高质量的实时服务，必须满足许多基本要求：
  
- 他们希望在出现电源故障时提供语音服务，因此其网络分布交换机和路由器必须通过以太网 (PoE) IEEE 802.3af 或 802.3at 供电。
    
- 网络交换机和路由器还必须使用不间断电源 (UPS)，这样就可以在发生电源故障期间继续运转。
    
    他们有一个到其 LAN 办事处的 Wi-fi 连接，因此我们强烈建议他们使用 Skype for business[解决方案](https://go.microsoft.com/fwlink/?LinkId=690281)中经过认证的 skype For business wi-fi 基础结构合作伙伴。
    
    > [!TIP]
    >  [!提示] 建议使用 802.11n 和 802.11ac 无线接入点。
  
- 最重要的是，所有办事处中的所有 LAN 网络都必须设置为提供服务质量 (QoS)。 这包括电脑、笔记本电脑和任何网络硬件，如交换机和路由器。
    
在了解为 Dewey Law LLC. 提供企业级语音服务涵盖的基础知识之后，我们建议从将连接到 Azure ExpressRoute 服务的网络服务合作伙伴使用多协议标签交换 (MPLS) IP 服务。 MPLS 提供的 IP 服务可在发生延迟、抖动和数据包丢失情形时保证性能。 但是，如果 MPLS 不可用，也可以使用连接到我们的其中一个 ExpressRoute 数据交换合作伙伴的以太网。
  
MPLS 提供商提供许多服务类别级别，但是每个服务类别都使用不同的术语进行标识。 你必须与你的提供商紧密合作，以确保他们理解你在 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)中输入的数据和可用选项，并被推荐不同的 Office 365 实时工作负载应用。
  
可以通过两种方法将 Skype for Business 应用中的数据映射到适当的 MPLS 服务类别：
  
- 使用 DiffServ 控制点 (DSCP) 标记流量的终结点
    
- 基于网络访问控制列表 (ACL)
    
若要实施终结点标记，你必须将 Dewey Law LLC 所有加入域的 Windows 计算机配置为 使用适当的 DiffServ 控制点 (DSCP) 标记来标记每个数据包，然后在所有办事处站点的所有网络交换机和路由器上实施 QoS，以确保 QoS 标记得到维护且不被删除。 网络数据包上的 DSCP 标记告知服务提供商如何区分网络数据包的优先次序。 **第 2 部分的 QoS 部分提供了有关 DSCP 的更多信息。**
  
对于基于网络 ACL 的分配，DSCP 优先级标记在上游路由器上实施，并且基于 UDP 源端口。 每个应用程序的推荐端口范围列在["网络规划"、"监视" 和 "Lync Server 疑难解答](https://go.microsoft.com/fwlink/?LinkId=690286)" 一节2.6.1.1。 请务必根据 Dewey Law LLC 的总体 QoS 实施和设计进行协调，并意识到存在不同的 QoS 策略并且可能出现数据包标记不匹配的情况。
  
每个 ExpressRoute 网络服务提供商都有适合实时语音和视频的服务类别 (QoS)。 此 COS 对于语音称为"加速转发"(EF)，对视频称为"确保转发"(AF)。 你必须非常小心地确定面向语音 EF 流量购买的带宽量。 原因是当你发送的语音流量超过了为服务类别设置的值时，语音服务类别将非常严格。
  
> [!TIP]
>  [!提示] 超出服务提供商的承诺在语音服务类别上发送的任何流量将立即被丢弃，这将直接影响语音质量。
  
当查看 Dewey Law LLC 的总体设计时， 一定要准确地确定在网络上支持语音流量所需的网络带宽量，并使用语音的 DSCP 设置（如 DSCP EF 46）标记每个语音数据包（并且仅语音数据包），这极其重要。
  
要在其企业网络中实现 QoS，终结点或路由器必须用相应的第3层优先级指示器（即 DSCP）标记每个数据包。 在整个网络路径上，每个交换机和路由器都必须启用 QoS 选项。 如果仅有一个未启用 QoS 的网络交换机或路由器，则通过该交换机或路由器传递的语音或视频数据包上的 QoS 标记可能会被去除。 这样做会在所有下游交换机和路由器中有效地禁用 QoS，从而降低拥有 ExpressRoute 的价值。
  
这也要求在每个点上定义第 3 层和第 2 层 QoS 优先级的关联。 第 2 层优先级机制在 IEEE 802.1p（有线网络）和 802.11e/WMM（Wi-Fi 网络）中定义。 更重要的是，面向网络服务提供商的 MPLS 网络的网络路由器必须维护所有出站数据包上的 DSCP 设置，以便它们将保持合适的 MPLS 服务类别。 
  
> [!TIP]
>  有关 QoS 设置的特定详细信息，请参阅2.6 中的 "[网络规划、监视和疑难解答]( https://go.microsoft.com/fwlink/?LinkId=760669)" 一节中的 "Lync Server 疑难解答" 部分。 也可以查看[规划 Skype for Business 2015 的网络要求](https://go.microsoft.com/fwlink/?LinkId=690287)，了解更多网络规划要求。
  
### <a name="ordering-network-access-services"></a>订购网络访问服务

在准备好 QoS 网络必备组件和机制来支持 ExpressRoute 之后，下一步是下订单购买 ExpressRoute 网络访问服务。 当从 Microsoft 网络服务提供商合作伙伴为 Dewey Law LLC 订购 ExpressRoute 访问服务时，你需要提供以下两项：
  
- 将每个站点连接到 ExpressRoute 和 Office 365 所需的总带宽量。
    
- 支持在 Dewey Law LLC. 使用的 Skype for Business 应用所需的每个服务类别所需的总带宽量。 服务类别带宽要求受各种 Skype for Business 应用（如语音、视频、即时消息、状态和屏幕共享）的预期流量影响。
    
### <a name="determining-bandwidth-requirements-for-skype-for-business-applications"></a>确定 Skype for Business 应用的带宽要求

对于 Dewey Law LLC.，在确定所需的总带宽量之后，你现在需要知道如何在各种服务类别之间划分总带宽量。 例如，每种 Skype for Business 应用的带宽量。
  
若要确定每个 Dewey Law LLC. 站点 的这些要求，你将使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)。 此计算器是一个基于 Excel 的工具，允许你指定各种 Skype for Business 应用的预期使用，包括语音、视频、会议和屏幕共享。 计算器将自动生成带宽估计值和其网络上的每个站点的 CoS 要求。 当你下载 Lync 2010 和 2013 带宽计算器时，还将下载一份用户指南，它将为你提供有关使用该工具的详细信息。 
  
为帮助你使用电子表格，电子表格中的各个单元格均用彩色标记：
  
- **绿色** 这些是常规的数据输入区域。
    
- **黄色** 这些是高级数据输入区域。 你可以更改这些设置，但务必小心谨慎。
    
- **红色** 这些是只读区域，输入值被锁定，不可更改。
    
- **灰色** 这些是只显示区域。 它们是来自常规输入区域的结果或数据。
    
Dewey Law LLC. 的设计过程 首先是根据用户的特征设定不同的"角色"。对于你定义的每种角色，你可以指定各种 Skype for Business 应用的预期使用（"无"、"低"、"中"、"高"或三个已定义的"自定义"设置之一）。 可在"角色"工作表中找到这些选项。 提供了每个选项的具体用法（"低"、"中"或"高"），但可以更改每个选项的默认值。 通过确定位于每个站点的每种角色的用户数量，计算器可以计算每个位置所需的总带宽量。
  
你也可以指定所使用的音频和视频编解码器、是否使用前向纠错以及将影响带宽要求的其他系统参数。 你可以使用 Lync 2010 和 2013 带宽计算器中的默认设置，也可以选择不同的编解码器和其他系统参数。 对于 Dewey Law LLC. 的站点设计，可以使用默认设置。 但是，要更改任何默认设置，可以使用下拉菜单中的所有可用选项。 "编解码器"工作表中包含用于每个选项的带宽。 当你更改任何设置时，每个站点的带宽和服务类别 (CoS) 混合更改会更新。 借助此功能，你可以测试不同的潜在配置并查看所做的更改对带宽要求的影响。
  
我们已为 Dewey Law LLC. 定义了三种角色："高级管理人员/合作伙伴"、"律师/律师助理"和"IT 管理员"。 下表介绍了我们是如何为每种角色的各种 Skype for Business 应用设置使用配置文件的。
  
 **角色和使用配置文件（"角色"工作表 - 列 A 到 P）**
  
|**角色**|**IM/状态**|**P2P 音频**|**P2P 视频**|**会议音频**|**会议视频**|**桌面共享**|**音频会议**|**Lync 2010 RTV 类型**|**远程用户**|**Lync 2013 立体声音频**|**Lync 2013 视频质量**|**Lync 2013 P2P 视频窗口的用户行为**|**Lync 2013 多视图使用**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|高级管理人员/ 合作伙伴  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |中  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |最佳  <br/> |典型  <br/> |典型  <br/> |
|律师/ 律师助理  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |高  <br/> |高  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
|IT 管理员  <br/> |高  <br/> |中  <br/> |无  <br/> |低  <br/> |无  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
   
你需要在 **按位置和职位列出用户分布情况** Lync 2010 和 2013 带宽计算器的"站点"工作表中的上述表中输入信息。 当区域办事处的用户数相同时，它们被定义为一个"站点"并指定存在三个实例。 此行为也适用于大型和小型分支机构，站点中分别有 24 个和 50 个用户。
  
在指定每种角色的设置后，你需要在"站点"工作表中输入每个站点每种角色的用户数。 所有站点的用户总数会自动更新。 由于在 Office 365 位置没有用户，应在工作表的"分支机构"行中输入所有用户。 然后，Lync 2010 和 2013 带宽计算器会填充"尽力而为类别"、"数据流量类别"和"实时流量类别"列。 这显示在下表的数据中。
  
> [!TIP]
>  [!提示] 完整的电子表格还包括每种应用的最大并发会话数，但我们为节省空间删除了这些列。
  
 **站点的角色 -（"站点"工作表 - 列 A、D、I 和 AI 至 AX）**
  
|**站点名称**|**站点中的用户总数**|**相似的站点总数**|**用户配置文件 1**|**配置文件 1 的用户数**|**用户配置文件 2**|**配置文件 2 的用户数**|**用户配置文件 3**|**配置文件 3 的用户数**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |1  <br/> |执行经理/合作伙伴  <br/> |170  <br/> |律师/律师助理  <br/> |700  <br/> |IT 管理员  <br/> |200  <br/> |
|地区办事处  <br/> |345  <br/> |3  <br/> |执行经理/合作伙伴  <br/> |60  <br/> |律师/律师助理  <br/> |225  <br/> |IT 管理员  <br/> |60  <br/> |
|大型分支机构  <br/> |70  <br/> |全  <br/> |执行经理/合作伙伴  <br/> |11  <br/> |律师/律师助理  <br/> |50  <br/> |IT 管理员  <br/> |db-9  <br/> |
|小型分支机构  <br/> |36  <br/> |50  <br/> |执行经理/合作伙伴  <br/> |6  <br/> |律师/律师助理  <br/> |二十五  <br/> |IT 管理员  <br/> |1  <br/> |
   
 **站点中每种应用所需的带宽（以 Kbps 为单位） （"站点"工作表 - 列 A 和 BQ 至 LF）**
  
|**站点**|**SIP/IM 带宽峰值**|**站点间对等音频带宽峰值**|**站点间对等视频带宽峰值**|**音频会议带宽峰值**|**视频会议带宽峰值**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |525.30  <br/> |560.00  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |
|地区办事处  <br/> |345  <br/> |185.40  <br/> |560.00  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |
|大型分支机构  <br/> |70  <br/> |92.70  <br/> |560.00  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |
|小型分支机构  <br/> |36  <br/> |119.40  <br/> |560.00  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |
   
电子表格中最重要的列可能是描述 QoS 类别的 WAN 带宽的那些列。如下表所示。此数据总结了你在每个站点订购访问连接时需要向网络服务提供商提供的信息。当计算总的带宽时，请记得将每种类型的分支站点的带宽乘以相同类型的站点数。要与你的 ExpressRoute 网络服务合作伙伴进行连接，你可以参阅 [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)。
  
在 "语音" 或 "加速转发" （EF）服务中不要超过带宽非常重要。 将丢弃一组随机数据包，而不是降低单个呼叫或一组呼叫的质量，所有正在进行的通话都将受到影响。 也很重要的一点是，只有将语音标记为适用于 EF 的 DSCP （即 DSCP = 46），或者在添加非语音流量时，语音队列可能会溢出。
  
> [!TIP]
>  同样，当 EF 服务类提供最佳性能保证时，如果你超过定义的带宽，任何其他数据包将立即被丢弃。
  
 **按 QoS 流量类别列出每个站点的聚合带宽-（"站点" 工作表-列 A 和 ML 至 MR）**
  
|**站点名称**|**最大努力类（DSCP 0）**|**数据流量类（DSCP 自定义）**|**实时通信类（DSCP 34，AF41）**|**优先级流量类（DSCP 46，EF）**|
|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |0.00  <br/> |5764.80  <br/> |3200.00  <br/> |3953.10  <br/> |
|地区办事处  <br/> |0.00  <br/> |2033.60  <br/> |1880.00  <br/> |1336.50  <br/> |
|大型分支机构  <br/> |0.00  <br/> |486.40  <br/> |1160.00  <br/> |411.00  <br/> |
|小型分支机构  <br/> |0.00  <br/> |438.40  <br/> |1160.00  <br/> |319.50  <br/> |
   
### <a name="putting-your-plan-into-action"></a>将计划投入到行动中

我们可以使用上述基于每个网站表的**每个应用程序**的带宽估计来计算将遍历 WAN 的总带宽和将遍历 ExpressRoute 的带宽量。 流经 ExpressRoute 的流量部分不会排除站点间对等带宽。

 
|**站点**|**SIP/IM 带宽峰值**|**音频会议带宽峰值**|**视频会议带宽峰值**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|**每个<br/>网站类别<br/>的 ExpressRoute 流量总数（即网站<br/>的总时间数）**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|**总部** <br/> |1,070  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |11361.80  <br/> |
|**地区办事处** <br/> |345  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |8704.20  <br/> |
|**大型分支机构** <br/> |70  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |32935.20  <br/> |
|**小型分支机构** <br/> |36  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |61005.00  <br/> |
   
这意味着将遍历 express 路由的 Skype for Business Online 流量将大约 114 Mbps，因此 Dewey 至少需要针对 ExpressRoute 的 200 Mbps 订阅。 可以在不同的 ExpressRoute 对等位置购买多个 ExpressRoute 线路。 如果 Dewey 的网站位于不同的地理区域中，或者在连接到 ExpressRoute 线路失败的事件中提供复原，则建议使用此操作。 如果在多个 Azure 区域中购买 ExpressRoute 回路，将需要 ExpressRoute premium 加载项才能接收通过 ExpressRoute 的全局连接。
  
既然您已拥有所需的带宽和服务级别（CoS）的带宽号码，您就可以将订单与所选网络服务提供商进行联系。 不要忘记包括对其他应用程序和服务的流量的估计。 我们提供了其他 Office 365 服务的网络规划指南，包括 Exchange 和 OneDrive 的带宽计算器。 网络服务提供商的带宽套餐将更高，因为站内流量将需要重新添加。 Lync 2010 和2013带宽计算器仅提供预期流量的估计，因此建议确认网络能够支持执行压力测试的流量量。 
  
> [!TIP]
> 在执行网络预评估时，强烈建议对网络进行应力测试。 
  
压力测试涉及构建和配置基础结构，然后在监视性能的同时使用模拟流量的预期数量运行它。 你的流量估计在某些方面可能不准确，但至少你可以确保它能够支持已预测到 Lync 2010 和2013带宽计算器的流量的数量。 建议你至少运行几天的压力测试，但运行它的时间较长可帮助你优化这些数字。 但是，延长压力测试期必须与您为未携带真正用户网络流量而支付的网络服务的费用进行权衡。 Microsoft 已验证了许多供应商作为 IT 专业人员工具计划的一部分，可提供网络管理和操作工具，包括网络预评估压力工具。 Skype for Business 还提供了一种系统集成商（SI），可接受经认证的 IT 专业人员工具，并为您提供网络评估。 您可以在[Skype For Business 解决方案中看到更多信息： IT 专业人员工具](https://go.microsoft.com/fwlink/?LinkID=690307)。
  
应力测试提供了一些 reassurance 网络可以支持所需流量的流量，但实际上，Lync 2010 和2013带宽计算器数据可能会因任何原因而关闭。 你还应考虑在部署正在进行的网络评估后继续监视网站网络，以确保带宽足够并确保 QoS 机制正常运行。 随着越来越多的用户在线，继续监视网络性能非常重要。
  
## <a name="part-2-expressroute-skype-for-business-qos"></a>第2部分： ExpressRoute Skype for Business QoS

Microsoft 的 ExpressRoute 服务提供到 Azure 云的专用连接，但是 Office 365 实时工作负荷的通信服务需要具有足够带宽的网络服务才能携带流量，并且能够支持服务质量（QoS），提供业务级用户体验。 支持 QoS 的连接必须配置为端到端（电脑、网络交换机和云的路由器），因为无法支持 QoS 的路径中的任何部分可能会降低整个通话的质量。
  
本部分的目的是帮助你了解在 IP 网络中支持实时流量以及使用 Microsoft 的 ExpressRoute Exchange 成功配置和支持 Office 365 实时工作负荷成功的 ExpressRoute 部署的挑战提供商或网络服务提供商合作伙伴。
  
QoS 可通过 ExpressRoute 网络线路以独占方式接受，并在 Microsoft 网络中用于 Skype for business 通信。 目前，某些来自 Microsoft 的出站连接的部分内容缺少 Skype for Business 的 DSCP 值。 在将出站流量完全标记为 DSCP 值之前，建议按照本文的**使用网络访问控制列表（ACL）** 部分中所述，在网络边界处为流量添加 QoS 标记。
  
### <a name="the-real-time-problem"></a>实时问题

提供优质的语音和视频服务将对 IP 网络施加特殊的需求。 实时流量使用使用用户数据报协议（UDP）传输的实时传输协议（RTP）。 与传输控制协议（TCP）不同，它对每条消息进行数字测试并对其进行测试，包括检测和重新传输丢失或 errored 消息的其他机制，UDP 不提供这种类型的可靠性。 如果消息因错误而损坏或因缓冲区溢出而丢失，则它们将丢失。 UDP 已被选为与 RTP 配合使用，因为实时流量的本质是，即使丢失的消息已重新发送，它们也会过晚，以致无法对语音消息流产生任何积极影响。
  
了解丢失语音数据包的影响后，设计器将提供两种方法来提高 IP 语音和视频的性能：
  
- 在数据包丢失时使语音编码/解码更有弹性。 这可以通过使用正向错误更正（FEC）来更正遇到错误的百分比，这些错误是 Office 365 实时传输中发现的功能，或通过设计语音解码系统来尝试掩盖丢失数据包的影响是 Microsoft 编解码器的一个特征。 
    
- 使用服务质量机制的传输服务确保网络性能与延迟、数据包丢失和抖动以及数据包之间的延迟发生差异。
    
复原式语音编码仅解决数据包丢失问题，因此，用于携带实时语音和视频的网络具有最大限度地减少延迟和抖动的机制非常重要。 即使在丢失了太多数据包的情况下，如果丢失了太多的数据包，接收方也没有足够的信息来重建语音信号的可识别版本。 导致语音质量显著降低的数据包丢失的百分比，具体取决于所使用的语音编码技术。 但是，在所有情况下，丢失连续数据包的字符串非常有问题。
  
最小化延迟很重要，因为延迟过多会影响对话流程，并为扬声器带来干扰。 最佳做法告诉我们语音的端到端延迟（我们指的是 "嘴-耳" 延迟）必须保持在150毫秒（毫秒）以下。 单向，而不是 "往返行程" 延迟。 当然，在给定传播延迟或信号通过电缆进行物理旅行时所花费的时间较长的传输链接（如跨 oceans 的传输链接），延迟将会增加。
  
当延迟高于150毫秒时。 单向，它对扬声器有奇怪的效果。 Psychologically，扬声器的大脑中有一个时钟，让他们认为接收者没有听到它们，并且他们会重复他们所说的最后一件事。 这与来自最远一端的延迟响应相冲突。 如果您曾经通过卫星频道说话，您将可以识别此效果。 通过附属频道，单向延迟大约是250毫秒。，其距离超过了允许的延迟。
  
 **商业级语音的推荐网络参数**
  
|**参数**|**推荐值**|
|:-----|:-----|
|数据包间的抖动（平均）  <br/> |≤5ms  <br/> |
|数据包间的抖动（最大）  <br/> |≤40ms  <br/> |
|数据包丢失率（平均）  <br/> |已接近0%  <br/> |
|网络延迟一种方式  <br/> |≤100ms （应包括 "延迟" 和 "地理距离" 检查）  <br/> |
   
### <a name="expressroute-as-part-of-a-business-grade-voice-network"></a>作为企业级语音网络一部分的 ExpressRoute

ExpressRoute 在3个连接选项之一中通过网络服务提供商（NSP）或 Exchange 提供商（EXP）提供专用连接： 
  
- 云 Exchange Colocation
    
- 点到点以太网连接
    
- "任意对任意" （IPVPN）连接
    
这提供了高可用性（99.9% 的正常运行时间 SLA）和可靠的路由（它是安全的（无 internet 传输），并不受 Internet 通信变体影响的，而是用于对流量进行排序的服务质量标记（如下所述）. ExpressRoute 和精心规划的 WAN 可为你提供商业级语音网络。
  
对于连接到电路的办公室或数据中心（如果是混合拓扑），您可以使用 ExpressRoute 进行数据传输。 非现场用户（例如，家庭办公室或旅行等）的数据不会利用 ExpressRoute 线路，除非用户已连接 VPN 且不需要包含在用于调整 ExpressRoute 线路大小的带宽评估中。 如果你是多国客户，则可以在每个区域中购买 ExpressRoute 线路，并使用 BGP 社区标记来通知路由规则，以便将流量定向到首选的 ExpressRoute 线路（通常是每个站点最接近的一个线路），而另一个电路在影响单个线路的停电时提供冗余。 
  
### <a name="if-expressroute-isnt-an-option"></a>如果 ExpressRoute 不是一个选项

将所有网站连接到 ExpressRoute 可能不可行，原因是成本、无法满足 ExpressRoute 先决条件或当前 NSP 的限制。 如果您不能使用 ExpressRoute，仍建议按照下面的指南在您的网络内标记 QoS，并使用您的 NSP 计划合同以确保有足够的带宽和支持基于 QoS 的流量优先级。
  
此外，如果你有多个区域中的办事处，但在所有区域中都没有 ExpressRoute 回路，则在为来自卫星办公室的流量配置路由时应使用区域 BGP 社区标记，以便避免不必要的长途传输。 例如，考虑在美国托管 Skype for business Online 组织的公司，但在欧洲有分支机构，并且该公司仅有一个在硅谷的 ExpressRoute 电路。 大多数 Skype for Business Online 流量将路由到托管组织的数据中心（例如，与公司内部的其他用户进行电话会议），使用 ExpressRoute 线路对于大多数流量而言可能是首选的。 但是，如果欧洲用户加入的会议呼叫由组织所在的另一家公司托管，则该呼叫中的媒体目标将是第二公司所在的欧洲数据中心。 通过在硅谷的 ExpressRoute 电路路由流量的路线可能比通过互联网更少的直接路线。 在这种情况下，你可能希望在你的网络中配置路由器（例如，在欧洲办事处），以在建立路由规则时检查社区标记，并通过 Internet 进行路由，而不是对于具有的流量的硅低谷 ExpressRoute 电路欧洲地区标记。
  
### <a name="basic-concepts-of-quality-of-service-qosclass-of-service-cos"></a>服务质量（QoS）/Class （CoS）的基本概念

在 IP 中，服务质量（QoS）描述了用于为某些数据包提供优先级处理的机制，而不是其他人。 根据国际电信联盟（ITU）定义，QoS 包含连接的所有质量方面，包括延迟、丢失、信号比率、crosstalk、回声、中断、频率响应、loudness 级别等。 在数据包网络中，作为 QoS 的含义更准确地称为服务级别（CoS），重点是改善延迟、抖动和数据包丢失的性能，但我们将继续使用 QoS 术语，因为它更常用。
  
在 IP 网络调用中为两个主要组件提供 QoS：
  
- 在每个链接上为实时流量保留已定义的带宽量;如果实时流量不需要该带宽，则可以将其用于其他流量。 一般指南是应为语音流量分配任何链接的容量的30% 以上。
    
- 在标头中标记带有优先级指示器的数据包，告知路径中的交换机和路由器应分配的数据包的优先级。
    
当在交换机或路由器上接收到数据包时，它会被移动到下一条腿或跳跃的输出队列中。 不同的优先级级别有不同的输出队列。 交换机或路由器使用比低优先级队列更频繁地服务高优先级队列的算法。
  
挑战是，在第2层（即以太网或 Wi-fi 层）和第3层（即 IP 图层）上实现了不同的 QoS 技术。 可能必须在网络中的每个交换机和路由器以及网络与网络服务提供商网络之间的接口上配置这些不同的 QoS 实现。
  
可以通过两种方法将各种 Skype for Business 应用程序中的数据映射到相应的服务级别：
  
- 使用差分服务控制点（DSCP）标记流量的终结点 
    
- 基于网络访问控制列表（ACL）
    
### <a name="end-point-traffic-marking--differentiated-services-control-point-dscp"></a>终结点流量标记-差分服务控制点（DSCP）

差分服务（DiffServ）称为 "粗粒度" 机制，用于分类和管理网络流量以及在 IP 网络中提供 QoS。 实现第3层功能的路由器和其他设备使用 DiffServ 控制点（DSCP）定义数据包的优先级。 QoS 是通过在 "差分服务" 字段（以前称为 "服务类型" 字段）中插入6位 DSCP 值实现的;6位支持64不同优先级的级别。 优先级别的定义通常如下所示。
  
 **推荐的 DSCP 设置**
  
|**流量类**|**处理（DSCP 标记）**|**Skype for Business 工作负载**|
|:-----|:-----|:-----|
|**语音** <br/> |EF （46）  <br/> |Skype for Business 和 Lync 语音  <br/> |
|**交互式** <br/> |AF41 （34）  <br/> |视频  <br/> |
||AF21 （18）  <br/> |应用程序共享  <br/> |
|**Default** <br/> |AF11 （10）  <br/> |文件传输  <br/> |
||CS0 （0）  <br/> |别的东西  <br/> |
   
 **IP 版本4标题**
  
![IPv4 标头](../images/c8a6a714-2784-4328-8297-2e62706f302d.png)
  
### <a name="layer-2-qos-ieee-8021pwi-fi-multi-media-ieee-80211e"></a>第2层 QoS： IEEE 802.1 p/Wi-fi 多媒体（IEEE 802.11 e）

当 DSCP 是在第3层实现 QoS 的标准机制时，有线（即以太网）和无线（即 Wi-fi 网络）有不同的第2层 QoS 机制。 有线网络的 QoS 机制在 IEEE 802.1 p 标准中定义;WLAN QoS 机制在 IEEE 802.11 e 中定义，Wi-fi 联盟识别为 "Wi-fi 多媒体已认证" （WMM 已验证）。
  
IEEE 802.1 p 使用3位优先级代码点（PCP）来标识消息的优先级;PCP 是以太网头中的32位字段的一部分，它也携带 VLAN 标识符。 PCP 值的定义如下所示。
  
 **IEEE 802.1 p PCP 值**
  
|**PCP 值**|**优先级**|**缩略**|**流量类型**|
|:-----|:-----|:-----|:-----|
|7  <br/> |7  <br/> |NC  <br/> |网络控制  <br/> |
|6  <br/> |6  <br/> |收益  <br/> |互联网控件  <br/> |
|5  <br/> |5  <br/> |VO  <br/> |语音  <br/> |
|4  <br/> |4  <br/> |六  <br/> |视频  <br/> |
|3  <br/> |3  <br/> |认证  <br/> |关键应用程序  <br/> |
|2  <br/> |ppls-2  <br/> |EE  <br/> |出色的工作  <br/> |
|0  <br/> |1  <br/> |会  <br/> |最大努力  <br/> |
|1  <br/> |0  <br/> |博克马尔  <br/> |背景  <br/> |
   
在此情况下，IEEE 802.1 p 的实现方式与 DSCP 的实现方式非常相同，并且流量将分类分为不同优先级队列的不同优先级队列，但 Wlan 的共享媒体性质会调用不同的方法。 当访问点和客户将为不同的优先级级别维护不同的输出队列时，在无线电信道上发送帧的方式也有不同。
  
在 Wi-fi 网络中，所有与接入点相关联的客户共享一个半双工频道（即，一次只能发送一个客户端工作站或接入点）。 为了最大程度地减少无线电频道上发生冲突的可能性，在发送帧以使频道在指定时间段内被称为 "帧间距" 的情况下，如果频道占线，则会随机时间 period. 发送帧后，如果发件人未收到来自接收方的确认消息，则它会假定发生冲突或其他失败，并返回随机间隔，然后再尝试访问要重新发送的收音机频道。 后退间隔是随机的，以降低同一两个工作站再次发生冲突的可能性。
  
若要优先访问收音机通道，IEEE 802.11 e/WMM 为不同的流量类定义了称为 "仲裁内部帧 Spacings" （AFIS）和不同的后向范围的不同的预传输等待间隔。定义了四个称为 "访问类别" 的优先级级别。
  
通过向较高优先级的帧分配较短的 AFIS 值来为优先级提供。 因此，如果一台工作站正在等待发送语音帧，而另一台正在等待发送数据帧，则将始终首先发送语音帧。 从技术角度讲，语音和视频帧分配有相同的 AFIS 值，但视频帧的备份间隔范围更高。 因此，当语音和视频帧第一次发生冲突时，语音帧将始终更快地重新传输。 IEEE 802.1 p 和 IEEE 802.11 e 之间的相关性如下所示：
  
 **IEEE 802.11 e/Wi-fi 多媒体（WMM）到 802.1 P 映射**
  
|**WMM 访问类别**|**WMM 说明**|**802.1 p PCP 值**|**802.1 p 称号**|
|:-----|:-----|:-----|:-----|
|1（AC_VO）  <br/> |语音  <br/> |7（111）  <br/> |NC  <br/> |
|6（110）  <br/> |VO  <br/> |
|2（AC_VI）  <br/> |视频  <br/> |5（101）  <br/> |六  <br/> |
|4（100）  <br/> |CL  <br/> |
|3（AC_BE）  <br/> |最大努力数据  <br/> |3（011）  <br/> |EE  <br/> |
|0（000）  <br/> |会  <br/> |
|4（AC_BK）  <br/> |后台数据  <br/> |1（001）  <br/> |博克马尔  <br/> |
|2（010）  <br/> |---  <br/> |
   
第3层优先级的推荐关系如下所示：
  
 **推荐的第3层到第2层优先级关联**
  
||**第3层标记**|**第2层（PCP 值）**|**Wi-fi （Access 类别）**|
|:-----|:-----|:-----|:-----|
|网络控制  <br/> |每个跃点行为（PHB）-类选择器（CS）6  <br/> |6  <br/> |1（AC_VO）  <br/> |
|DSCP 值-48  <br/> |
|语音  <br/> |每个跃点行为（PHB）-加速转发（EF）  <br/> |5  <br/> |1（AC_VO）  <br/> |
|DSCP 值-46  <br/> |
|视频会议  <br/> |每个跃点行为（PHB）-确保转发（AF）41  <br/> |4  <br/> |2（AC_VI）  <br/> |
|DSCP 值-34  <br/> |
|呼叫信号  <br/> |每个跃点行为（PHB）-类选择器（CS）3  <br/> |3  <br/> |2（AC_VI）  <br/> |
|DSCP 值-24  <br/> |
|低延迟数据  <br/> |每个跃点行为（PHB）-确保转发（AF）21  <br/> |ppls-2  <br/> |3（AC_BE）  <br/> |
|DSCP 值-18  <br/> |
|高吞吐量数据  <br/> |每个跃点行为（PHB）-确保转发（AF）11  <br/> |1  <br/> |3（AC_BE）  <br/> |
|DSCP 值-10  <br/> |
|最大努力  <br/> |每个跃点行为（PHB）-0  <br/> |0  <br/> |4（AC_BK）  <br/> |
|DSCP 值-0  <br/> |
   
请务必注意 IEEE 802.1 p 和 WMM 的优先级编码中存在不匹配。 802.1 p 的 PCP 值为5，但是在标准对 WMM 的等价映射中，PCP 5 被转换为 Access 类别2，即视频的 WMM 访问类别（AC_VI）。 如果可能，应覆盖该映射，以便 PCP 5 转换为访问类别1，或者只是避免在同一 Wi-fi 网络上使用语音和视频，直到 Wi-fi 联盟解决此问题。 有关 Wi-fi 的其他信息，请参阅[Wi-fi 目录项]( https://go.microsoft.com/fwlink/?LinkId=690322)。
  
### <a name="implementing-qos-using-network-access-control-list-acl"></a>使用网络访问控制列表（ACL）实现 QoS

在 ExpressRoute 配置中实现 QoS 的另一种方法是使用网络访问控制列表（ACL）。 在该方法中，无需在每个数据包的标头中插入相应的 DSCP 标记，而是基于 UDP 源端口，则可以通过上游路由器完成标记。 所有交换机和路由器都必须配置为支持 QoS，以确保保持 DSCP 设置。 更重要的是，连接到服务提供商的网络的路由器必须在每个数据包的标头中保留 DSCP，因为该 DSCP 设置实质上是你向网络服务提供商说明如何处理该数据包的指令。
  
每个 Skype for Business 应用程序的推荐端口范围列在 "Lync Server 指南" 的 "[网络规划、监视和疑难解答](https://go.microsoft.com/fwlink/?LinkId=690286)" 一节2.6.1.1。 请务必与组织的各种 QoS 的整体做法协调，并且你应该针对不同 QoS 策略和潜在数据包 remarking 不匹配的 lookout。
  
尽管使用的是 QoS 和 MPLS 网络服务的主要原因是为实时语音和视频确保良好的用户体验，但同样的功能也可以应用于数据应用程序。 MPLS 网络不会同等地对待所有应用程序，而是允许组织将某些数据应用程序的优先级授予其他数据应用程序。 通过 MPLS，可将信用卡交易或屏幕共享等实时应用程序的优先级视为比电子邮件更少的时间敏感的流量。
  
### <a name="understanding-the-types-of-ip-network-services--basic-ip-and-mpls"></a>了解 IP 网络服务的类型-基本 IP 和 MPLS

在 "最大努力" 原则上运营的原始 IP 数据包转发。 这意味着，转发这些 IP 数据包的路由器最能将它们传送到其目的地，但对他们的目的地或他们的目的地而言绝对不能保证。 这就是如何使用基本的互联网服务，包括您的家庭互联网连接、今天的工作。 思路是，如果特定应用程序需要可靠性，它将在协议堆栈中更高级别提供。 可靠的传递机制是传输控制协议（TCP）。 用于实时语音和视频的用户数据报协议（UDP）是不可靠的（即 "最大努力"）交付机制。 
  
多协议标签交换（MPLS）是为网络服务提供商提供的一种方法，为网络服务提供商提供了一种可保证延迟、抖动和数据包丢失性能的 IP 服务。 为提供这些性能保证，MPLS 将从传统 IP 中提取一些 unpredictability。 首先，不是让每个数据包都能找到其目标的路由器到路由器的方式（这可能是因为每个数据包都采用不同的路由来源于目标），MPLS 将 "虚拟线路" 连接上的所有数据包路由到目标固定路由称为标签交换路径（LSP）。 如果该路径中的其中一个链接失败，则使用该链接的所有 Lsp 都将快速重新路由。
  
将数据包发送到 MPLS 网络时，网络服务提供商的边缘路由器会将一个附加报头追加到数据包中，该数据包包含用于将其转发到相应 LSP 的标签。 该标签由 MPLS 网络另一端的边缘路由器去除。
  
在简化转发过程的旁边，MPLS 提供的另一个优点是网络管理系统将知道在网络中的每个链接上传输了哪些连接。 通过控制流量通过网络路由的方式，运营商可以保证每个路径将提供的 QoS。 因此，与传统或基本 IP 的最佳操作性能不同，MPLS 操作员可以提供具有可预测性能的 IP 服务。 这种 LSP 还使得 MPLS 比传统的 Internet 服务本身更安全。 因此，使用基本 IP 服务，我们可以希望网络能够以更好的方式提供优质语音，并使用 FEC 和更具弹性的语音编码来提高机会，但通过使用 MPLS，我们可以确定。
  
MPLS 提供程序提供多种服务渐变类，这些渐变类很遗憾使用不同术语来标识它们。 你必须与你的提供商密切合作，确保他们理解[Lync 2010 和2013带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)中的输出以及不同 Office 365 实时工作负荷应用程序的推荐选项。
  
## <a name="conclusion"></a>结论

Skype for Business 增强了业务通信的开展方式。 Skype for business 可将所有这些功能放在一起，而不是将电话连接到 PBX、独立的视频会议系统、单独的电子邮件平台、音频会议的外部服务以及 IM 和联机状态的一些车辆在单个用户界面中。
  
统一提供实时的语音和视频服务，需要能够提供 QoS 的端到端网络基础结构。 这将包括局域网和 WAN 服务。 Microsoft 提供了诸如[Lync 2010 和2013带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)之类的工具，用于估计各种服务所需的网络容量。 此外，IT 专业人员工具计划中有合作伙伴[Skype For Business 解决方案： It 专业人员工具](https://go.microsoft.com/fwlink/?LinkID=690307)，可提供用于对网络基础结构进行预评估并支持监控、报告和疑难解答的工具。 如果没有正确调整大小和配置的网络基础结构，将面临使用 ExpressRoute Skype 企业版部署的风险，这些部署将无法满足你的用户对质量和一致性的预期。
  
有效的商业工具必须以稳定、一致的方式执行，并提供可鼓励用户采纳的用户体验。 从网络角度来看，让网络基础结构（包括本地和广域区域、固定和移动）能够允许发生这种情况。 规划、设计、实施和维护基础结构不一定是一种简单的特征。 目前可以完成的硬件、工具和网络服务，但 it 专业人员有责任确保他们能够以一种方式进行设计、实施和维护，以确保用户获得一组通信和协作服务让他们能够高效高效地工作，组织可以获得本技术所提供的全部好处。 
  
## <a name="related-topics"></a>相关主题

[ExpressRoute 文档](https://go.microsoft.com/fwlink/?LinkId=690285)

  
 