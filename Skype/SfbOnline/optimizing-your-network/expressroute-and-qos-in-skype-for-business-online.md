---
title: Skype for Business Online 中的 ExpressRoute 和 QoS
ms.author: tonysmit
author: tonysmit
manager: serdars
ms.reviewer: mpottier, dougand
ms.topic: article
ms.assetid: 20c654da-30ee-4e4f-a764-8b7d8844431d
ms.tgt.pltfrm: cloud
ms.service: skype-for-business-online
search.appverid: MET150
ms.collection: Adm_Skype4B_Online
audience: Admin
appliesto:
- Skype for Business
- Microsoft Teams
localization_priority: Normal
f1.keywords:
- NOCSH
ms.custom:
- Optimization
description: 'Learn about using Azure ExpressRoute to have a network with bandwidth requirements and Quality of Service capability for a business class user experience. '
ms.openlocfilehash: 3ff507dc3cca5e244f6545944d062e5e32dd6175
ms.sourcegitcommit: 01087be29daa3abce7d3b03a55ba5ef8db4ca161
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/23/2021
ms.locfileid: "51100738"
---
# <a name="expressroute-and-qos-in-skype-for-business-online"></a>Skype for Business Online 中的 ExpressRoute 和 QoS

使用适用于 Microsoft 365 或 Office 365 和 Skype for Business Online 的 Azure ExpressRoute 通过专用网络连接连接到 Microsoft 365 或 Office 365。 适用于 Skype for Business 应用的专用连接将为你提供可靠且可预测的性能，并且在公用 Internet 上也可保持隐私。 现在，你可以购买与 Microsoft 365 或 Office 365 和 Skype for Business Online 更好的网络连接，这增加了可预测性、商业类可靠性并附带运行时间 SLA。
  
> [!NOTE]
> 提供带宽计算器的新版本 [：Skype for Business、带宽计算器](https://go.microsoft.com/fwlink/?LinkId=715766)。 但是，本文档中的说明使用 Lync 2010 和 2013 带宽计算器。 
  
## <a name="skype-for-business-online-and-expressroute"></a>Skype for Business Online 和 ExpressRoute

与 Microsoft 的 ExpressRoute 合作伙伴合作，可以通过专用连接连接在云中连接各种 Microsoft 365 和 Office 365 应用程序，包括 Skype for Business Online。 但是，Skype for Business 实时语音和视频通信功能需要专门配置为支持这些 Microsoft 365 或 Office 365 实时工作负荷的网络服务。 这包括具有足够带宽承载所需的流量并且能够支持服务质量 (QoS) 来为用户提供企业级体验的网络。
  
此文档旨在帮助你、管理员和网络设计师了解支持实时通信所面临的特殊挑战、Microsoft 提供用于帮助你设计能够支持这些要求的网络的工具，并使用案例研究指导你完成设计过程。 
  
本文档的第一部分将引导你完成一个案例研究，帮助你进行网络设计，你可以使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkId=690282)估计大型、多网站 Skype for Business ExpressRoute 部署的网络要求。 本文档的第二部分介绍服务质量 (QoS) 的基本概念、有关支持 Skype for Business 实时通信的特定技术详细信息的深入剖析，以及需要的特定类型的网络服务。
  
下面的所有信息将为你提供 QoS 和 ExpressRoute 的技术详细信息和理解、你将面临的特殊挑战的理解，并介绍你在 Skype for Business 网络上成功部署 ExpressRoute 所需的工具和技术的实用知识。 
  
## <a name="getting-started"></a>入门

当你为 ExpressRoute for Skype for Business 做好准备时，最好查看不同的 ExpressRoute 连接模型以及合作伙伴和位置的各种选择，并了解在你的企业内如何购买和设置 ExpressRoute。 以下是一些帮助你入门的资源： 
  
- [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)
    
- [ExpressRoute 定价](https://go.microsoft.com/fwlink/?LinkId=690284)
    
- [ExpressRoute 文档](/azure/expressroute/)
    
## <a name="part-1-case-study---expressroute-for-dewey-law-llc"></a>第 1 部分：案例研究 - 面向 Dewey Law, LLC. 的 ExpressRoute

本 Dewey Law, LLC. 案例研究 介绍如何设置网络、订购网络访问服务并确定支持 ExpressRoute for Skype for Business Online 的带宽要求。
  
 **背景** Dewy Law LLC. 是国内一家大型的律师事务所，有 790 位律师，共有 5,580 名员工分布在 78 个地点。 该公司总部位于纽约，在芝加哥、旧金山和达拉斯有三个区域办事处，在国内很多区域还有 24 个大型和 50 个小型分支机构。 该公司处理大型复杂诉讼，工作通常涉及两个或更多办事处。 采用此网络设计可承载办事处之间相当大的网络流量。
  
Dewy Law LLC. 是一家相对年轻的公司，律师和其他职员非常熟悉技术，并且在很大程度上依赖它来处理日常工作。 
  
 **按位置和职位列出用户分布情况**
  
||**总部（纽约）**|**区域 办事处 (3)**|**大型 分支机构 (24)**|**小型 分支机构 (50)**|
|:-----|:-----|:-----|:-----|:-----|
|高级管理人员  <br/> |20  <br/> |10  <br/> |1  <br/> |1  <br/> |
|合作伙伴  <br/> |150  <br/> |50  <br/> |10  <br/> |5  <br/> |
|律师  <br/> |300  <br/> |100  <br/> |20  <br/> |10  <br/> |
|律师助理  <br/> |400  <br/> |125  <br/> |30  <br/> |15  <br/> |
|行政主管  <br/> |100  <br/> |35  <br/> |6  <br/> |3  <br/> |
|IT 和总务  <br/> |100  <br/> |25  <br/> |3  <br/> |2  <br/> |
|每个站点总计  <br/> |1,070  <br/> |345  <br/> |70  <br/> |36  <br/> |
|每个站点类别总计  <br/> |1,070  <br/> |1,035  <br/> |1,680  <br/> |1,800  <br/> |
   
### <a name="setting-up-the-network"></a>设置网络

为了为 Dewey Law LLC. 提供一致、高质量的实时服务，必须满足许多基本要求：
  
- 他们希望在出现电源故障时提供语音服务，因此其网络分布交换机和路由器必须通过以太网 (PoE) IEEE 802.3af 或 802.3at 供电。
    
- 网络交换机和路由器还必须使用不间断电源 (UPS)，这样就可以在发生电源故障期间继续运转。
    
    他们已Wi-Fi LAN 办公室建立连接，因此强烈建议他们使用 Skype for Business 解决方案Wi-Fi Skype for Business 基础结构 [合作伙伴](https://go.microsoft.com/fwlink/?LinkId=690281)。
    
    > [!TIP]
    >  [!提示] 建议使用 802.11n 和 802.11ac 无线接入点。
  
- 最重要的是，所有办事处中的所有 LAN 网络都必须设置为提供服务质量 (QoS)。 这包括电脑、笔记本电脑和任何网络硬件，如交换机和路由器。
    
在了解为 Dewey Law LLC. 提供企业级语音服务涵盖的基础知识之后，我们建议从将连接到 Azure ExpressRoute 服务的网络服务合作伙伴使用多协议标签交换 (MPLS) IP 服务。 MPLS 提供的 IP 服务可在发生延迟、抖动和数据包丢失情形时保证性能。 但是，如果 MPLS 不可用，也可以使用连接到我们的其中一个 ExpressRoute 数据交换合作伙伴的以太网。
  
MPLS 提供商提供许多服务类别级别，但是每个服务类别都使用不同的术语进行标识。 您必须与提供商密切合作，以确保他们了解您输入到 [Lync 2010 和 2013](https://go.microsoft.com/fwlink/?LinkID=690282) 带宽计算器的数据以及可用的选项，建议用于不同的 Microsoft 365 和 Office 365 实时工作负荷应用程序。
  
可以通过两种方法将 Skype for Business 应用中的数据映射到适当的 MPLS 服务类别：
  
- 使用 DiffServ 控制点 (DSCP) 标记流量的终结点
    
- 基于网络访问控制列表 (ACL)
    
若要实施终结点标记，你必须将 Dewey Law LLC 所有加入域的 Windows 计算机配置为 使用适当的 DiffServ 控制点 (DSCP) 标记来标记每个数据包，然后在所有办事处站点的所有网络交换机和路由器上实施 QoS，以确保 QoS 标记得到维护且不被删除。 网络数据包上的 DSCP 标记告知服务提供商如何区分网络数据包的优先次序。 **第 2 部分的 QoS 部分提供了有关 DSCP 的更多信息。**
  
对于基于网络 ACL 的分配，DSCP 优先级标记在上游路由器上实施，并且基于 UDP 源端口。 Lync Server 的网络规划、监视和故障排除的第 2.6.1.1 节中列出了每个应用程序 [的建议端口范围](https://go.microsoft.com/fwlink/?LinkId=690286)。 请务必根据 Dewey Law LLC 的总体 QoS 实施和设计进行协调，并意识到存在不同的 QoS 策略并且可能出现数据包标记不匹配的情况。
  
每个 ExpressRoute 网络服务提供商都有适合实时语音和视频的服务类别 (QoS)。 此 COS 对于语音称为"加速转发"(EF)，对视频称为"确保转发"(AF)。 你必须非常小心地确定面向语音 EF 流量购买的带宽量。 原因是当你发送的语音流量超过了为服务类别设置的值时，语音服务类别将非常严格。
  
> [!TIP]
>  [!提示] 超出服务提供商的承诺在语音服务类别上发送的任何流量将立即被丢弃，这将直接影响语音质量。
  
当查看 Dewey Law LLC 的总体设计时， 一定要准确地确定在网络上支持语音流量所需的网络带宽量，并使用语音的 DSCP 设置（如 DSCP EF 46）标记每个语音数据包（并且仅语音数据包），这极其重要。
  
若要跨企业网络实现 QoS，终结点或路由器必须使用相应的第 3 层优先级指示器（即 DSCP (）标记每个) 数据包。 在整个网络路径上，每个交换机和路由器都必须启用 QoS 选项。 如果仅有一个未启用 QoS 的网络交换机或路由器，则通过该交换机或路由器传递的语音或视频数据包上的 QoS 标记可能会被去除。 这样做会在所有下游交换机和路由器中有效地禁用 QoS，从而降低拥有 ExpressRoute 的价值。
  
这也要求在每个点上定义第 3 层和第 2 层 QoS 优先级的关联。 第 2 层优先级机制在 IEEE 802.1p（有线网络）和 802.11e/WMM（Wi-Fi 网络）中定义。 更重要的是，面向网络服务提供商的 MPLS 网络的网络路由器必须维护所有出站数据包上的 DSCP 设置，以便它们将保持合适的 MPLS 服务类别。 
  
> [!TIP]
>  有关 QoS 设置的具体详细信息，请参阅第 2.6 节 Lync Server 的网络规划、监视 [和故障排除]( https://go.microsoft.com/fwlink/?LinkId=760669)。 也可以查看[规划 Skype for Business 2015 的网络要求](../../SfbServer/plan-your-deployment/network-requirements/network-requirements.md)，了解更多网络规划要求。
  
### <a name="ordering-network-access-services"></a>订购网络访问服务

在准备好 QoS 网络必备组件和机制来支持 ExpressRoute 之后，下一步是下订单购买 ExpressRoute 网络访问服务。 当从 Microsoft 网络服务提供商合作伙伴为 Dewey Law LLC 订购 ExpressRoute 访问服务时，你需要提供以下两项：
  
- 将每个站点连接到 ExpressRoute 和 Microsoft 365 或 Office 365 所需的总带宽量。
    
- 支持在 Dewey Law LLC. 使用的 Skype for Business 应用所需的每个服务类别所需的总带宽量。 服务类别带宽要求受各种 Skype for Business 应用（如语音、视频、即时消息、状态和屏幕共享）的预期流量影响。
    
### <a name="determining-bandwidth-requirements-for-skype-for-business-applications"></a>确定 Skype for Business 应用的带宽要求

对于 Dewey Law LLC.，在确定所需的总带宽量之后，你现在需要知道如何在各种服务类别之间划分总带宽量。 例如，每种 Skype for Business 应用的带宽量。
  
若要确定每个 Dewey Law LLC. 站点 的这些要求，你将使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)。 此计算器是一个基于 Excel 的工具，允许你指定各种 Skype for Business 应用的预期使用，包括语音、视频、会议和屏幕共享。 计算器将自动生成带宽估计值和其网络上的每个站点的 CoS 要求。 当你下载 Lync 2010 和 2013 带宽计算器时，还将下载一份用户指南，它将为你提供有关使用该工具的详细信息。 
  
为帮助你使用电子表格，电子表格中的各个单元格均用彩色标记：
  
- **绿色** 这些是常规的数据输入区域。
    
- **黄色** 这些是高级数据输入区域。 你可以更改这些设置，但务必小心谨慎。
    
- **红色** 这些是只读区域，输入值被锁定，不可更改。
    
- **灰色** 这些是只显示区域。 它们是来自常规输入区域的结果或数据。
    
Dewey Law LLC. 的设计过程 首先是根据用户的特征设定不同的"角色"。对于你定义的每种角色，你可以指定各种 Skype for Business 应用的预期使用（"无"、"低"、"中"、"高"或三个已定义的"自定义"设置之一）。 可在"角色"工作表中找到这些选项。 提供了每个选项的具体用法（"低"、"中"或"高"），但可以更改每个选项的默认值。 通过确定位于每个站点的每种角色的用户数量，计算器可以计算每个位置所需的总带宽量。
  
你也可以指定所使用的音频和视频编解码器、是否使用前向纠错以及将影响带宽要求的其他系统参数。 你可以使用 Lync 2010 和 2013 带宽计算器中的默认设置，也可以选择不同的编解码器和其他系统参数。 对于 Dewey Law LLC. 的站点设计，可以使用默认设置。 但是，要更改任何默认设置，可以使用下拉菜单中的所有可用选项。 "编解码器"工作表中包含用于每个选项的带宽。 当你更改任何设置时，每个站点的带宽和服务类别 (CoS) 混合更改会更新。 借助此功能，你可以测试不同的潜在配置并查看所做的更改对带宽要求的影响。
  
我们已为 Dewey Law LLC. 定义了三种角色："高级管理人员/合作伙伴"、"律师/律师助理"和"IT 管理员"。 下表介绍了我们是如何为每种角色的各种 Skype for Business 应用设置使用配置文件的。
  
 **角色和使用配置文件（"角色"工作表 - 列 A 到 P）**
  
|**角色**|**IM/状态**|**P2P 音频**|**P2P 视频**|**会议音频**|**会议视频**|**桌面共享**|**音频会议**|**Lync 2010 RTV 类型**|**远程用户**|**Lync 2013 立体声音频**|**Lync 2013 视频质量**|**Lync 2013 P2P 视频窗口的用户行为**|**Lync 2013 多视图使用**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|高级管理人员/ 合作伙伴  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |中  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |最佳  <br/> |典型  <br/> |典型  <br/> |
|律师/ 律师助理  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |高  <br/> |高  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
|IT 管理员  <br/> |高  <br/> |中  <br/> |无  <br/> |低  <br/> |无  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
   
你需要在 **按位置和职位列出用户分布情况** Lync 2010 和 2013 带宽计算器的"站点"工作表中的上述表中输入信息。 当区域办事处的用户数相同时，它们被定义为一个"站点"并指定存在三个实例。 此行为也适用于大型和小型分支机构，站点中分别有 24 个和 50 个用户。
  
在指定每种角色的设置后，你需要在"站点"工作表中输入每个站点每种角色的用户数。 所有站点的用户总数会自动更新。 由于 Microsoft 365 或 Office 365 位置没有用户，因此应全部在工作表的"分支"行中输入。 然后，Lync 2010 和 2013 带宽计算器会填充"尽力而为类别"、"数据流量类别"和"实时流量类别"列。 这显示在下表的数据中。
  
> [!TIP]
>  [!提示] 完整的电子表格还包括每种应用的最大并发会话数，但我们为节省空间删除了这些列。
  
 **站点的角色 -（"站点"工作表 - 列 A、D、I 和 AI 至 AX）**
  
|**站点名称**|**站点中的用户总数**|**相似的站点总数**|**用户配置文件 1**|**配置文件 1 的用户数**|**用户配置文件 2**|**配置文件 2 的用户数**|**用户配置文件 3**|**配置文件 3 的用户数**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |1  <br/> |执行经理/合作伙伴  <br/> |170  <br/> |律师/律师助理  <br/> |700  <br/> |IT 管理员  <br/> |200  <br/> |
|地区办事处  <br/> |345  <br/> |3  <br/> |执行经理/合作伙伴  <br/> |60  <br/> |律师/律师助理  <br/> |225  <br/> |IT 管理员  <br/> |60  <br/> |
|大型分支机构  <br/> |70  <br/> |24  <br/> |执行经理/合作伙伴  <br/> |11  <br/> |律师/律师助理  <br/> |50  <br/> |IT 管理员  <br/> |9  <br/> |
|小型分支机构  <br/> |36  <br/> |50  <br/> |执行经理/合作伙伴  <br/> |6  <br/> |律师/律师助理  <br/> |25  <br/> |IT 管理员  <br/> |1  <br/> |
   
 **站点中每种应用所需的带宽（以 Kbps 为单位） （"站点"工作表 - 列 A 和 BQ 至 LF）**
  
|**站点**|**SIP/IM 带宽峰值**|**站点间对等音频带宽峰值**|**站点间对等视频带宽峰值**|**音频会议带宽峰值**|**视频会议带宽峰值**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |525.30  <br/> |560.00  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |
|地区办事处  <br/> |345  <br/> |185.40  <br/> |560.00  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |
|大型分支机构  <br/> |70  <br/> |92.70  <br/> |560.00  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |
|小型分支机构  <br/> |36  <br/> |119.40  <br/> |560.00  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |
   
电子表格中最重要的列可能是描述 QoS 类别的 WAN 带宽的那些列。如下表所示。此数据总结了你在每个站点订购访问连接时需要向网络服务提供商提供的信息。当计算总的带宽时，请记得将每种类型的分支站点的带宽乘以相同类型的站点数。要与你的 ExpressRoute 网络服务合作伙伴进行连接，你可以参阅 [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)。
  
在 EF 服务类中不要超过语音或"加速转发" () 这一点非常重要。 将丢弃一组随机数据包，因此，所有进行中的调用都可能会受到影响，而不是降低单个调用或一组调用的质量。 此外，必须仅使用 EF 的 DSCP 标记语音 (即 DSCP = 46) 否则添加非语音流量时语音队列可能会溢出。
  
> [!TIP]
>  同样，尽管 EF 服务类提供最佳性能保证，但如果超过定义的带宽，将立即丢弃任何其他数据包。
  
 **按 QoS 流量类别聚合每个站点的带宽 - (的工作表 - 列 A 和 ML 通过 MR)**
  
|**站点名称**|**DSCP 0 (尽力而为)**|**数据流量类 (DSCP 自定义)**|**DSCP 34、AF41 (实时流量)**|**优先级流量类别 (DSCP 46、EF)**|
|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |0.00  <br/> |5764.80  <br/> |3200.00  <br/> |3953.10  <br/> |
|地区办事处  <br/> |0.00  <br/> |2033.60  <br/> |1880.00  <br/> |1336.50  <br/> |
|大型分支机构  <br/> |0.00  <br/> |486.40  <br/> |1160.00  <br/> |411.00  <br/> |
|小型分支机构  <br/> |0.00  <br/> |438.40  <br/> |1160.00  <br/> |319.50  <br/> |
   
### <a name="putting-your-plan-into-action"></a>实施计划

可以使用上述"每个站点每个应用程序"表中的带宽估计值计算将遍历 WAN 的总带宽和将遍历 ExpressRoute 的 **带宽量。** 遍历 ExpressRoute 的流量部分不包括站点间的对等带宽。

 
|**站点**|**SIP/IM 带宽峰值**|**音频会议带宽峰值**|**视频会议带宽峰值**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|**每个站点类的 ExpressRoute 流量 (，即每个站点 <br/> <br/> <br/> 的总)**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|**总部** <br/> |1,070  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |11361.80  <br/> |
|**地区办事处** <br/> |345  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |8704.20  <br/> |
|**大型分支机构** <br/> |70  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |32935.20  <br/> |
|**小型分支机构** <br/> |36  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |61005.00  <br/> |
   
这意味着将遍历快速路由的 Skype for Business Online 流量大约为 114 Mbps，因此 Dewey 至少需要 ExpressRoute 的 200 Mbps 订阅。 可以在不同的 ExpressRoute 对等互连位置购买多个 ExpressRoute 线路。 如果 Dewey 的站点位于不同的地理区域，或者为了在连接到 ExpressRoute 线路失败时提供复原能力，建议这样做。 如果在多个 Azure 区域购买 ExpressRoute 线路，需要 ExpressRoute 高级版附加组件才能通过 ExpressRoute 接收全局连接。
  
现在，你已拥有所需的总带宽量和服务类别 (CoS) 带宽数字，你可以向选定的网络服务提供商 (下订单) 。 不要忘记包括其他应用程序和服务的流量估计值。 我们针对其他 Microsoft 365 和 Office 365 服务（包括 Exchange 和 OneDrive 的带宽计算器）提供网络规划指南。 网络服务提供商的带宽订阅会更高，因为需要重新添加站点内部流量。 Lync 2010 和 2013 带宽计算器仅提供预期流量的估计值，因此建议确认网络是否支持该流量进行压力测试。 
  
> [!TIP]
> 执行网络预评估时，强烈建议对网络进行压力测试。 
  
压力测试涉及构建和配置基础结构，然后在监视性能的同时，使用预期数量模拟流量运行它。 在某些情况下，流量估计可能不准确，但至少您可以确保它可以支持 Lync 2010 和 2013 带宽计算器预测的流量。 建议运行压力测试至少几天，但长时间运行它有助于优化数字。 但是，必须权衡延长压力测试期与未携带实际用户网络流量的网络服务的成本。 Microsoft 已认证许多供应商作为 IT 专业人员工具计划的一部分，以提供网络管理和操作工具，包括网络预评估压力工具。 Skype for Business 还提供系统集成商 (SI) ，它可以接受经过认证的 IT 专业人员工具，并可以代你进行网络评估。 可以在 Skype [for Business 解决方案：IT 专业人员工具 中查看更多信息](https://go.microsoft.com/fwlink/?LinkID=690307)。
  
压力测试提供了一些保证，即网络可以支持所需的流量，但实际上 Lync 2010 和 2013 带宽计算器数据可能出于任何原因关闭。 你还应考虑在部署站点网络后，通过持续进行网络评估来继续监视站点网络，以确保带宽足以确保 QoS 机制正常运行。 随着越来越多的真实用户上线，继续监视网络性能非常重要。
  
## <a name="part-2-expressroute-skype-for-business-qos"></a>第 2 部分：ExpressRoute Skype for Business QoS

Microsoft 的 ExpressRoute 服务提供与 Azure 云的专用连接，但 Office 365 实时工作负荷的通信服务需要具有足够带宽的网络服务来承载流量，并且能够支持服务质量 (QoS) 以提供企业级用户体验。 必须配置支持 QoS 的端到端 (电脑、网络交换机和路由器到云) 因为路径中无法支持 QoS 的任何部分可能会降低整个呼叫的质量。
  
本部分的目的是帮助你了解在使用 Microsoft 的 ExpressRoute Exchange 提供商或网络服务提供商合作伙伴支持 IP 网络中的实时流量，以及配置和支持 Microsoft 365 或 Office 365 实时工作负荷的成功 ExpressRoute 部署时的挑战。
  
QoS 仅通过 ExpressRoute 网络线路从网络接受，在 Microsoft 网络中用于 Skype for Business 流量。 目前，Microsoft 的部分出站连接缺少 Skype for Business 的 DSCP 值。 在使用 DSCP 值完全标记出站流量之前，建议遵循本文使用网络访问控制列表 (ACL) 实现 QoS 部分中所述，将 **QoS** 标记添加到网络边界上的流量。
  
### <a name="the-real-time-problem"></a>实时问题

提供业务质量的语音和视频服务对 IP 网络有特殊要求。 实时流量使用实时传输协议 (RTP) UDP 协议 (传输) 。 与传输控制协议 (TCP) ，它编号和测试每条消息的错误，并包含用于检测和重新传输丢失或出错消息的其他机制，UDP 不提供此类型的可靠性。 如果消息因错误而损坏或由于缓冲区溢出而丢失，则消息会丢失。 之所以选择 UDP 与 RTP 一同使用，是因为实时流量的性质是，即使重新发送丢失的消息，它们也会到达得过晚，对语音消息流产生任何积极的影响。
  
在了解丢失的语音数据包的影响后，设计人员通过两种方法改进了 IP 上语音和视频的性能：
  
- 使语音编码/解码在数据包丢失时更具复原能力。 为此，可以使用转发错误更正 (FEC) 来更正遇到的错误的百分比，这是 Microsoft 365 或 Office 365 实时传输中的一项功能，或者通过设计语音解码系统来尝试屏蔽丢失数据包的影响（这是 Microsoft 编解码器的特征）。 
    
- 使用使用服务质量机制的传输服务来保证网络在延迟、数据包丢失和抖动方面的性能，以及数据包之间的延迟变化。
    
弹性语音编码仅解决数据包丢失问题，因此，用于传输实时语音和视频的网络具有最小化延迟和抖动的机制非常重要。 即使使用弹性编码，如果丢失了太多数据包，接收站也没有足够的信息来重新构造可识别的语音信号版本。 丢失的数据包百分比，会导致语音质量明显下降，具体取决于所使用的语音编码技术。 但是，在许多情况下，丢失连续数据包的字符串是非常有问题的。
  
最小化延迟非常重要，因为过长延迟可能会影响聊天流，给说话人带来麻烦。 最佳做法告诉我们，语音语音的端到端延迟 (我们称其为"口对耳"延迟) 必须低于 150 毫秒 (毫秒) 。 单向，而不是"往返"延迟。 当然，考虑到传播延迟或信号通过电缆实际传输所花的时间，较长的传输链路（如跨海链路）上的延迟会增加。
  
当延迟高于 150 毫秒时。 单向，它对于扬声器有一种奇怪的效果。 好在，扬声器的大脑中会关闭时钟，这让他们认为收件人尚未听到他们的声音，并重复他们最后一次说话。 这与来自远端的响应延迟冲突。 如果你曾通过卫星频道说话，你将识别此效果。 通过卫星通道，单向延迟大约为 250 毫秒，这远超出允许的延迟。
  
 **企业级语音的建议网络参数**
  
|**参数**|**建议的值**|
|:-----|:-----|
|到达间数据包抖动 (平均)   <br/> |≤ 5 毫秒  <br/> |
|到达间数据包抖动 (最大)   <br/> |≤ 40 毫秒  <br/> |
|数据包丢失率 (平均)   <br/> |接近 0%  <br/> |
|单向网络延迟  <br/> |≤ 100 毫秒 (应包括对延迟与地理距离的)   <br/> |
   
### <a name="expressroute-as-part-of-a-business-grade-voice-network"></a>ExpressRoute 作为企业级语音网络的一部分

ExpressRoute 通过网络服务提供商 (NSP) 或 Exchange 提供商 (EXP) 3 个连接选项之一提供专用连接： 
  
- 云 Exchange 托管
    
- 点到点以太网连接
    
- IPVPN 连接 (任意) 连接
    
这提供了高可用性 (99.9% 运行时间 SLA) 和可靠的路由（无 Internet 传输)  (，不受 Internet 流量变化的影响）的可依赖路由，并且下面) 介绍了服务质量标记来区分流量的优先级 (QoS。 ExpressRoute 以及计划周全的 WAN 可以提供企业级语音网络。
  
如果混合拓扑与线路 (，可以使用 ExpressRoute 从) 数据中心传输数据。 场外用户的数据 (例如，来自家庭办公室或出差等) 不会利用 ExpressRoute 线路，除非用户已连接 VPN，且无需包括在带宽估计中，以便调整 ExpressRoute 线路大小。 如果你是一个跨区域客户，可以在每个区域购买 ExpressRoute 线路，并使用 BGP 社区标记来通知路由规则，以便流量定向到首选 ExpressRoute 线路 (通常是每个站点) 最靠近的线路，而其他线路在影响单个线路的中断时提供冗余。 
  
### <a name="if-expressroute-isnt-an-option"></a>如果 ExpressRoute 不是选项

由于成本、无法满足 ExpressRoute 先决条件或当前 NSP 的限制，可能无法将所有站点连接到 ExpressRoute。 如果无法使用 ExpressRoute，仍建议遵循以下指南在网络中标记 QoS，并计划与 NSP 之间的合同，以确保有足够的带宽和支持，以基于 QoS 确定流量优先级。
  
此外，如果办公室位于多个区域，但所有区域没有 ExpressRoute 线路，在配置与卫星办事处之间流量的路由时，应该使用区域 BGP 社区标记，以避免不必要的长距离传输。 例如，假设有一家公司在美国托管 Skype for Business Online 组织，但在欧洲设有分支机构，并且该公司在硅谷只有一条 ExpressRoute 线路。 大多数 Skype for Business Online 流量将路由到组织托管的数据中心 (例如，大多数流量可能首选使用 ExpressRoute 线路与公司) 中的其他用户进行电话会议。 但是，如果欧洲用户要加入由其组织位于欧洲的另一家公司主持的电话会议，则该呼叫中的媒体目标将是第二家公司所在的欧洲数据中心。 通过硅谷的 ExpressRoute 线路路由流量比通过 Internet 进行路由的直接路由要少。 在这种情况下，可能需要在网络内配置路由器 (例如，在欧洲办公室) ，在制定路由规则时检查社区标记，并针对具有欧洲区域标记的流量通过 Internet 而不是硅谷 ExpressRoute 线路进行路由。
  
### <a name="basic-concepts-of-quality-of-service-qosclass-of-service-cos"></a>基于 CoS 的服务质量 (QoS) /服务 (的) 

在 IP 中，服务质量 (QoS) 描述了用于为某些数据包提供优先级处理（优先于其他数据包）的任何机制。 根据国际电信联盟 (或) 的定义，QoS 包括连接的所有质量方面，包括延迟、丢失、信噪比、交叉声、回声、中断、频率响应、音量级别等。 在数据包网络中我们称 QoS 的术语更正确，即服务类别 (CoS) ，侧重于改进延迟、抖动和数据包丢失的性能，但我们将继续使用 QoS 术语，因为它更常用。
  
在 IP 网络调用中为两个主要组件提供 QoS：
  
- 为实时流量在每个链接上保留定义的带宽量;如果实时流量不需要该带宽，则它可用于其他流量。 一般指南是，不应为语音流量分配超过 30% 的任何链接容量。
    
- 在标头中用优先级指示器标记数据包，告知路径中的交换机和路由器应分配的数据包的优先级。
    
当在交换机或路由器上收到数据包时，该数据包将移到下一个段或跃点的输出队列。 不同优先级有不同的输出队列。 交换机或路由器使用的算法为高优先级队列提供服务的频率高于低优先级队列。
  
挑战在于，第 2 层 (（即以太网或 Wi-Fi 层) ）和第 3 层（即) IP 层） (实现了不同的 QoS 技术。 这些不同的 QoS 实现可能需要在网络的每个交换机和路由器以及网络与网络服务提供商的网络之间的接口中配置。
  
有两个选项可用于如何将各种 Skype for Business 应用程序的数据映射到相应的服务类：
  
- 使用不同服务控制点和 DSCP (流量的)  
    
- 基于 ACL 的网络 (列表) ACL
    
### <a name="end-point-traffic-marking--differentiated-services-control-point-dscp"></a>终点流量标记 - DSCP (区分的服务) 

差异服务 (DiffServ) 称为"粗糙粒度"机制，用于对网络流量进行分类和管理，以及提供 IP 网络的 QoS。 路由器和执行第 3 层功能的其他设备使用 DiffServ 控制点 (DSCP) 定义数据包的优先级。 QoS 的实现方法为：在"区分服务"字段中插入 6 位 DSCP 值 (以前在 IP 标头中插入"服务) "字段;6 位允许 64 种不同的优先级级别。 优先级级别通常按此处所示进行定义。
  
 **建议的 DSCP 设置**
  
|**流量类**|**处理 (DSCP 标记)**|**Skype for Business 工作负荷**|
|:-----|:-----|:-----|
|**语音** <br/> |EF (46)   <br/> |Skype for Business 和 Lync 语音  <br/> |
|**交互式** <br/> |AF41 (34)   <br/> |视频  <br/> |
||AF21 (18)   <br/> |应用程序共享  <br/> |
|**Default** <br/> |AF11 (10)   <br/> |文件传输  <br/> |
||CS0 (0)   <br/> |别的东西  <br/> |
   
 **IP 版本 4 标头**
  
![IPv4 标头](../images/c8a6a714-2784-4328-8297-2e62706f302d.png)
  
### <a name="layer-2-qos-ieee-8021pwi-fi-multi-media-ieee-80211e"></a>第 2 层 QoS：IEEE 802.1p/Wi-Fi (IEEE 802.11e) 

虽然 DSCP 是在第 3 层实现 QoS 的标准机制，但有线 (（即以太网) 和无线 (即 Wi-Fi 网络) ）有不同的第 2 层 QoS 机制。 有线网络的 QoS 机制在 IEEE 802.1p 标准中定义;WLAN QoS 机制在 IEEE 802.11e 中定义，Wi-Fi Alliance 标识为"Wi-Fi 多媒体认证"， (WMM) 。
  
IEEE 802.1p 使用 3 位优先级代码点 (PCP) 标识消息的优先级;PCP 是以太网标头中也包含 VLAN 标识符的 32 位字段的一部分。 下面包含 PCP 值的定义。
  
 **IEEE 802.1p PCP 值**
  
|**PCP 值**|**优先级**|**首字母缩略词**|**流量类型**|
|:-----|:-----|:-----|:-----|
|7  <br/> |7  <br/> |NC  <br/> |网络控制  <br/> |
|6  <br/> |6  <br/> |IC  <br/> |Internetwork 控件  <br/> |
|5  <br/> |5  <br/> |VO  <br/> |语音  <br/> |
|4  <br/> |4  <br/> |VI  <br/> |视频  <br/> |
|3  <br/> |3  <br/> |CA  <br/> |关键应用程序  <br/> |
|2  <br/> |2  <br/> |EE  <br/> |出色的努力  <br/> |
|0  <br/> |1  <br/> |BE  <br/> |尽力而为  <br/> |
|1  <br/> |0  <br/> |BK  <br/> |背景  <br/> |
   
其中 IEEE 802.1p 的实现方式与 DSCP 的实现方式相同，流量按每个优先级级别排序到不同的优先级队列，但 WLAN 的共享媒体性质会调用不同的方法。 虽然接入点和客户端将为不同的优先级级别维护单独的输出队列，但帧在无线电通道上的发送方式也有所不同。
  
在 Wi-Fi 网络中，与接入点关联的所有客户端共享一个半双工通道 (即一次只能发送一个客户端工作站或接入点) 。 为了尽量减少无线电信道上发生冲突的可能性，在发送帧之前，工作站将等待通道处于空闲状态一段定义的时间（称为"帧间间距"）。如果频道在站发送时正忙，则它返回随机时间段。 发送帧后，如果发送方未收到来自接收方的确认消息，则假定发生了冲突或其他故障，它会在尝试访问无线电通道以重新发送之前后退随机间隔。 退让间隔是随机的，以降低相同的两个工作站再次碰撞的概率。
  
为了优先访问无线电通道，IEEE 802.11e/WMM 定义了不同的预传输等待时间间隔，称为"仲裁的 Inter-Frame 间距" (AFIS) 以及不同流量类的不同退让范围;定义了四个优先级级别，称为"访问类别"。
  
通过向较高优先级帧分配较短的 AFIS 值来指定优先级。 因此，如果一个工作站正在等待发送语音帧，而另一个站正在等待发送数据帧，则始终先发送语音帧。 从技术上说，为语音和视频帧分配了相同的 AFIS 值，但视频帧的退信间隔范围更高。 因此，当第一次尝试时语音和视频帧可能发生冲突时，始终会尽快重新传输语音帧。 IEEE 802.1p 与 IEEE 802.11e 之间的关联如下所示：
  
 **IEEE 802.11e/Wi-Fi 多媒体 (WMM) 到 802.1P 映射**
  
|**WMM 访问类别**|**WMM 说明**|**802.1P PCP 值**|**802.1P 标志**|
|:-----|:-----|:-----|:-----|
|1 (AC_VO)   <br/> |语音  <br/> |7 (111)   <br/> |NC  <br/> |
|6 (110)   <br/> |VO  <br/> |
|2 (AC_VI)   <br/> |视频  <br/> |5 (101)   <br/> |VI  <br/> |
|4 (100)   <br/> |CL  <br/> |
|3 (AC_BE)   <br/> |尽力而为的数据  <br/> |3 (011)   <br/> |EE  <br/> |
|0 (000)   <br/> |BE  <br/> |
|4 (AC_BK)   <br/> |后台数据  <br/> |1 (001)   <br/> |BK  <br/> |
|2 (010)   <br/> |---  <br/> |
   
建议将第 3 层优先级与第 2 层优先级关联如下所示：
  
 **建议第 3 层到第 2 层优先级关联**
  
||**第 3 层标记**|**第 2 (PCP 值)**|**Wi-Fi (访问类别)**|
|:-----|:-----|:-----|:-----|
|网络控制  <br/> |按跃点行为 (PHB) - 类选择器 (CS) 6  <br/> |6  <br/> |1 (AC_VO)   <br/> |
|DSCP 值 -48  <br/> |
|语音  <br/> |按跃点行为 (PHB) -加速转发 (EF)   <br/> |5  <br/> |1 (AC_VO)   <br/> |
|DSCP 值 - 46  <br/> |
|视频会议  <br/> |按跃点行为 (PHB) - 确保转发 (AF) 41  <br/> |4  <br/> |2 (AC_VI)   <br/> |
|DSCP 值 - 34  <br/> |
|调用信号  <br/> |按跃点 (PHB) - 类选择器 (CS) 3  <br/> |3  <br/> |2 (AC_VI)   <br/> |
|DSCP 值 - 24  <br/> |
|低延迟数据  <br/> |按跃点行为 (PHB) -确保转发 (AF) 21  <br/> |2  <br/> |3 (AC_BE)   <br/> |
|DSCP 值 -18  <br/> |
|高吞吐量数据  <br/> |按跃点行为 (PHB) - 确保转发 (AF) 11  <br/> |1  <br/> |3 (AC_BE)   <br/> |
|DSCP 值 - 10  <br/> |
|尽力而为  <br/> |按跃点行为 (PHB) - 0  <br/> |0  <br/> |4 (AC_BK)   <br/> |
|DSCP 值 - 0  <br/> |
   
必须注意，IEEE 802.1p 和 WMM 的优先级编码不匹配。 802.1p 语音的 PCP 值为 5，但在标准等效映射到 WMM 时，PCP 5 将转换为访问类别 2，即视频的 WMM 访问 (AC_VI) 。 如果可能，你应该覆盖该映射，以便 PCP 5 转换为 Access 类别 1，或者直接避免在同一 Wi-Fi 网络上使用语音和视频，直到 Wi-Fi Alliance 解决此问题。 有关 Wi-Fi 的其他信息，请参阅 [Wlan 目录项]( https://go.microsoft.com/fwlink/?LinkId=690322)。
  
### <a name="implementing-qos-using-network-access-control-list-acl"></a>使用网络访问控制列表和 ACL (QoS) 

在 ExpressRoute 配置中实现 QoS 的另一方法是使用网络访问控制列表 (ACL) 。 在这种方法中，上游路由器可以基于 UDP 源端口完成标记，而不是让终点在每个数据包的标头中插入相应的 DSCP 标记。 所有交换机和路由器仍必须配置为支持 QoS，以确保维护 DSCP 设置。 更重要的是，连接到服务提供商网络的路由器必须在每个数据包的标头中维护 DSCP，因为 DSCP 设置实质上是向网络服务提供商指示如何处理该数据包。
  
Lync Server 网络规划、监视和故障排除指南的第 2.6.1.1 部分列出了每个 Skype for Business 应用程序的建议 [端口](https://go.microsoft.com/fwlink/?LinkId=690286) 范围。 这必须协调组织对 QoS 的整体方法，并且你应该注意不同的 QoS 策略和潜在的数据包备注不匹配。
  
尽管使用 QoS 和 MPLS 网络服务的主要原因是确保获得良好的实时语音和视频用户体验，但这些功能也可以应用于数据应用程序。 MPLS 网络可以允许组织优先处理某些数据应用程序，而不是同等对待所有应用程序。 使用 MPLS 时，实时应用程序（如信用卡交易或屏幕共享）可以优先于电子邮件等时间敏感型流量。
  
### <a name="understanding-the-types-of-ip-network-services--basic-ip-and-mpls"></a>了解 IP 网络服务的类型 - 基本 IP 和 MPLS

原始 IP 数据包转发以"尽力而为"的原则运行。 这意味着转发这些 IP 数据包的路由器将尽力将其发送到其目标，但绝对无法保证它们何时到达或是否到达目的地。 这就是基本的 Internet 服务（包括家庭 Internet 连接）目前如何工作。 其思路是，如果特定应用程序需要可靠性，则它将在协议堆栈中提供更高的级别。 可靠的传送机制是 TCP 传输 (协议) 。 用户数据报协议 (UDP) （用于实时语音和视频）是不可靠的 (，即"尽力而为") 机制。 
  
多协议标签 (MPLS) 是网络服务提供商提供 IP 服务，保证延迟、抖动和数据包丢失的一种途径。 为了提供这些性能保证，MPLS 从传统 IP 中排除一些不可预测性。 首先，MPLS 使用名为标签切换路径 (LSP) 的固定路由将"虚拟线路"连接上的所有数据包路由到"虚拟线路"连接上的所有数据包，而不是让每个数据包找到其路由器到路由器到目标 (的结果，其结果可能是每个数据包采用不同的路由到目标) 。 如果该路径中的一个链接失败，使用该链接的所有 LSP 都快速重新路由。
  
将数据包发送到 MPLS 网络时，网络服务提供商的边缘路由器将附加一个标头追加到数据包，其中包括用于通过相应 LSP 转发该数据包的标签。 该标签被 MPLS 网络另一端的边缘路由器去除。
  
除了简化转发过程外，MPLS 提供的另一个优势是，网络管理系统将知道网络中每个链路上携带了哪些连接。 通过控制通过网络路由流量的方式，操作员可以保证每个路径将提供 QoS。 因此，与传统或基本 IP 的最佳性能不同，MPLS 操作员可以提供具有可预测性能的 IP 服务。 该 LSP 还使 MPLS 本身比传统 Internet 服务更安全。 因此，对于基本 IP 服务，我们可以希望网络性能足以提供高质量的语音，并使用 FEC 等技术以及复原能力更强的语音编码来提高机率，但通过使用 MPLS，我们可以确信这一点。
  
MPLS 提供商提供了多种服务渐变，遗憾的是，这些渐变使用不同的术语来标识它们。 您必须与提供商密切合作，确保他们了解 [Lync 2010 和 2013](https://go.microsoft.com/fwlink/?LinkID=690282) 带宽计算器的输出，以及适用于不同 Microsoft 365 或 Office 365 实时工作负荷应用程序的建议选项。
  
## <a name="conclusion"></a>结论

Skype for Business 增强了进行业务通信的方式。 Skype for Business 可以将所有这些功能汇集在一个用户界面中，而不是让电话连接到 PBX、独立的视频会议系统、用于电子邮件的单独平台、音频会议外部服务和一些 IM 和状态工具。
  
持续提供企业级实时语音和视频服务需要能够提供 QoS 的端到端网络基础结构。 这包括 LAN 和 WAN 服务。 Microsoft 提供 [Lync 2010 和 2013](https://go.microsoft.com/fwlink/?LinkID=690282) 带宽计算器等工具来估计各种服务所需的网络容量。 此外，IT 专业人员工具计划 [Skype for Business 解决方案：IT 专业人员](https://go.microsoft.com/fwlink/?LinkID=690307) 工具也有合作伙伴，它们提供用于预先评估网络基础结构的工具，并支持监视、报告和故障排除。 如果没有正确调整规模和配置的网络基础结构，则存在 ExpressRoute Skype for Business 部署不符合用户对质量和一致性的期望的风险。
  
有效的业务工具必须可靠、一致地执行，并提供鼓励用户采用的用户体验。 从网络角度来看，这意味着有一个网络基础结构（包括本地和广区域、固定和移动）可以允许这种情况发生。 规划、设计、实施和维护基础结构并不总是一项轻松的事情。 目前提供硬件、工具和网络服务来实现这一点，但 IT 专业人员有责任确保它们的设计、实施和维护方式能确保用户获得一组通信和协作服务，以便他们高效工作，并且组织可以充分利用此技术所提供的功能。 
  
## <a name="related-topics"></a>相关主题

[ExpressRoute 文档](/azure/expressroute/)

  
