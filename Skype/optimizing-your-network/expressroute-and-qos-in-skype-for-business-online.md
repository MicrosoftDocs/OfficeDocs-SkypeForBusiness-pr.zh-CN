---
title: "Skype for Business Online 中的 ExpressRoute 和 QoS"
ms.author: tonysmit
author: tonysmit
manager: serdars
ms.date: 12/15/2017
ms.topic: article
ms.assetid: 20c654da-30ee-4e4f-a764-8b7d8844431d
ms.tgt.pltfrm: cloud
ms.service: skype-for-business-online
ms.collection: Adm_Skype4B_Online
ms.audience: Admin
ms.appliesto: Skype for Business, Microsoft Teams
localization_priority: Normal
ROBOTS: None
f1keywords: None
ms.custom: Setup
description: 'Learn about using Azure ExpressRoute to have a network with bandwidth requirements and Quality of Service capability for a business class user experience. '
ms.openlocfilehash: 7073840031013d41013762b190ccdc568840cceb
ms.sourcegitcommit: 61127a5723fe58545b0b19edb2e2d4260965eb4a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/19/2017
---
# <a name="expressroute-and-qos-in-skype-for-business-online"></a>Skype for Business Online 中的 ExpressRoute 和 QoS

使用适用于 Office 365 和 Skype for Business Online 的 Azure ExpressRoute 通过专用网络连接连接到 Office 365。 适用于 Skype for Business 应用的专用连接将为你提供可靠且可预测的性能，并且在公用 Internet 上也可保持隐私。 现在，你可以购买更出色的 Office 365 和 Skype for Business Online 网络连接，该连接增加了可预测性、企业级可靠性并附带运行时间 SLA。
  
> [!NOTE]
> 带宽计算器有新版本： [Skype 业务，带宽计算器](https://go.microsoft.com/fwlink/?LinkId=715766)。 但是，本文档中的说明进行操作，使用 Lync 2010 和 2013年带宽计算器。 
  
## <a name="skype-for-business-online-and-expressroute"></a>Skype for Business Online 和 ExpressRoute

与 Microsoft 的 ExpressRoute 合作伙伴进行协作，你可以通过专用连接来连接云中的多种 Office 365 应用程序（包括 Skype for Business Online）。 但是，Skype for Business 的实时语音和视频通信功能需要专门配置为支持这些 Office 365 实时工作负载的网络服务。 这包括具有足够带宽承载所需的流量并且能够支持服务质量 (QoS) 来为用户提供企业级体验的网络。
  
此文档旨在帮助你、管理员和网络设计师了解支持实时通信所面临的特殊挑战、Microsoft 提供用于帮助你设计能够支持这些要求的网络的工具，并使用案例研究指导你完成设计过程。 
  
本文档的第一部分将引导你完成一个案例研究，帮助你进行网络设计，你可以使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkId=690282)估计大型、多网站 Skype for Business ExpressRoute 部署的网络要求。 本文档的第二部分介绍服务质量 (QoS) 的基本概念、有关支持 Skype for Business 实时通信的特定技术详细信息的深入剖析，以及需要的特定类型的网络服务。
  
下面的所有信息将为你提供 QoS 和 ExpressRoute 的技术详细信息和理解、你将面临的特殊挑战的理解，并介绍你在 Skype for Business 网络上成功部署 ExpressRoute 所需的工具和技术的实用知识。 
  
## <a name="getting-started"></a>入门

当你为 ExpressRoute for Skype for Business 做好准备时，最好查看不同的 ExpressRoute 连接模型以及合作伙伴和位置的各种选择，并了解在你的企业内如何购买和设置 ExpressRoute。 以下是一些帮助你入门的资源： 
  
- [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)
    
- [ExpressRoute 定价](https://go.microsoft.com/fwlink/?LinkId=690284)
    
- [ExpressRoute 文档](https://go.microsoft.com/fwlink/?LinkId=690285)
    
## <a name="part-1-case-study---expressroute-for-dewey-law-llc"></a>第 1 部分：案例研究 - 面向 Dewey Law, LLC. 的 ExpressRoute

本 Dewey Law, LLC. 案例研究 介绍如何设置网络、订购网络访问服务并确定支持 ExpressRoute for Skype for Business Online 的带宽要求。
  
 **背景** Dewy Law LLC. 是国内一家大型的律师事务所，有 790 位律师，共有 5,580 名员工分布在 78 个地点。 该公司总部位于纽约，在芝加哥、旧金山和达拉斯有三个区域办事处，在国内很多区域还有 24 个大型和 50 个小型分支机构。 该公司处理大型复杂诉讼，工作通常涉及两个或更多办事处。 采用此网络设计可承载办事处之间相当大的网络流量。
  
Dewy Law LLC. 是一家相对年轻的公司，律师和其他职员非常熟悉技术，并且在很大程度上依赖它来处理日常工作。 
  
 **按位置和职位列出用户分布情况**
  
||**总部（纽约）**|**区域 办事处 (3)**|**大型 分支机构 (24)**|**小型 分支机构 (50)**|
|:-----|:-----|:-----|:-----|:-----|
|高级管理人员  <br/> |20  <br/> |10  <br/> |1  <br/> |1  <br/> |
|合作伙伴  <br/> |150  <br/> |50  <br/> |10  <br/> |5  <br/> |
|律师  <br/> |300  <br/> |100  <br/> |20  <br/> |10  <br/> |
|律师助理  <br/> |400  <br/> |125  <br/> |30  <br/> |15  <br/> |
|行政主管  <br/> |100  <br/> |35  <br/> |6  <br/> |3  <br/> |
|IT 和总务  <br/> |100  <br/> |25  <br/> |3  <br/> |2  <br/> |
|每个站点总计  <br/> |1,070  <br/> |345  <br/> |70  <br/> |36  <br/> |
|每个站点类别总计  <br/> |1,070  <br/> |1,035  <br/> |1,680  <br/> |1,800  <br/> |
   
### <a name="setting-up-the-network"></a>设置网络

为了为 Dewey Law LLC. 提供一致、高质量的实时服务，必须满足许多基本要求：
  
- 他们希望在出现电源故障时提供语音服务，因此其网络分布交换机和路由器必须通过以太网 (PoE) IEEE 802.3af 或 802.3at 供电。
    
- 网络交换机和路由器还必须使用不间断电源 (UPS)，这样就可以在发生电源故障期间继续运转。
    
    他们 LAN 办公室，具有 Wi-fi 连接，因此我们极力建议他们使用认证的 Skype 业务 Wi-Fi 基础架构从[Skype 的业务解决方案](https://go.microsoft.com/fwlink/?LinkId=690281)的合作伙伴。
    
    > [!TIP]
    >  [!提示] 建议使用 802.11n 和 802.11ac 无线接入点。
  
- 最重要的是，所有办事处中的所有 LAN 网络都必须设置为提供服务质量 (QoS)。 这包括电脑、笔记本电脑和任何网络硬件，如交换机和路由器。
    
在了解为 Dewey Law LLC. 提供企业级语音服务涵盖的基础知识之后，我们建议从将连接到 Azure ExpressRoute 服务的网络服务合作伙伴使用多协议标签交换 (MPLS) IP 服务。 MPLS 提供的 IP 服务可在发生延迟、抖动和数据包丢失情形时保证性能。 但是，如果 MPLS 不可用，也可以使用连接到我们的其中一个 ExpressRoute 数据交换合作伙伴的以太网。
  
MPLS 提供商提供许多服务类别级别，但是每个服务类别都使用不同的术语进行标识。 你必须与你的提供商紧密合作，以确保他们理解你在 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)中输入的数据和可用选项，并被推荐不同的 Office 365 实时工作负载应用。
  
可以通过两种方法将 Skype for Business 应用中的数据映射到适当的 MPLS 服务类别：
  
- 使用 DiffServ 控制点 (DSCP) 标记流量的终结点
    
- 基于网络访问控制列表 (ACL)
    
若要实施终结点标记，你必须将 Dewey Law LLC 所有加入域的 Windows 计算机配置为 使用适当的 DiffServ 控制点 (DSCP) 标记来标记每个数据包，然后在所有办事处站点的所有网络交换机和路由器上实施 QoS，以确保 QoS 标记得到维护且不被删除。 网络数据包上的 DSCP 标记告知服务提供商如何区分网络数据包的优先次序。 **第 2 部分的 QoS 部分提供了有关 DSCP 的更多信息。**
  
对于网络基于 ACL 的指派，DSCP 优先级标记在上游路由器实现和基于 UDP 的源端口。 2.6.1.1 的[网络规划、 监视和使用 Lync 服务器进行故障排除](https://go.microsoft.com/fwlink/?LinkId=690286)一节中列出的每个应用程序建议的端口范围。 请务必与蛛丝缠绕法律 LLC 总体 QoS 实现和设计协调这，请注意不同的 QoS 策略和潜在的数据包标记不匹配。
  
每个 ExpressRoute 网络服务提供商都有适合实时语音和视频的服务类别 (QoS)。 此 COS 对于语音称为"加速转发"(EF)，对视频称为"确保转发"(AF)。 你必须非常小心地确定面向语音 EF 流量购买的带宽量。 原因是当你发送的语音流量超过了为服务类别设置的值时，语音服务类别将非常严格。
  
> [!TIP]
>  [!提示] 超出服务提供商的承诺在语音服务类别上发送的任何流量将立即被丢弃，这将直接影响语音质量。
  
当查看 Dewey Law LLC 的总体设计时， 一定要准确地确定在网络上支持语音流量所需的网络带宽量，并使用语音的 DSCP 设置（如 DSCP EF 46）标记每个语音数据包（并且仅语音数据包），这极其重要。
  
在企业网络、 终结点或路由器中实现 QoS 必须标记具有相应的 3 层优先级标记 (即 DSCP) 每个数据包。 沿着整个网络路径，每个交换机和路由器必须具有 QoS 选项处于打开状态。 QoS 的语音或视频数据包传递到该交换机或路由器的标记可能会出现即使只有一个网络交换机或路由器没有开启的 QoS，去除。 这有效地将 QoS 禁用所有下游的交换机和路由器，这将降低出现 ExpressRoute 的值。
  
这也要求在每个点上定义第 3 层和第 2 层 QoS 优先级的关联。 第 2 层优先级机制在 IEEE 802.1p（有线网络）和 802.11e/WMM（Wi-Fi 网络）中定义。 更重要的是，面向网络服务提供商的 MPLS 网络的网络路由器必须维护所有出站数据包上的 DSCP 设置，以便它们将保持合适的 MPLS 服务类别。 
  
> [!TIP]
>  QoS 设置有关的特定详细信息，请参阅一节 2.6[网络规划、 监视和使用 Lync 服务器进行故障排除]( https://go.microsoft.com/fwlink/?LinkId=760669)。 此外可以为多个网络规划要求查看[规划业务 2015年的 Skype 的网络需求](https://go.microsoft.com/fwlink/?LinkId=690287)。
  
### <a name="ordering-network-access-services"></a>订购网络访问服务

在准备好 QoS 网络必备组件和机制来支持 ExpressRoute 之后，下一步是下订单购买 ExpressRoute 网络访问服务。 当从 Microsoft 网络服务提供商合作伙伴为 Dewey Law LLC 订购 ExpressRoute 访问服务时，你需要提供以下两项：
  
- 将每个站点连接到 ExpressRoute 和 Office 365 所需的总带宽量。
    
- 支持在 Dewey Law LLC. 使用的 Skype for Business 应用所需的每个服务类别所需的总带宽量。 服务类别带宽要求受各种 Skype for Business 应用（如语音、视频、即时消息、状态和屏幕共享）的预期流量影响。
    
### <a name="determining-bandwidth-requirements-for-skype-for-business-applications"></a>确定 Skype for Business 应用的带宽要求

对于 Dewey Law LLC.，在确定所需的总带宽量之后，你现在需要知道如何在各种服务类别之间划分总带宽量。 例如，每种 Skype for Business 应用的带宽量。
  
若要确定每个 Dewey Law LLC. 站点 的这些要求，你将使用 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)。 此计算器是一个基于 Excel 的工具，允许你指定各种 Skype for Business 应用的预期使用，包括语音、视频、会议和屏幕共享。 计算器将自动生成带宽估计值和其网络上的每个站点的 CoS 要求。 当你下载 Lync 2010 和 2013 带宽计算器时，还将下载一份用户指南，它将为你提供有关使用该工具的详细信息。 
  
为帮助你使用电子表格，电子表格中的各个单元格均用彩色标记：
  
- **绿色** 这些是常规的数据输入区域。
    
- **黄色** 这些是高级数据输入区域。 你可以更改这些设置，但务必小心谨慎。
    
- **红色** 这些是只读区域，输入值被锁定，不可更改。
    
- **灰色** 这些是只显示区域。 它们是来自常规输入区域的结果或数据。
    
Dewey Law LLC. 的设计过程 首先是根据用户的特征设定不同的"角色"。对于你定义的每种角色，你可以指定各种 Skype for Business 应用的预期使用（"无"、"低"、"中"、"高"或三个已定义的"自定义"设置之一）。 可在"角色"工作表中找到这些选项。 提供了每个选项的具体用法（"低"、"中"或"高"），但可以更改每个选项的默认值。 通过确定位于每个站点的每种角色的用户数量，计算器可以计算每个位置所需的总带宽量。
  
你也可以指定所使用的音频和视频编解码器、是否使用前向纠错以及将影响带宽要求的其他系统参数。 你可以使用 Lync 2010 和 2013 带宽计算器中的默认设置，也可以选择不同的编解码器和其他系统参数。 对于 Dewey Law LLC. 的站点设计，可以使用默认设置。 但是，要更改任何默认设置，可以使用下拉菜单中的所有可用选项。 "编解码器"工作表中包含用于每个选项的带宽。 当你更改任何设置时，每个站点的带宽和服务类别 (CoS) 混合更改会更新。 借助此功能，你可以测试不同的潜在配置并查看所做的更改对带宽要求的影响。
  
我们已为 Dewey Law LLC. 定义了三种角色："高级管理人员/合作伙伴"、"律师/律师助理"和"IT 管理员"。 下表介绍了我们是如何为每种角色的各种 Skype for Business 应用设置使用配置文件的。
  
 **角色和使用配置文件（"角色"工作表 - 列 A 到 P）**
  
|**角色**|**IM/状态**|**P2P 音频**|**P2P 视频**|**会议音频**|**会议视频**|**桌面共享**|**音频会议**|**Lync 2010 RTV 类型**|**远程用户**|**Lync 2013 立体声音频**|**Lync 2013 视频质量**|**Lync 2013 P2P 视频窗口的用户行为**|**Lync 2013 多视图使用**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|高级管理人员/ 合作伙伴  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |中  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |最佳  <br/> |典型  <br/> |典型  <br/> |
|律师/ 律师助理  <br/> |高  <br/> |中  <br/> |低  <br/> |中  <br/> |高  <br/> |高  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
|IT 管理员  <br/> |高  <br/> |中  <br/> |无  <br/> |低  <br/> |无  <br/> |无  <br/> |中  <br/> |CIF  <br/> |0%  <br/> |0%  <br/> |中  <br/> |典型  <br/> |典型  <br/> |
   
你需要在 **按位置和职位列出用户分布情况** Lync 2010 和 2013 带宽计算器的"站点"工作表中的上述表中输入信息。 当区域办事处的用户数相同时，它们被定义为一个"站点"并指定存在三个实例。 此行为也适用于大型和小型分支机构，站点中分别有 24 个和 50 个用户。
  
在指定每种角色的设置后，你需要在"站点"工作表中输入每个站点每种角色的用户数。 所有站点的用户总数会自动更新。 由于在 Office 365 位置没有用户，应在工作表的"分支机构"行中输入所有用户。 然后，Lync 2010 和 2013 带宽计算器会填充"尽力而为类别"、"数据流量类别"和"实时流量类别"列。 这显示在下表的数据中。
  
> [!TIP]
>  [!提示] 完整的电子表格还包括每种应用的最大并发会话数，但我们为节省空间删除了这些列。
  
 **站点的角色 -（"站点"工作表 - 列 A、D、I 和 AI 至 AX）**
  
|**站点名称**|**站点中的用户总数**|**相似的站点总数**|**用户配置文件 1**|**配置文件 1 的用户数**|**用户配置文件 2**|**配置文件 2 的用户数**|**用户配置文件 3**|**配置文件 3 的用户数**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |1  <br/> |执行经理/合作伙伴  <br/> |170  <br/> |律师/律师助理  <br/> |700  <br/> |IT 管理员  <br/> |200  <br/> |
|地区办事处  <br/> |345  <br/> |3  <br/> |执行经理/合作伙伴  <br/> |60  <br/> |律师/律师助理  <br/> |225  <br/> |IT 管理员  <br/> |60  <br/> |
|大型分支机构  <br/> |70  <br/> |24  <br/> |执行经理/合作伙伴  <br/> |11  <br/> |律师/律师助理  <br/> |50  <br/> |IT 管理员  <br/> |9  <br/> |
|小型分支机构  <br/> |36  <br/> |50  <br/> |执行经理/合作伙伴  <br/> |6  <br/> |律师/律师助理  <br/> |25  <br/> |IT 管理员  <br/> |1  <br/> |
   
 **站点中每种应用所需的带宽（以 Kbps 为单位） （"站点"工作表 - 列 A 和 BQ 至 LF）**
  
|**站点**|**SIP/IM 带宽峰值**|**站点间对等音频带宽峰值**|**站点间对等视频带宽峰值**|**音频会议的峰值带宽**|**视频会议的峰值带宽**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |1070  <br/> |525.30  <br/> |560.00  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |
|地区办事处  <br/> |345  <br/> |185.40  <br/> |560.00  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |
|大型分支机构  <br/> |70  <br/> |92.70  <br/> |560.00  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |
|小型分支机构  <br/> |36  <br/> |119.40  <br/> |560.00  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |
   
电子表格中最重要的列可能是描述 QoS 类别的 WAN 带宽的那些列。如下表所示。此数据总结了你在每个站点订购访问连接时需要向网络服务提供商提供的信息。当计算总的带宽时，请记得将每种类型的分支站点的带宽乘以相同类型的站点数。要与你的 ExpressRoute 网络服务合作伙伴进行连接，你可以参阅 [Azure ExpressRoute]( https://go.microsoft.com/fwlink/?LinkId=690283)。
  
请务必不要超过语音或"加速转发"(EF) 服务类别中的带宽。 一组随机的数据包将被丢弃，因此不是降低单个呼叫或呼叫组的质量，而是正在进行的所有呼叫都会受到影响。 请注意，当添加非语音流量时，仅标记有 EF DSCP（如 DSCP = 46）的语音或语音队列可能会溢出。
  
> [!TIP]
>  [!提示] 再提一下，EF 服务类别可提供最佳性能保证，如果你超过定义的带宽，任何其他数据包将立即被丢弃。
  
 **每个站点通过 QoS 通信类的 （站点工作表中的列 A 和列先生通过 ML） 的聚合带宽**
  
|**站点名称**|**尽力而为类别 (DSCP 0)**|**数据流量类别（DSCP 自定义）**|**实时流量类别 （DSCP 34、AF41）**|**优先级流量类别 （DSCP 46、EF）**|
|:-----|:-----|:-----|:-----|:-----|
|总部  <br/> |0.00  <br/> |5764.80  <br/> |3200.00  <br/> |3953.10  <br/> |
|地区办事处  <br/> |0.00  <br/> |2033.60  <br/> |1880.00  <br/> |1336.50  <br/> |
|大型分支机构  <br/> |0.00  <br/> |486.40  <br/> |1160.00  <br/> |411.00  <br/> |
|小型分支机构  <br/> |0.00  <br/> |438.40  <br/> |1160.00  <br/> |319.50  <br/> |
   
### <a name="putting-your-plan-into-action"></a>将计划付诸实施

我们可以使用 **每个站点每个应用程序** 表中的带宽估计值计算将遍历 WAN 的总带宽量以及将遍历 ExpressRoute 的带宽量。遍历 ExpressRoute 的流量部分不包括站点间的对等带宽。

 
|**站点**|**SIP/IM 带宽峰值**|**音频会议的峰值带宽**|**视频会议的峰值带宽**|**WAN 共享带宽峰值**|**PSTN 呼叫的 WAN 带宽峰值**|**合计 ExpressRoute<br/>每个网站类流量<br/>(即总<br/>时间的网站)**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|**总部** <br/> |1,070  <br/> |739.50  <br/> |2640.00  <br/> |4224.00  <br/> |2688.30  <br/> |11361.80  <br/> |
|**地区办事处** <br/> |345  <br/> |255.00  <br/> |1320.00  <br/> |1536.00  <br/> |896.10  <br/> |8704.20  <br/> |
|**大型分支机构** <br/> |70  <br/> |102.00  <br/> |600.00  <br/> |384.00  <br/> |216.30  <br/> |32935.20  <br/> |
|**小型分支机构** <br/> |36  <br/> |76.50  <br/> |600.00  <br/> |384.00  <br/> |123.60  <br/> |61005.00  <br/> |
   
这意味着将遍历 ExpressRoute 的 Skype for Business Online 流量大约为 114 Mbps，因此，Dewey 至少需要 200 Mbps 订阅用于 ExpressRoute。可以在不同的 ExpressRoute 对等位置购买多个 ExpressRoute 线路。如果 Dewey 的站点位于不同的地理位置或者要在与 ExpressRoute 线路的连接失败时提供恢复能力，则可以推荐这样做。如果你在多个 Azure 区域购买了 ExpressRoute 线路，则需要 ExpressRoute 高级加载项才能通过 ExpressRoute 实现全球连通。
  
在确定所需的带宽总量和服务类别 (CoS) 带宽量之后，你可以向所选网络服务提供商下订单。请不要忘记包括用于其他应用程序和服务的流量的估计值。我们针对其他 Office 365 服务提供了网络规划指南，包括适用于 Exchange 和 OneDrive 的带宽计算器。由于网站内流量需要重新添加，网络服务提供商的带宽订阅将更高。Lync 2010 和 2013 带宽计算器提供的只是预期流量的估计值，因此建议执行压力测试来确认网络是否能够支持该流量。 
  
> [!TIP]
> [!提示] 强烈建议在执行网络预评估时对网络执行压力测试。 
  
压力测试涉及构建和配置基础结构，然后使用模拟的预期流量运行该基础结构，同时监视性能。 你的流量估计值在某些区域中可能不准确，但至少你可以确保它能够支持 Lync 2010 和 2013 带宽计算器预测的流量。 建议你运行压力测试至少几天，但是运行更长时间可帮助你优化数字。 然而，必须根据你所支付的网络服务成本来权衡是否延长压力测试时间段，这不会承载真正的用户网络流量。 作为 Microsoft 的 IT 专业人员工具计划的一部分，Microsoft 已认证了许多供应商来提供网络管理和操作工具，包括网络预评估压力工具。 Skype for Business 还提供了系统集成商 (SI)，可以获取经认证的 IT 专业人员工具并可以为你执行网络评估。 你可以在 [Skype for Business 解决方案：IT 专业人员工具](https://go.microsoft.com/fwlink/?LinkID=690307)上查看更多信息。
  
压力测试可以在某种程度上保证网络能够支持所需的流量，但实际上，Lync 2010 和 2013 带宽计算器数据可以由于许多原因而失效。 你还应考虑通过在部署网络之后执行持续的网络评估来继续监视你的站点网络，以确保有足够的带宽以及 QoS 机制正常工作。 应继续监视网络性能，因为越来越多的真实用户上线，这一点很重要。
  
## <a name="part-2-expressroute-skype-for-business-qos"></a>第 2 部分: ExpressRoute Skype for Business QoS

Microsoft 的 ExpressRoute 服务提供专用的 Azure 云连接，但 Office 365 实时工作负载的通信服务需要具有足够带宽的网络服务来承载流量，并且能够支持服务质量 (QoS)，以便提供企业级用户体验。必须端对端（电脑、网络交换机和路由器到云）配置支持 QoS 的连接，因为路径中无法支持 QoS 的任何部分可能会降低整个呼叫的质量。
  
本部分旨在帮助你了解当支持 IP 网络中的实时流量与使用 Microsoft 的 ExpressRoute Exchange 提供商或网络服务提供商合作伙伴配置和支持成功的 Office 365 实时工作负载 ExpressRoute 部署时所面临的挑战。
  
QoS 在网络中专有地通过 ExpressRoute 网络线路接受，并用在 Microsoft 网络中提供 Skype for Business 流量。 当前，Microsoft 的部分出站连接缺少用于 Skype for Business 的 DSCP 值。 在出站流量完全标有 DSCP 值前，你应按照本文 **使用网络访问控制列表 (ACL) 实施 QoS** 部分中讲述的指南在网络边界向流量添加 QoS 标记。
  
### <a name="the-real-time-problem"></a>实时问题

提供企业质量的语音和视频服务对 IP 网络有一些特殊需求。 实时流量使用通过用户数据报协议 (UDP) 承载的实时传输协议 (RTP)。 与传输控制协议 (TCP) 不同，TCP 对每条消息进行编号并测试这些消息是否存在错误，它包括可检测并重新传输丢失或出错的消息的其他机制，而 UDP 不提供此类型的可靠性。 如果消息因错误而损坏或者由于缓冲区溢出而丢失，则它们将会丢失。 已选择将 UDP 与 TCP 配合使用，因为实时流量的性质是即使已重新发送丢失的消息，但是它们可能到达得太迟，对语音消息流没有任何积极影响。
  
在了解丢失的语音数据包的影响之后，设计者采用了两种方法来改进 IP 上的语音和视频的性能：
  
- 在数据包丢失时，让语音编码/解码的复原能力更强。 这可以通过使用前向纠错 (FEC) 纠正遇到的错误的百分比或者通过设计语音解码系统来实现，可在 Office 365 实时传输中找到 FEC 功能，而语音解码系统会尝试减少丢失的数据包的影响，这是 Microsoft 编解码器的特征。 
    
- 请使用具备以下特点的传输服务：使用服务质量机制来在发生延迟、数据包丢失和抖动以及数据包之间的延迟发生变化时保证网络的性能。
    
复原能力强的语音编码仅解决数据包丢失问题，因此用于承载实时语音和视频的网络应有相应的机制最大限度减少延迟和抖动，这一点非常重要。 即使使用复原能力强的编码，如果丢失的数据包太多，接收站也没有足够的信息来重建可识别版本的语音信号。 会导致语音质量显著降级的丢失数据包百分比因所使用的语音编码技术而异。 然而，在所有情况下，丢失连续的数据包字符串是一个很大的问题。
  
最大程度地减少延迟十分重要，因为过多延迟会影响对话流并为发言人带来一些困扰。 最佳做法告诉我们，语音的端到端延迟（我们称之为"从嘴到耳"延迟）必须低于 150 毫秒。 单向而不是"往返"延迟。 当然，考虑传播延迟或者信号通过网络实际传输所花的时间，较长的传输链路上的延迟将会增加，例如跨海链路。
  
当延迟高于 150 毫秒时。 单向，它对发言人有奇效。 在心理上，发言人会误认为接收方听不到发言并且重复他们最后所说的话。 这将与来自远端的延迟响应相抵触。 如果你曾通过卫星信道讲话，你将认识到此效果。 通过卫星信道，单向延迟大约为 250 毫秒，这远远超出了允许的延迟。
  
 **对于企业级语音推荐的网络参数**
  
|**参数**|**推荐的值**|
|:-----|:-----|
|到达间隔数据包抖动（平均值）  <br/> |≤ 5 毫秒  <br/> |
|到达间隔数据包抖动（最大值）  <br/> |≤ 40 毫秒  <br/> |
|丢包率（平均值）  <br/> |接近 0%  <br/> |
|单向网络延迟  <br/> |≤ 100 毫秒（应包括延迟与地理距离的检查）  <br/> |
   
### <a name="expressroute-as-part-of-a-business-grade-voice-network"></a>ExpressRoute 作为企业级语音网络的一部分

ExpressRoute 采用 3 种连接方法通过网络服务提供商 (NSP) 或 Exchange 提供商 (EXP) 提供专用连接： 
  
- 云 Exchange 并置
    
- 点对点以太网连接
    
- 任意点至任意点 (IPVPN) 连接
    
这样做可提供高可用性的优点（99.9% 正常运行时间 SLA），路由安全可靠（无 Internet 传输），不受 Internet 流量中各种变化因素的影响，并且采用服务质量标记区分流量优先次序（下面介绍了 QoS）。ExpressRoute 与计划周详的 WAN 相结合可以为你提供企业级语音网络。
  
你可以使用 ExpressRoute 从连接到该线路的办公室或数据中心传输数据（如果使用的是混合拓扑）。非现场用户（例如，家庭办公室或出差用户等）的数据并不会利用 ExpressRoute 线路，除非用户使用 VPN 连接，此时这些数据不需要包括在调整 ExpressRoute 线路规模的带宽估计值中。如果你是跨国客户，那么你可能会在每个区域购买 ExpressRoute 线路，并使用 BGP 社区标记来通知路由规则，以便流量定向到首选 ExpressRoute 线路（通常是每个站点最接近的线路），而其他线路负责提供冗余，以防发生中断时影响单个线路。 
  
### <a name="if-expressroute-isnt-an-option"></a>如果 ExpressRoute 不是一个好选择

由于成本问题、无法满足 ExpressRoute 先决条件或者你当前 NSP 的局限性，将所有站点都连接到 ExpressRoute 可能不太可行。对于无法使用 ExpressRoute 的用户，仍然建议按照下面的指南在你的网络内标记 QoS，并计划与你的 NSP 签订合同来确保提供足够的带宽并支持基于 QoS 区分流量优先次序。
  
此外，如果你在多个区域设立了办事处，但并非所有区域都有 ExpressRoute 线路，那么当你为与卫星办事处之间传输的流量配置路由时，应使用区域 BGP 社区标记，以避免不必要的长途传输。例如，倘若某家公司在美国托管 Skype for Business Online 组织，但是在欧洲设立了分支机构，并且该公司只在硅谷有一个 ExpressRoute 线路。大多数 Skype for Business Online 流量将路由到托管该组织的数据中心（例如，与公司内其他用户的电话会议），大多数流量可能会优先选用 ExpressRoute 线路。但是，如果欧洲的用户想要加入由其组织位于欧洲的另一家公司主持的电话会议，则该呼叫中媒体的目标将是第二家公司所在的欧洲数据中心。相比通过 Internet 传输流量，通过硅谷的 ExpressRoute 线路路由流量不太直接。在这种情况下，你可能需要在你的网络内（例如，欧洲办事处中）配置路由器，以便在设立路由规则并通过 Internet 而不是硅谷的 Silicon ExpressRoute 线路路由具有欧洲区域标记的流量时检查社区标记。
  
### <a name="basic-concepts-of-quality-of-service-qosclass-of-service-cos"></a>服务质量 (QoS)/服务类别 (CoS) 的基本概念

在 IP 中，服务质量 (QoS) 描述用于为某些数据包提供优先处理的任何机制。 按照国际电信联盟 (ITU) 定义，QoS 涵盖连接的所有质量方面，包括延迟、丢失、信噪比、串扰、回显、中断、频率响应、响度级等。 在数据包网络中，我们称之为 QoS 的内容在术语上更准确地应叫做服务类别 (CoS)，它侧重于改进延迟、抖动和数据包丢失的性能，但是我们将继续使用术语 QoS，因为它更常用。
  
在 IP 网络呼叫中为两个主要组件提供 QoS：
  
- 每个链路上实时流量的定义的带宽量保留；如果在任何时候实时流量不需要该带宽，可以将其用于其他流量。 通用指南是应为语音流量分配不超过 30% 的任何链路容量。
    
- 在标头中使用优先级指示器标记数据包，以指明应为路径中的交换机和路由器分配数据包的优先级。
    
当在交换机或路由器上收到数据包时，它将被移动到下一个分支或跃点的输出队列。 不同优先级级别有不同的输出队列。 交换机或路由器使用一种算法来让高优先级队列的执行频率高于低优先级队列。
  
挑战在于第 2 层（即以太网或 Wi-Fi 层）和第 3 层（即 IP 层）实施了不同的 QoS 技术。这些不同的 QoS 实施可能必须在网络中的每个交换机和路由器中以及你的网络和网络服务提供商的网络之间的接口中配置。
  
可以通过两种方法将各种 Skype for Business 应用中的数据映射到适当的服务类别：
  
- 使用差分服务控制点 (DSCP) 标记流量终结点 
    
- 基于网络访问控制列表 (ACL)
    
### <a name="end-point-traffic-marking--differentiated-services-control-point-dscp"></a>终结点流量标记 - 差分服务控制点 (DSCP)

差分服务 (DSCP) 称为一种"粗粒度"机制，用于分类和管理网络流量，并在 IP 网络中提供 QoS。 路由器和实施第 3 层功能的其他设备使用 DiffServ 控制点 (DSCP) 来定义数据包的优先级。 QoS 是通过在 IP 标头中的差分服务字段（以前称为"服务类型"字段）中插入 6 位 DSCP 值来实施的；6 位允许 64 种不同的优先级级别。 优先级级别通常如下所示定义。
  
 **推荐的 DSCP 设置**
  
|**流量类别**|**处理（DSCP 标记）**|**Skype for Business 工作负载**|
|:-----|:-----|:-----|
|**语音** <br/> |EF (46)  <br/> |Skype for Business 和 Lync 语音  <br/> |
|**交互式** <br/> |AF41 (34)  <br/> |视频  <br/> |
||AF21 (18)  <br/> |应用程序共享  <br/> |
|**默认** <br/> |AF11 (10)  <br/> |文件传输  <br/> |
||CS0 (0)  <br/> |其他值  <br/> |
   
 **IP 版本 4 头**
  
![IPv4 标头](../images/c8a6a714-2784-4328-8297-2e62706f302d.png)
  
### <a name="layer-2-qos-ieee-8021pwi-fi-multi-media-ieee-80211e"></a>第 2 层 QoS：IEEE 802.1p/Wi-Fi 多媒体 (IEEE 802.11e)

DSCP 是用于在第 3 层实施 QoS 的标准机制，存在用于有线（如以太网）和无线（如 Wi-Fi 网络）的不同的第 2 层 QoS 机制。 用于有线网络的 QoS 机制是在 IEEE 802.1p 标准中定义的；WLAN QoS 机制是在 IEEE 802.11e 中定义的，Wi-Fi Alliance 将其标识为"Wi-Fi 多媒体认证"（WMM 认证）。
  
IEEE 802.1p 使用一个 3 位优先级代码点 (PCP) 来确定消息的优先级；PCP 是也承载 VLAN 标识符的以太网标头中的 32 位字段的一部分。 下面包含 PCP 值的定义。
  
 **IEEE 802.1 p PCP 值**
  
|**PCP 值**|**优先级**|**首字母缩写词**|**流量类型**|
|:-----|:-----|:-----|:-----|
|7  <br/> |7  <br/> |NC  <br/> |网络控制  <br/> |
|6  <br/> |6  <br/> |IC  <br/> |网间控制  <br/> |
|5  <br/> |5  <br/> |VO  <br/> |语音  <br/> |
|4  <br/> |4  <br/> |VI  <br/> |视频  <br/> |
|3  <br/> |3  <br/> |CA  <br/> |关键应用  <br/> |
|2  <br/> |2  <br/> |EE  <br/> |卓越努力  <br/> |
|0  <br/> |1  <br/> |BE  <br/> |尽力而为  <br/> |
|1  <br/> |0  <br/> |BK  <br/> |背景  <br/> |
   
对于排序到每个优先级级别的不同优先级队列的流量，IEEE 802.1p 的实施方法与 DSCP 相同，但是 WLAN 呼叫的共享媒体性质的方法不同。 接入点和客户端将为不同的优先级级别维护单独的输出队列，在无线电信道上发出帧的方式也不同。
  
在 Wi-Fi 网络中，与入口点相关联的所有客户端都共用单一的半双工信道（即一次仅一个客户端站或接入点可以发送）。 为最大程度降低无线电信道上的潜在冲突，在发送帧之前，站会等待信道处于空闲状态持续定义的一段时间（称为"帧间距"），如果在站开始发送时信道正忙，它会退避随机的时间段。 在发送帧之后，如果发送方未收到来自接收方的确认消息，它会假定发生冲突或其他故障，并后退一个随机间隔，然后再尝试访问无线电信道以重新发送。 退避间隔是随机的，旨在减少相同的两个站再次发生冲突的概率。
  
为区分对无线电信道访问的优先次序，IEEE 802.11e/WMM 针对不同的流量类别定义了不同的预传输等待时间间隔（称为仲裁帧间间隔 (AFIS)）和不同的退避范围；定义了四个优先级级别，称为"访问类别"。
  
优先级是通过为高优先级帧分配较短的 AFIS 值来指定的。 因此，如果一个站正等待发送语音帧，而另一个站正等待发送数据帧，则将始终首先发送语音帧。 从技术角度来说，语音和视频帧将被分配相同的 AFIS 值，但是视频帧的退避间隔范围更高。 因此，如果语音和视频帧首次尝试时发生冲突，则将始终更快地重新传输语音帧。 IEEE 802.1p 和 IEEE 802.11e 之间的相关性如下所示：
  
 **IEEE 802.11e / Wi-fi 多媒体 (WMM) 到 802.1 P 映射**
  
|**WMM 访问类别**|**WMM 说明**|**802.1P PCP 值**|**802.1P 标志**|
|:-----|:-----|:-----|:-----|
|1 (AC_VO)  <br/> |语音  <br/> |7 (111)  <br/> |NC  <br/> |
|6 (110)  <br/> |VO  <br/> |
|2 (AC_VI)  <br/> |视频  <br/> |5 (101)  <br/> |VI  <br/> |
|4 (100)  <br/> |CL  <br/> |
|3 (AC_BE)  <br/> |尽力而为 数据  <br/> |3 (011)  <br/> |EE  <br/> |
|0 (000)  <br/> |BE  <br/> |
|4 (AC_BK)  <br/> |后台 数据  <br/> |1 (001)  <br/> |BK  <br/> |
|2 (010)  <br/> |---  <br/> |
   
推荐的第 3 层到第 2 层优先级关联如下所示：
  
 **推荐的第 3 层到第 2 层优先级关联**
  
||**第 3 层标记**|**第 2 层（PCP 值）**|**Wi-Fi（访问类别）**|
|:-----|:-----|:-----|:-----|
|网络控制  <br/> |逐跳行为 (PHB) - 类别选择器 (CS) 6  <br/> |6  <br/> |1 (AC_VO)  <br/> |
|DSCP 值 - 48  <br/> |
|语音  <br/> |逐跳行为 (PHB) - 加速转发 (EF)  <br/> |5  <br/> |1 (AC_VO)  <br/> |
|DSCP 值 - 46  <br/> |
|视频会议  <br/> |逐跳行为 (PHB) - 确保转发 (AF) 41  <br/> |4  <br/> |2 (AC_VI)  <br/> |
|DSCP 值 - 34  <br/> |
|呼叫信号  <br/> |逐跳行为 (PHB) - 类别选择器 (CS) 3  <br/> |3  <br/> |2 (AC_VI)  <br/> |
|DSCP 值 - 24  <br/> |
|低延迟数据  <br/> |逐跳行为 (PHB) - 确保转发 (AF) 21  <br/> |2  <br/> |3 (AC_BE)  <br/> |
|DSCP 值 - 18  <br/> |
|高吞吐量数据  <br/> |逐跳行为 (PHB) - 确保转发 (AF) 11  <br/> |1  <br/> |3 (AC_BE)  <br/> |
|DSCP 值 - 10  <br/> |
|尽力而为  <br/> |逐跳行为 (PHB) - 0  <br/> |0  <br/> |4 (AC_BK)  <br/> |
|DSCP 值 - 0  <br/> |
   
请务必注意在 IEEE 802.1 p 和 WMM 优先编码不匹配。 802.1 p PCP 的声音值是 5，但是，在标准等效对应于 WMM，PCP 5 被翻译为访问类别 2，视频 (AC_VI) WMM 访问类别。 如果可能应重写该映射，以便 PCP 5 相当于访问类别 1，或只是避免相同的 Wi-Fi 网络上使用语音和视频，直到 Wi-fi 联盟解决这个问题。 在 Wi-fi 上的其他信息，请参阅[Wi-Fi 的目录项]( https://go.microsoft.com/fwlink/?LinkId=690322)。
  
### <a name="implementing-qos-using-network-access-control-list-acl"></a>使用网络访问控制列表 (ACL) 实施 QoS

在 ExpressRoute 配置中实施 QoS 的替代方法是使用网络访问控制列表 (ACL)。 在这种方法中，不是让终结点在每个数据包的标头中插入合适的 DSCP 标记，而是由上游路由器基于 DSCP 源端口来完成标记。 所有交换机和路由器仍然必须配置为支持 QoS，以确保 DSCP 设置保持不变。 更重要的是，连接到服务提供商的网络的路由器必须在每个数据包的标头中保留 DSCP，因为该 DSCP 设置本质上是告诉网络服务提供商应如何处理数据包的指令。
  
[Lync Server 的网络规划、监视和故障排除](https://go.microsoft.com/fwlink/?LinkId=690286)指南的 2.6.1.1 节中列出了每种 Skype for Business 应用的建议端口范围。 这应与组织的总体 QoS 方法进行协调，你应该密切注意不同的 QoS 策略和潜在的数据包重标记不匹配。
  
虽然使用 QoS 和 MPLS 网络服务的主要原因是确保获得良好的实时语音和视频用户体验，但是这些相同功能也可以应用于数据应用。 MPLS 网络并不是同等处理所有应用，可以允许组织将一些数据应用设定为优先于其他数据应用。 使用 MPLS，可以将实时应用（如信用卡交易或屏幕共享）设定为优先于低时效要求的流量（如电子邮件）。
  
### <a name="understanding-the-types-of-ip-network-services--basic-ip-and-mpls"></a>了解 IP 网络服务的类型 - 基本 IP 和 MPLS

原始 IP 数据包转发按照"尽力而为"准则运作。这意味着转发那些 IP 数据包的路由器将竭尽全力将数据包交付到其目标，但是并不绝对保证数据包到达其目的地的时间或者是否能到达目的地。 这是基本 Internet 服务（包括你的家庭 Internet 连接）目前的工作方式。 想法是，如果特定应用要求可靠，将在协议堆栈的较高级别提供它。 可靠的交付机制是传输控制协议 (TCP)。 用于实时语音和视频的用户数据报协议 (UDP) 是不可靠的（即"尽力而为"）交付机制。 
  
多协议标签交换 (MPLS) 是开发用作网络提供商提供 IP 服务的一种方式，以便在发生延迟、抖动和数据包丢失时保证性能。 为实现这些性能保证，MPLS 摆脱了传统 IP 的某种不可预测性。 首先，MPLS 不是让每个数据包查找路由器到路由器到其目标的途径（结果可能是每个数据包从源到目标采用不同的路由），而是使用固定路由（称为标签交换路径 (LSP)）路由"虚拟电路"连接上的所有数据包。 如果该路径中的其中一个链路发生故障，则使用该链路的所有 LSP 都会快速被重新路由。
  
当数据包发送到 MPLS 网络中时，网络服务提供商的边缘路由器会将一个额外标头附加到数据包，它包括用于通过合适的 LSP 转发数据包的标签。 在 MPLS 网络的另一端，标签将被边缘路由器去除。
  
除了简化转发过程之外，MPLS 的另一大优势是网络管理系统知道在网络中的每个链路上承载哪些连接。 经由控制通过网络路由流量的方式，操作员可以保证每个路径将提供的 QoS。 因此，与传统或基本 IP 的"尽力而为"性能不同，MPLS 操作员可以提供性能可预测的 IP 服务。 该 LSP 还使 MPLS 本身比传统 Internet 服务更安全。 因此，通过基本 IP 服务，我们可以期望网络将出色运作，提供质量优良的语音，并使用 FEC 等技术和复原能力更强的语音编码来提高成功几率，但通过使用 MPLS，我们完全可以确保这些目标都一一实现。
  
MPLS 提供商提供许多服务类别层次，遗憾的是，每个服务类别都使用不同的术语进行标识。 你需要与你的提供商密切协作，确保他们理解 [Lync 2010 和 2013 带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)的输出和为不同的 Office 365 实时工作负载应用推荐的选项。
  
## <a name="conclusion"></a>结论

Skype for Business 增强了进行业务通信的方式。 Skype for Business 不是让电话连接到 PBX、独立的视频会议系统、用于电子邮件的独立平台、用于音频会议的外部服务以及一些 IM 和状态工具，它可以在单个用户界面集合所有这些功能。
  
始终如一地提供业务成绩实时语音和视频服务要求是能提供 QoS 的端到端网络基础结构。 它包括局域网和广域网服务。 Microsoft 提供的工具如[Lync 2010 和 2013年带宽计算器](https://go.microsoft.com/fwlink/?LinkID=690282)估计将需要的各种服务的网络容量。 另外，有一些 IT 专业工具程序的合作伙伴[Skype 业务解决方案： IT 专业人员的工具](https://go.microsoft.com/fwlink/?LinkID=690307)提供预评估网络基础结构和支持监视、 报告和故障排除工具。 没有正确地调整大小和配置的网络基础结构，您运行的 ExpressRoute Skype 不能达到用户的期望的质量和一致性的业务部署的风险。
  
有效的业务工具必须可靠、一致地执行，并提供让用户有信心采用的用户体验。 从网络角度来看，这意味着拥有一种能够实现以上目的的网络基础结构（局域和广域、固定和移动）。 规划、设计、实施和维护基础结构并非总是轻松。 当前市面上有很多可实现该目的的硬件、工具和网络服务，然而，IT 专业人员应负责检查基础结构的设计、实施和维护是否能够确保用户获取一组让他们能够有效和高效地工作的通信和协作服务，组织可以享受到此技术必须提供的所有好处。 
  
## <a name="related-topics"></a>相关主题

[ExpressRoute 文档](https://go.microsoft.com/fwlink/?LinkId=690285)

